<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PKM Semantic Vault</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">

  <!-- Enterprise Architecture Scripts -->
  <script src="performance-monitor.js"></script>
  <script src="state-manager.js"></script>
  <script src="semantic-system.js"></script>
  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --muted: #9aa4b2;
      --accent: #7dd3fc
    }

    html,
    body {
      height: 100%
    }

    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0;
      background: linear-gradient(180deg, #071129 0%, #071b2a 100%);
      color: #e6eef6;
      overflow-x: hidden;
      /* Prevent horizontal scroll */
    }

    .wrap {
      max-width: none;
      /* Remove max-width constraint */
      margin: 0;
      /* Remove auto margins */
      padding: 16px 20px 0 20px;
      /* Reduce padding */
      background: none;
      /* Remove background to blend with body */
      border-radius: 0;
      /* Remove border radius */
      box-shadow: none;
      /* Remove shadow */
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(15, 23, 36, 0.95);
      /* Semi-transparent header background */
      padding: 12px 20px;
      margin: -16px -20px 0 -20px;
      /* Extend to edges */
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    h1 {
      margin: 0;
      font-weight: 600
    }

    .controls {
      margin-left: auto;
      display: flex;
      gap: 8px;
      align-items: center
    }

    button {
      background: var(--accent);
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      color: #012;
      cursor: pointer;
      font-weight: 600
    }

    input[type=text] {
      background: #061423;
      border: 1px solid #143046;
      padding: 8px 10px;
      border-radius: 8px;
      color: var(--muted);
      min-width: 260px
    }

    main {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
      margin-top: 20px
    }

    .panel {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), transparent);
      padding: 14px;
      border-radius: 10px;
      min-height: 120px
    }

    .list-item {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.01);
      cursor: pointer
    }

    .meta {
      color: var(--muted);
      font-size: 13px
    }

    .task-done {
      opacity: 0.6;
      text-decoration: line-through
    }

    pre,
    code {
      background: #02111a;
      padding: 6px;
      border-radius: 6px
    }

    .note-view {
      white-space: pre-wrap
    }

    /* Graph styles */
    /* Graph overlay container becomes a backdrop; inner card holds content */
    #graphContainer {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: flex-start;
      justify-content: center;
      padding: 60px 40px
    }

    #graphContainer .overlay-card {
      background: #081426;
      border: 1px solid #143046;
      border-radius: 16px;
      padding: 20px 22px;
      max-width: 1200px;
      width: 100%;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
      position: relative
    }

    .overlay-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0 0 14px
    }

    .overlay-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600
    }

    .overlay-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: flex-start;
      justify-content: center;
      padding: 60px 40px
    }

    .overlay-card {
      background: #081e2e;
      border: 1px solid #143046;
      border-radius: 16px;
      padding: 24px 26px;
      max-width: 1100px;
      width: 100%;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 12px 44px rgba(0, 0, 0, 0.55);
      position: relative
    }

    .overlay-card h3 {
      margin-top: 0
    }

    #graphCanvas {
      width: 100%;
      height: 420px;
      background: #061423;
      border: 1px solid #10283a;
      border-radius: 8px;
      cursor: grab
    }

    #graphLegend {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      display: flex;
      gap: 18px;
      flex-wrap: wrap
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%
    }

    #graphToolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px
    }

    .small-btn {
      background: #143046;
      border: 1px solid #1f3650;
      padding: 6px 10px;
      border-radius: 8px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer
    }

    .small-btn:hover {
      color: var(--accent);
      border-color: var(--accent)
    }

    #graphStatus {
      font-size: 11px;
      color: var(--muted);
      margin-left: auto
    }

    #graphSearch {
      background: #061423;
      border: 1px solid #143046;
      padding: 6px 10px;
      border-radius: 8px;
      color: var(--muted);
      min-width: 200px;
      font-size: 12px
    }

    .highlight-note {
      outline: 2px solid var(--accent)
    }

    /* Added UI enhancements */
    nav.app-nav {
      display: none;
      gap: 10px;
      margin: 18px 0 6px;
      flex-wrap: wrap
    }

    .nav-btn {
      background: #143046;
      border: 1px solid #1f3650;
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer
    }

    .nav-btn.active {
      background: var(--accent);
      color: #012;
      border-color: var(--accent)
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-top: 10px
    }

    .tab-btn {
      background: #143046;
      border: 1px solid #1f3650;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer
    }

    .tab-btn.active {
      background: var(--accent);
      color: #012;
      border-color: var(--accent)
    }

    .note-section {
      margin-top: 12px;
      line-height: 1.5;
      font-size: 14px
    }

    #personaPanel {
      margin-top: 0
    }

    #dashboardView {
      display: block
    }

    /* Tri layout */
    .tri-layout {
      display: grid;
      grid-template-columns: 280px 1fr 340px;
      gap: 22px;
      margin-top: 18px
    }

    @media (max-width:1200px) {
      .tri-layout {
        grid-template-columns: 250px 1fr 300px
      }
    }

    @media (max-width:980px) {
      .tri-layout {
        grid-template-columns: 1fr
      }
    }

    .panel-heading {
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: .5px;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .ontology-group {
      margin-bottom: 14px
    }

    .ontology-group h4 {
      margin: 0 0 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: .5px;
      text-transform: uppercase
    }

    /* Modern PKM Enhancements */
    .note-link {
      display: block;
      padding: 8px 12px;
      border: 1px solid #1a2f43;
      background: linear-gradient(145deg, #0b1620, #0e1a26);
      border-radius: 10px;
      font-size: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      line-height: 1.4;
      position: relative;
      transition: all 0.2s ease
    }

    .note-link:hover {
      border-color: var(--accent);
      background: linear-gradient(145deg, #132a3c, #1a3247);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(125, 211, 252, 0.1)
    }

    .note-link .sem {
      display: block;
      font-size: 10px;
      color: var(--muted);
      margin-top: 3px;
      word-break: break-all;
      opacity: 0.7
    }

    .note-link .backlink-count {
      position: absolute;
      top: 6px;
      right: 8px;
      background: var(--accent);
      color: #012;
      font-size: 9px;
      padding: 1px 4px;
      border-radius: 8px;
      font-weight: 600
    }

    .note-link .note-preview {
      font-size: 11px;
      color: #9aa4b2;
      margin-top: 4px;
      line-height: 1.3;
      opacity: 0.8
    }

    .note-link .note-tags {
      margin-top: 4px
    }

    .note-tag {
      display: inline-block;
      background: #143046;
      color: var(--muted);
      font-size: 9px;
      padding: 1px 4px;
      border-radius: 6px;
      margin-right: 4px
    }

    .wikilink {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500
    }

    .wikilink:hover {
      text-decoration: underline
    }

    .search-enhanced {
      position: relative
    }

    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #081426;
      border: 1px solid #143046;
      border-radius: 8px;
      margin-top: 2px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none
    }

    .suggestion-item {
      padding: 8px 12px;
      border-bottom: 1px solid #0f1d2e;
      cursor: pointer;
      font-size: 12px
    }

    .suggestion-item:hover {
      background: #143046
    }

    .suggestion-item:last-child {
      border-bottom: none
    }

    .daily-note-indicator {
      color: #a3e635;
      font-weight: 600
    }

    .priority-central li[data-kind="personal"] {
      border-left: 3px solid #a3e635
    }

    .priority-central li[data-kind="system"] {
      border-left: 3px solid #7dd3fc
    }

    .priority-central {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 8px
    }

    .priority-central li {
      background: #0b1826;
      border: 1px solid #1f364b;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 12px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      cursor: pointer
    }

    .priority-central li:hover {
      border-color: var(--accent)
    }

    .prio-r {
      background: var(--accent);
      color: #012;
      font-weight: 600;
      font-size: 10px;
      border-radius: 6px;
      padding: 2px 6px;
      min-width: 18px;
      text-align: center;
      margin-top: 2px
    }

    .task-meta {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px
    }

    .goal-item {
      padding: 8px 10px;
      border: 1px solid #1f364b;
      background: #0b1826;
      border-radius: 10px;
      margin-bottom: 8px
    }

    .goal-bar {
      height: 6px;
      background: #142536;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 4px;
      position: relative
    }

    .goal-bar span {
      display: block;
      height: 100%;
      background: var(--accent)
    }

    .pill {
      display: inline-block;
      background: #143046;
      color: var(--muted);
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 12px;
      margin-left: 4px
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 14px;
      margin: 14px 0 4px
    }

    .stat-card {
      background: #0b1b2a;
      border: 1px solid #163048;
      padding: 12px 14px;
      border-radius: 12px;
      position: relative
    }

    .stat-card h4 {
      margin: 0 0 4px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: .5px;
      color: var(--muted)
    }

    .stat-value {
      font-size: 22px;
      font-weight: 600;
      line-height: 1
    }

    .stat-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px
    }

    .priority-mini-list {
      list-style: none;
      margin: 8px 0 0;
      padding: 0;
      display: grid;
      gap: 6px
    }

    .priority-mini-list li {
      background: #102538;
      border: 1px solid #1f3650;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .priority-mini-list span.rank {
      background: var(--accent);
      color: #012;
      font-weight: 600;
      font-size: 10px;
      border-radius: 6px;
      padding: 2px 6px;
      min-width: 18px;
      text-align: center
    }

    .empty-msg {
      font-size: 13px;
      color: var(--muted);
      font-style: italic;
      margin: 8px 0
    }

    .section-head {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 4px 0 6px
    }

    .section-head h3 {
      margin: 0;
      font-size: 15px;
      font-weight: 600
    }

    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #081426;
      border: 1px solid #143046;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #142a3d
    }

    .suggestion-item:hover {
      background: rgba(255, 255, 255, 0.05)
    }

    .suggestion-item:last-child {
      border-bottom: none
    }

    .search-enhanced {
      position: relative
    }

    /* Semantic link styling */
    .semantic-link {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500
    }

    .semantic-link:hover {
      text-decoration: underline
    }

    .semantic-link.broken {
      color: #fb923c;
      text-decoration: line-through
    }

    /* Enhanced note display */
    .note-link {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.01);
      cursor: pointer;
      position: relative;
      border: 1px solid transparent;
      transition: all 0.2s ease
    }

    .note-link:hover {
      background: rgba(255, 255, 255, 0.03);
      border-color: #143046;
      transform: translateX(2px)
    }

    .backlink-count {
      background: #7dd3fc;
      color: #012;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 5px;
      border-radius: 8px;
      margin-left: 6px
    }

    .note-preview {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      line-height: 1.4
    }

    .note-tags {
      margin-top: 6px
    }

    .note-tag {
      background: #143046;
      color: var(--muted);
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-right: 4px
    }

    .daily-note-indicator {
      border-left: 3px solid var(--accent) !important
    }

    /* Loading states */
    .loading-spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #143046;
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 6px
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg)
      }

      100% {
        transform: rotate(360deg)
      }
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* AI Insights Panel Styling */
    .ai-recommendation {
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }

    .ai-recommendation:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(125, 211, 252, 0.1);
    }

    .ai-recommendation.high-confidence {
      border-left-color: #4ade80;
    }

    .ai-recommendation.medium-confidence {
      border-left-color: #fbbf24;
    }

    .ai-recommendation.low-confidence {
      border-left-color: #f87171;
    }

    /* Neural Pattern Visualization */
    .pattern-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s infinite;
      margin-right: 6px;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.7;
        transform: scale(1.2);
      }

      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Smart Connection Lines */
    .connection-line {
      position: absolute;
      background: linear-gradient(90deg, var(--accent), rgba(125, 211, 252, 0.3));
      height: 2px;
      border-radius: 1px;
      animation: connectionFlow 2s ease-in-out infinite;
      z-index: 10;
    }

    @keyframes connectionFlow {
      0% {
        opacity: 0.3;
        transform: scaleX(0);
        transform-origin: left;
      }

      50% {
        opacity: 1;
        transform: scaleX(1);
      }

      100% {
        opacity: 0.3;
        transform: scaleX(0);
        transform-origin: right;
      }
    }

    /* Loading states */
    .loading-spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #143046;
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 6px
    }

    .status-indicator {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 12px;
      font-weight: 600
    }

    .status-success {
      background: #4ade80;
      color: #012
    }

    .status-loading {
      background: #fbbf24;
      color: #012
    }

    .status-error {
      background: #ef4444;
      color: white
    }

    /* Enhanced panels */
    .panel-heading {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .pill {
      background: #143046;
      color: var(--muted);
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 500
    }

    .tri-layout {
      display: grid;
      grid-template-columns: 1fr 320px 280px;
      gap: 18px;
      margin-top: 20px
    }

    @media (max-width:1200px) {
      .tri-layout {
        grid-template-columns: 1fr 280px 260px;
        gap: 16px
      }
    }

    @media (max-width:900px) {
      .tri-layout {
        grid-template-columns: 1fr;
        gap: 14px
      }
    }

    /* Priority lists */
    .priority-central {
      list-style: none;
      padding: 0;
      margin: 0
    }

    .priority-central li {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s
    }

    .priority-central li:hover {
      background: rgba(255, 255, 255, 0.03)
    }

    .priority-central li[data-kind="system"] {
      border-left: 2px solid #7dd3fc
    }

    .priority-central li[data-kind="personal"] {
      border-left: 2px solid #a3e635
    }

    .prio-r {
      background: #143046;
      color: var(--muted);
      font-size: 10px;
      padding: 2px 5px;
      border-radius: 4px;
      min-width: 18px;
      text-align: center;
      font-weight: 600
    }

    .task-meta {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px
    }

    /* Goals styling */
    .goal-item {
      margin-bottom: 8px
    }

    .goal-bar {
      background: #142536;
      height: 4px;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 3px
    }

    .goal-bar span {
      display: block;
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease
    }

    /* Ontology groups */
    .ontology-group {
      margin-bottom: 16px
    }

    .ontology-group h4 {
      font-size: 12px;
      font-weight: 600;
      margin: 0 0 6px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 6px
    }

    .sem {
      font-size: 10px;
      color: var(--muted);
      margin-left: auto
    }

    /* Empty states */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted)
    }

    .empty-state h3 {
      margin: 0 0 8px;
      font-size: 16px
    }

    .empty-state p {
      margin: 0;
      font-size: 13px;
      line-height: 1.5
    }

    /* PKM Tree View Styles */
    .tree-container {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
      line-height: 1.4
    }

    .tree-node {
      margin: 0;
      padding: 0;
      list-style: none
    }

    .tree-item {
      display: flex;
      align-items: center;
      padding: 2px 0;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.15s ease
    }

    .tree-item:hover {
      background: rgba(125, 211, 252, 0.05)
    }

    .tree-item.selected {
      background: rgba(125, 211, 252, 0.1);
      font-weight: 600
    }

    .tree-toggle {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 4px;
      color: var(--muted);
      font-size: 10px;
      border-radius: 2px;
      transition: all 0.15s ease
    }

    .tree-toggle:hover {
      background: rgba(125, 211, 252, 0.1);
      color: var(--accent)
    }

    .tree-toggle.expanded {
      transform: rotate(90deg)
    }

    .tree-toggle.leaf {
      visibility: hidden
    }

    .tree-icon {
      width: 16px;
      text-align: center;
      margin-right: 6px;
      font-size: 11px
    }

    .tree-label {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .tree-meta {
      font-size: 10px;
      color: var(--muted);
      margin-left: 8px;
      opacity: 0.7
    }

    .tree-children {
      margin-left: 16px;
      border-left: 1px solid rgba(125, 211, 252, 0.1);
      padding-left: 8px;
      display: none
    }

    .tree-children.expanded {
      display: block
    }

    .tree-category {
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 8px 0 4px
    }

    .tree-category:first-child {
      margin-top: 0
    }

    .tree-count {
      background: #143046;
      color: var(--muted);
      font-size: 9px;
      padding: 1px 4px;
      border-radius: 6px;
      margin-left: 4px
    }

    /* Category-specific icons and colors */
    .tree-item[data-type="person"] .tree-icon {
      color: #fbbf24
    }

    .tree-item[data-type="concept"] .tree-icon {
      color: #a78bfa
    }

    .tree-item[data-type="project"] .tree-icon {
      color: #34d399
    }

    .tree-item[data-type="task"] .tree-icon {
      color: #f87171
    }

    .tree-item[data-type="note"] .tree-icon {
      color: #60a5fa
    }

    .tree-item[data-type="meeting"] .tree-icon {
      color: #fb923c
    }

    .tree-item[data-type="travel"] .tree-icon {
      color: #38bdf8
    }

    .tree-item[data-type="health"] .tree-icon {
      color: #4ade80
    }

    .tree-item[data-type="family"] .tree-icon {
      color: #f472b6
    }

    .tree-item[data-type="idea"] .tree-icon {
      color: #fde047
    }

    /* Professional PKM Layout - Full Screen */
    .new-layout {
      display: grid;
      grid-template-columns: 380px 1fr 360px;
      gap: 24px;
      margin: 20px 0 0 0;
      min-height: calc(100vh - 100px);
      /* Account for header height */
      padding: 0 20px 20px 20px;
      box-sizing: border-box;
    }

    .pkm-layout {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 18px;
      margin-top: 20px
    }

    .pkm-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .left-column .panel {
      margin-top: 0;
      margin-bottom: 0;
      padding: 18px;
    }

    .panel {
      padding: 18px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin: 8px 0
    }

    .tab-btn {
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
      border: none;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease
    }

    .tab-btn.active {
      background: var(--accent);
      color: #0a0e13
    }

    .tab-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.08)
    }

    /* Filters */
    .filter-btn {
      padding: 2px 6px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
      border: none;
      border-radius: 3px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s ease
    }

    .filter-btn.active {
      background: var(--accent);
      color: #0a0e13
    }

    .filter-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.08)
    }

    /* Professional PKM Items */
    .inbox-item,
    .project-item,
    .person-item,
    .work-item {
      padding: 8px;
      margin-bottom: 6px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease
    }

    .inbox-item:hover,
    .project-item:hover,
    .person-item:hover,
    .work-item:hover {
      background: rgba(255, 255, 255, 0.04);
      transform: translateX(2px)
    }

    /* Ontology clusters */
    .ontology-cluster {
      margin-bottom: 12px
    }

    .concept-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px
    }

    .concept-tag {
      background: rgba(125, 211, 252, 0.1);
      color: #7dd3fc;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease
    }

    .concept-tag:hover {
      background: rgba(125, 211, 252, 0.2)
    }

    /* Archive categories */
    .archive-category {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      cursor: pointer;
      transition: background 0.2s ease
    }

    .archive-category:hover {
      background: rgba(255, 255, 255, 0.02)
    }

    .archive-category .count {
      color: var(--accent);
      font-weight: 500
    }

    /* Responsive PKM */
    @media (max-width:1400px) {
      .new-layout {
        grid-template-columns: 340px 1fr 320px;
        gap: 24px;
        padding: 16px;
      }
    }

    @media (max-width:1200px) {
      .new-layout {
        grid-template-columns: 300px 1fr 280px;
        gap: 20px;
        padding: 12px;
      }

      .pkm-layout {
        grid-template-columns: 260px 1fr 300px;
        gap: 16px
      }
    }

    @media (max-width:900px) {
      .new-layout {
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 8px;
      }
    }

    @media (max-width:900px) {
      .pkm-layout {
        grid-template-columns: 1fr;
        gap: 14px
      }
    }

    .tree-search {
      width: 100%;
      padding: 6px 8px;
      background: #081426;
      border: 1px solid #143046;
      border-radius: 6px;
      color: var(--foreground);
      font-size: 11px;
      margin-bottom: 12px
    }

    .tree-search:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(125, 211, 252, 0.1)
    }

    .tree-search::placeholder {
      color: var(--muted)
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>PKM Semantic Vault</h1>
      <div class="controls">
        <!-- User Selector -->
        <div id="userSelector" style="display:flex;align-items:center;gap:8px;margin-right:12px;">
          <span style="font-size:12px;color:var(--muted);">User:</span>
          <select id="userSelect"
            style="background:#061423;border:1px solid #143046;padding:6px 8px;border-radius:6px;color:var(--muted);font-size:12px;">
            <option value="">Select user...</option>
          </select>
          <button id="refreshUsers" class="small-btn" title="Refresh user list"
            style="background:#143046;color:var(--muted);padding:4px 6px;">↻</button>
        </div>

        <button id="chooseFolder">Choose Folder</button>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="small-btn" id="openGraph" title="Open knowledge graph"
            style="background:#143046;color:var(--muted);">Graph</button>
          <button class="small-btn" id="openPersona" title="Persona overview"
            style="background:#143046;color:var(--muted);">Persona</button>
          <button class="small-btn" id="openStats" title="Stats overview"
            style="background:#143046;color:var(--muted);">Stats</button>
        </div>
        <a href="knowledge-builder-demo.html"
          style="background:var(--accent);border:1px solid var(--accent);padding:8px 12px;border-radius:8px;color:#012;cursor:pointer;font-weight:600;text-decoration:none;display:inline-block;"
          title="Iterative Knowledge Building Demo">�️ AI Builder</a>
        <input type="text" id="search" placeholder="Search notes... (try: [[note]] or #tag)" class="search-enhanced">
        <a href="pathfinding.html"
          style="background:linear-gradient(135deg, #FFD700, #FF4500);border:1px solid #FFD700;padding:8px 12px;border-radius:8px;color:#000;cursor:pointer;font-weight:600;text-decoration:none;display:inline-block;box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);margin-left:8px;"
          title="Semantic Pathfinding - GPS for Goals">🧭 Pathfinding</a>
        <a href="pathfinding-compact.html"
          style="background:linear-gradient(135deg, #4f46e5, #7c3aed);border:1px solid #4f46e5;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer;font-weight:600;text-decoration:none;display:inline-block;box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);margin-left:8px;"
          title="AI-Powered Pathfinding Assistant">🤖 AI Chat</a>
        <div id="searchSuggestions" class="search-suggestions"></div>

        <!-- Developer/System Menu -->
        <div style="position:relative;">
          <button class="small-btn" id="devMenu" title="Developer tools"
            style="background:#ff6b6b22;color:#ff6b6b;border:1px solid #ff6b6b44;">⚙️ System</button>
          <div id="devMenuDropdown"
            style="display:none;position:absolute;right:0;top:100%;background:#081426;border:1px solid #143046;border-radius:8px;padding:8px;margin-top:4px;z-index:100;min-width:200px;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-weight:600;">SYSTEM DEVELOPMENT</div>
            <button id="loadVault"
              style="width:100%;background:#143046;border:none;padding:6px 8px;border-radius:6px;color:var(--muted);cursor:pointer;margin-bottom:4px;font-size:12px;">Load
              ./vault/ (if served)</button>
            <button id="debugLoad"
              style="width:100%;background:#ff6b6b22;border:1px solid #ff6b6b44;padding:6px 8px;border-radius:6px;color:#ff6b6b;cursor:pointer;margin-bottom:4px;font-size:12px;">Debug
              Load</button>
            <a href="goals.html"
              style="display:block;width:100%;background:#143046;border:none;padding:6px 8px;border-radius:6px;color:var(--muted);cursor:pointer;text-decoration:none;font-size:12px;text-align:left;">📊
              System Goals</a>
          </div>
        </div>
        <span id="loadStatus" style="margin-left:10px;font-size:12px;color:var(--muted);"></span>
      </div>
    </header>
    <nav class="app-nav" aria-label="Primary" hidden></nav>

    <!-- Legacy views hidden completely -->
    <section id="dashboardView" style="display:none">
      <div id="onboarding" class="panel" style="display:none">
        <h3 style="margin-top:0">Welcome</h3>
        <p style="font-size:14px;line-height:1.5;color:var(--muted);max-width:720px">Choose your Markdown knowledge base
          folder to start organizing your notes, ideas, and projects. The AI Builder will help categorize your
          documents, while the graph reveals connections between concepts and people in your collection.</p>
      </div>
      <div id="statsPanel" class="panel"></div>
      <div id="priorityPanelMini" class="panel"></div>
      <div id="personaPanel" class="panel"></div>
    </section>

    <main id="notesView" style="display:none">
      <section>
        <div id="fileList" class="panel"></div>
        <div id="projectList" class="panel" style="margin-top:12px;"></div>
      </section>
      <aside>
        <div id="conceptList" class="panel"></div>
        <div id="taskList" class="panel" style="margin-top:12px;"></div>
      </aside>
    </main>

    <!-- New 3-Panel Layout: PKM/Ontology | Tasks | Projects -->
    <div class="new-layout" id="newLayout"
      style="display:grid;grid-template-columns:380px 1fr 360px;gap:32px;padding:20px;margin-top:20px;">

      <!-- Left: PKM ↔ Ontology Switch -->
      <div class="left-column">
        <div class="main-tabs" style="display:flex;gap:4px;margin-bottom:12px;">
          <button class="main-tab-btn active" data-main-tab="pkm"
            style="flex:1;padding:8px;background:var(--accent);color:#0a0e13;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;">📚
            PKM</button>
          <button class="main-tab-btn" data-main-tab="ontology"
            style="flex:1;padding:8px;background:rgba(255,255,255,0.05);color:var(--muted);border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;">🗺️
            Ontology</button>
        </div>

        <!-- PKM Tab Content -->
        <div id="pkmTabContent" class="main-tab-content">
          <div id="inboxPanel" class="panel" aria-label="Inbox">
            <div class="panel-heading" style="justify-content:space-between;">
              <span>📥 Inbox</span>
              <span class="pill" id="inboxCount">2</span>
            </div>
            <p class='meta' style='font-size:12px;margin-bottom:10px'>Unprocessed ideas and documents</p>
            <div id="inboxItems" style="max-height:140px;overflow-y:auto;">
              <div class="inbox-item"
                style="padding:6px;margin-bottom:4px;background:rgba(255,255,255,0.02);border-radius:4px;border-left:3px solid #fbbf24;cursor:pointer;"
                onclick="highlightPKMSource(this)">
                <div style="font-size:12px;font-weight:500;">📄 Untitled note</div>
                <div style="font-size:10px;color:var(--muted);margin-top:1px;">Added 2 hours ago</div>
              </div>
              <div class="inbox-item"
                style="padding:6px;margin-bottom:4px;background:rgba(255,255,255,0.02);border-radius:4px;border-left:3px solid #fbbf24;cursor:pointer;"
                onclick="highlightPKMSource(this)">
                <div style="font-size:12px;font-weight:500;">💡 Meeting idea</div>
                <div style="font-size:10px;color:var(--muted);margin-top:1px;">Added yesterday</div>
              </div>
            </div>
            <button
              style="width:100%;margin-top:6px;background:#143046;border:1px solid var(--accent);padding:4px;border-radius:4px;color:var(--accent);font-size:10px;cursor:pointer;"
              onclick="addToInbox()">+ Quick Capture</button>
          </div>

          <div id="knowledgePanel" class="panel" aria-label="Knowledge Base" style="margin-top:12px;">
            <div class="panel-heading" style="justify-content:space-between;">
              <span>�️ Knowledge Base</span>
              <span class="pill" id="knowledgeCount">45</span>
            </div>
            <div class="knowledge-categories" style="font-size:11px;">
              <div class="knowledge-category"
                style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;"
                onclick="highlightPKMSource(this)">
                <span>👥 People</span>
                <span class="count">12</span>
              </div>
              <div class="knowledge-category"
                style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;"
                onclick="highlightPKMSource(this)">
                <span>📚 Research</span>
                <span class="count">18</span>
              </div>
              <div class="knowledge-category"
                style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;"
                onclick="highlightPKMSource(this)">
                <span>📝 Notes</span>
                <span class="count">15</span>
              </div>
            </div>
          </div>

          <div id="archivePanel" class="panel" aria-label="Archive" style="margin-top:12px;">
            <div class="panel-heading" style="justify-content:space-between;">
              <span>📦 Archive</span>
              <span class="pill" id="archiveCount">240</span>
            </div>
            <div class="archive-categories" style="font-size:11px;">
              <div class="archive-category"
                style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;"
                onclick="highlightPKMSource(this)">
                <span>✅ Completed</span>
                <span class="count">89</span>
              </div>
              <div class="archive-category"
                style="display:flex;justify-content:space-between;padding:3px 0;cursor:pointer;"
                onclick="highlightPKMSource(this)">
                <span>💡 Ideas Bank</span>
                <span class="count">151</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Ontology Tab Content -->
        <div id="ontologyTabContent" class="main-tab-content" style="display:none;">
          <div id="ontologyPanel" class="panel" aria-label="Ontological Landscape">
            <div class="panel-heading">
              <span>🗺️ Conceptual Landscape</span>
            </div>
            <p class='meta' style='font-size:12px;margin-bottom:10px'>What am I thinking? What's important to me?</p>
            <div id="ontologyContent" style="max-height:400px;overflow-y:auto;">
              <div class="ontology-cluster" style="margin-bottom:12px;">
                <div style="font-weight:600;font-size:12px;color:var(--accent);margin-bottom:6px;">🧠 Core Concepts
                </div>
                <div class="concept-tags" style="display:flex;flex-wrap:wrap;gap:4px;">
                  <span class="concept-tag"
                    style="background:rgba(125,211,252,0.1);color:#7dd3fc;padding:2px 6px;border-radius:4px;font-size:10px;cursor:pointer;">systems
                    thinking</span>
                  <span class="concept-tag"
                    style="background:rgba(125,211,252,0.1);color:#7dd3fc;padding:2px 6px;border-radius:4px;font-size:10px;cursor:pointer;">knowledge
                    mgmt</span>
                  <span class="concept-tag"
                    style="background:rgba(125,211,252,0.1);color:#7dd3fc;padding:2px 6px;border-radius:4px;font-size:10px;cursor:pointer;">AI
                    research</span>
                </div>
              </div>
              <div class="ontology-cluster" style="margin-bottom:12px;">
                <div style="font-weight:600;font-size:12px;color:#a3e635;margin-bottom:6px;">👨‍👩‍👧‍👦 Life Domains
                </div>
                <div class="concept-tags" style="display:flex;flex-wrap:wrap;gap:4px;">
                  <span class="concept-tag"
                    style="background:rgba(163,230,53,0.1);color:#a3e635;padding:2px 6px;border-radius:4px;font-size:10px;cursor:pointer;">family</span>
                  <span class="concept-tag"
                    style="background:rgba(163,230,53,0.1);color:#a3e635;padding:2px 6px;border-radius:4px;font-size:10px;cursor:pointer;">health</span>
                  <span class="concept-tag"
                    style="background:rgba(163,230,53,0.1);color:#a3e635;padding:2px 6px;border-radius:4px;font-size:10px;cursor:pointer;">career</span>
                </div>
              </div>
            </div>
            <button
              style="width:100%;margin-top:8px;background:#143046;border:1px solid #8b5cf6;padding:6px;border-radius:6px;color:#8b5cf6;font-size:11px;cursor:pointer;"
              onclick="reflectOnThinking()">💭 Reflect</button>
          </div>
        </div>

        <!-- AI-Powered Smart Insights Panel -->
        <div id="aiInsightsPanel" class="panel" aria-label="AI Insights" style="margin-top:12px;">
          <div class="panel-heading" style="justify-content:space-between;">
            <span>🤖 AI Insights</span>
            <span class="pill" id="insightsCount">-</span>
          </div>
          <p class='meta' style='font-size:12px;margin-bottom:10px'>Intelligent recommendations based on your patterns
          </p>
          <div id="aiRecommendations" style="max-height:200px;overflow-y:auto;">
            <div class="ai-recommendation"
              style="padding:8px;margin-bottom:6px;background:rgba(125,211,252,0.05);border-radius:6px;border-left:3px solid #7dd3fc;">
              <div style="font-size:12px;font-weight:500;">🧠 Analyzing your patterns...</div>
              <div style="font-size:10px;color:var(--muted);margin-top:2px;">AI insights will appear here</div>
            </div>
          </div>
          <button
            style="width:100%;margin-top:8px;background:#143046;border:1px solid #7dd3fc;padding:6px;border-radius:6px;color:#7dd3fc;font-size:11px;cursor:pointer;"
            onclick="refreshAIInsights()">🔄 Refresh Insights</button>
        </div>
      </div>

      <!-- Column 2: Content Staging Area -->
      <div class="pkm-column">
        <div id="centerPanel" class="panel" aria-label="Content Staging Area" style="height: calc(40vh - 60px);">
          <div class="panel-heading" style="justify-content: space-between;">
            <span id="stagingTitle">📋 Content Staging Area</span>
            <div class="staging-controls" style="display: flex; gap: 8px;">
              <button class="small-btn" onclick="clearStaging()" title="Clear staging area">Clear</button>
              <button class="small-btn" onclick="refreshStaging()" title="Refresh content">🔄</button>
            </div>
          </div>

          <div id="stagingContent" style="height: 100%; overflow-y: auto; padding: 16px;">
            <div class="staging-welcome" style="text-align: center; padding: 60px 20px; color: #64748b;">
              <div style="font-size: 48px; margin-bottom: 16px;">�</div>
              <h3 style="margin: 0 0 12px 0; color: #94a3b8;">Content Staging Area</h3>
              <p style="margin: 0; line-height: 1.5;">
                Click on any PKM section, note, task, or project to view and edit it here.
                This is your workspace for interacting with all content types.
              </p>
              <div style="margin-top: 24px;">
                <button onclick="showStagingDemo()"
                  style="background: var(--accent); color: #0a0e13; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                  View Demo
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- FULL-FEATURED AI PATHFINDING SYSTEM -->
        <div id="pathfindingSystem" class="panel" aria-label="AI Pathfinding System"
          style="margin-top:12px; height: calc(55vh - 60px);">
          <div class="panel-heading"
            style="background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,69,0,0.1)); border-bottom: 2px solid rgba(255,215,0,0.3);">
            <span style="font-size: 16px; font-weight: 700;">🧭 AI Pathfinding System</span>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div id="ai-connection-status" style="display: flex; align-items: center; gap: 4px; font-size: 10px;">
                <div id="openai-status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"
                  title="OpenAI"></div>
                <span style="color: var(--muted);">OpenAI</span>
                <div id="gemini-status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"
                  title="Gemini"></div>
                <span style="color: var(--muted);">Gemini</span>
              </div>
              <button id="pathfinding-minimize" onclick="togglePathfindingSize()"
                style="background: rgba(255,215,0,0.2); border: 1px solid rgba(255,215,0,0.4); color: #FFD700; padding: 3px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">
                Minimize
              </button>
            </div>
          </div>

          <div id="pathfinding-content"
            style="height: calc(100% - 40px); display: flex; flex-direction: column; padding: 12px;">

            <!-- Goal Input Section -->
            <div
              style="margin-bottom: 12px; padding: 10px; background: rgba(255,215,0,0.05); border-radius: 8px; border: 1px solid rgba(255,215,0,0.1);">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <div>
                  <label style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px;">Starting
                    Point:</label>
                  <input type="text" id="pathfind-start" placeholder="Where are you now?"
                    style="width: 100%; padding: 6px 8px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text); font-size: 12px;">
                </div>
                <div>
                  <label style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px;">Target
                    Goal:</label>
                  <input type="text" id="pathfind-goal" placeholder="What do you want to achieve?"
                    style="width: 100%; padding: 6px 8px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text); font-size: 12px;">
                </div>
              </div>

              <!-- Context Sliders -->
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                <div>
                  <label style="font-size: 10px; color: var(--muted);">Skill Level:</label>
                  <input type="range" id="skill-level" min="0" max="100" value="50"
                    style="width: 100%; accent-color: #FFD700;">
                  <span id="skill-value" style="font-size: 9px; color: var(--muted);">50%</span>
                </div>
                <div>
                  <label style="font-size: 10px; color: var(--muted);">Time Available:</label>
                  <input type="range" id="time-available" min="0" max="100" value="50"
                    style="width: 100%; accent-color: #FFD700;">
                  <span id="time-value" style="font-size: 9px; color: var(--muted);">50%</span>
                </div>
                <div>
                  <label style="font-size: 10px; color: var(--muted);">Risk Tolerance:</label>
                  <input type="range" id="risk-tolerance" min="0" max="100" value="50"
                    style="width: 100%; accent-color: #FFD700;">
                  <span id="risk-value" style="font-size: 9px; color: var(--muted);">50%</span>
                </div>
              </div>

              <!-- Action Buttons -->
              <div style="display: flex; gap: 8px;">
                <button onclick="generateFullPathfinding()"
                  style="flex: 2; background: linear-gradient(135deg, #FFD700, #FF4500); border: none; padding: 8px 12px; border-radius: 6px; color: #000; font-weight: 600; cursor: pointer; font-size: 12px;">
                  🧭 Generate Routes
                </button>
                <button onclick="loadExampleGoal('business')"
                  style="flex: 1; background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.3); color: #3b82f6; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 11px;">
                  💼 Business
                </button>
                <button onclick="loadExampleGoal('learning')"
                  style="flex: 1; background: rgba(168,85,247,0.2); border: 1px solid rgba(168,85,247,0.3); color: #a855f7; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 11px;">
                  📚 Learning
                </button>
                <button onclick="loadExampleGoal('health')"
                  style="flex: 1; background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.3); color: #22c55e; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 11px;">
                  🏃 Health
                </button>
              </div>
            </div>

            <!-- Main Content Area -->
            <div style="flex: 1; display: grid; grid-template-columns: 1fr 300px; gap: 12px; min-height: 0;">

              <!-- Left: Route Visualization & Results -->
              <div style="display: flex; flex-direction: column; min-height: 0;">

                <!-- Route Visualization Canvas -->
                <div
                  style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-bottom: 10px; height: 180px; position: relative;">
                  <div
                    style="position: absolute; top: 8px; left: 10px; font-size: 11px; color: var(--muted); font-weight: 600;">
                    🗺️ Route Visualization</div>
                  <canvas id="pathfinding-canvas-main" style="width: 100%; height: 100%; border-radius: 6px;"></canvas>
                </div>

                <!-- Route Options -->
                <div style="flex: 1; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; overflow-y: auto;">
                  <div style="font-size: 12px; color: var(--accent); font-weight: 600; margin-bottom: 8px;">🚀 Generated
                    Routes</div>
                  <div id="route-results-main">
                    <div style="text-align: center; padding: 20px; color: var(--muted); font-size: 11px;">
                      <div style="font-size: 24px; margin-bottom: 8px;">🧭</div>
                      <div>Enter your goals above and click "Generate Routes" to see pathfinding options</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Right: AI Chat Assistant -->
              <div
                style="display: flex; flex-direction: column; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; min-height: 0;">

                <!-- AI Chat Header -->
                <div
                  style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                  <div style="font-size: 12px; color: var(--accent); font-weight: 600;">🤖 AI Assistant</div>
                  <button onclick="showAPISetup()"
                    style="background: rgba(255,215,0,0.2); border: 1px solid rgba(255,215,0,0.3); color: #FFD700; padding: 2px 6px; border-radius: 3px; font-size: 9px; cursor: pointer;">
                    Setup API
                  </button>
                </div>

                <!-- Quick Action Buttons -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 8px;">
                  <button onclick="askAI('How can I optimize this path for faster results?')"
                    style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); color: #22c55e; padding: 4px 6px; border-radius: 4px; font-size: 9px; cursor: pointer;">
                    ⚡ Optimize
                  </button>
                  <button onclick="askAI('What are the main risks in this approach?')"
                    style="background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); color: #ef4444; padding: 4px 6px; border-radius: 4px; font-size: 9px; cursor: pointer;">
                    ⚠️ Risks
                  </button>
                  <button onclick="askAI('Break this goal into smaller actionable steps')"
                    style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); color: #3b82f6; padding: 4px 6px; border-radius: 4px; font-size: 9px; cursor: pointer;">
                    📋 Steps
                  </button>
                  <button onclick="askAI('Suggest alternative creative approaches')"
                    style="background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.2); color: #a855f7; padding: 4px 6px; border-radius: 4px; font-size: 9px; cursor: pointer;">
                    💡 Creative
                  </button>
                </div>

                <!-- Chat Messages -->
                <div id="ai-chat-messages"
                  style="flex: 1; overflow-y: auto; margin-bottom: 8px; min-height: 100px; max-height: 150px;">
                  <div style="padding: 8px; background: rgba(59,130,246,0.1); border-radius: 6px; margin-bottom: 6px;">
                    <div style="font-size: 10px; color: #3b82f6; font-weight: 600; margin-bottom: 2px;">🤖 AI Assistant
                    </div>
                    <div style="font-size: 11px; line-height: 1.3;">
                      Welcome! I'm your pathfinding AI assistant. Connect your API keys above, then ask me anything
                      about route optimization, goal achievement strategies, or breaking down complex objectives.
                    </div>
                  </div>
                </div>

                <!-- Chat Input -->
                <div style="display: flex; gap: 6px;">
                  <input type="text" id="ai-chat-input" placeholder="Ask about pathfinding strategies..."
                    style="flex: 1; padding: 6px 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text); font-size: 11px;">
                  <button onclick="sendAIMessage()"
                    style="background: linear-gradient(135deg, #FFD700, #FF4500); border: none; padding: 6px 10px; border-radius: 4px; color: #000; font-weight: 600; cursor: pointer; font-size: 11px;">
                    Send
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Column 3: Active Projects & Tasks -->
      <div class="pkm-column">
        <!-- Projects Panel - Now at Top -->
        <div id="projectsPanel" class="panel" aria-label="Projects">
          <div class="panel-heading" style="justify-content:space-between;">
            <span>🚀 Active Projects</span>
            <span class="pill" id="projectsCount">0</span>
          </div>
          <p class='meta' style='font-size:12px;margin-bottom:10px'>Your current initiatives and everyday goals</p>

          <!-- Project List -->
          <div id="projectsContent" style="max-height:300px;overflow-y:auto;">
            <!-- Projects will be populated with realistic user projects -->
          </div>

          <button id="addProjectBtn"
            style="width:100%;margin-top:8px;background:#143046;border:1px solid var(--accent);padding:6px;border-radius:6px;color:var(--accent);font-size:11px;cursor:pointer;"
            onclick="createNewProject()">+ New Project</button>
        </div>
        <!-- Tasks Panel -->
        <div id="tasksPanel" class="panel" aria-label="Tasks" style="margin-top:12px;">
          <div class="panel-heading" style="justify-content:space-between;">
            <span>✅ Tasks</span>
            <span class="pill" id="tasksCount">0</span>
          </div>
          <div class="task-filters" style="display:flex;gap:6px;margin:10px 0;">
            <button class="filter-btn active" data-filter="all"
              style="padding:2px 6px;background:var(--accent);color:#0a0e13;border:none;border-radius:3px;font-size:10px;cursor:pointer;">All</button>
            <button class="filter-btn" data-filter="today"
              style="padding:2px 6px;background:rgba(255,255,255,0.05);color:var(--muted);border:none;border-radius:3px;font-size:10px;cursor:pointer;">Today</button>
            <button class="filter-btn" data-filter="week"
              style="padding:2px 6px;background:rgba(255,255,255,0.05);color:var(--muted);border:none;border-radius:3px;font-size:10px;cursor:pointer;">This
              Week</button>
          </div>
          <div id="tasksContent" style="max-height:180px;overflow-y:auto;">
            <!-- Tasks will be populated here -->
          </div>
          <button
            style="width:100%;margin-top:8px;background:#143046;border:1px solid var(--accent);padding:6px;border-radius:6px;color:var(--accent);font-size:11px;cursor:pointer;"
            onclick="addTask()">+ Add Task</button>
        </div>

        <!-- Active Work Panel -->
        <div id="activeWorkPanel" class="panel" aria-label="Active Work" style="margin-top:12px;">
          <div class="panel-heading">
            <span>🎯 Today's Focus</span>
          </div>
          <p class='meta' style='font-size:12px;margin-bottom:10px'>What you're working on right now</p>
          <div id="activeWorkItems">
            <!-- Active work items will be populated here -->
          </div>
        </div>

        <!-- Projects Panel -->
        <div id="projectsPanel" class="panel" aria-label="Projects" style="margin-top:12px;">
          <div class="panel-heading" style="justify-content:space-between;">
            <span>🏗️ Projects</span>
            <span class="pill" id="projectsCount">3</span>
          </div>
          <p class='meta' style='font-size:12px;margin-bottom:10px'>Active initiatives with hierarchical flow</p>

          <!-- Project Hierarchies -->
          <div id="projectsContent" style="max-height:250px;overflow-y:auto;">

            <!-- Project 1: PKM System -->
            <div class="project-hierarchy clickable-item"
              style="margin-bottom:16px;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px;cursor:pointer;"
              onclick="stageProject(this)">
              <div class="project-goal">
                <div style="font-size:14px;font-weight:600;color:var(--accent);margin-bottom:4px;">🎯 PKM System
                  Development</div>
                <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">75% complete • 3 tasks remaining</div>
                <div style="background:#143046;height:3px;border-radius:2px;overflow:hidden;">
                  <div style="background:var(--accent);height:100%;width:75%;"></div>
                </div>
              </div>
            </div>
            <div class="subgoal" style="margin-left:12px;margin-bottom:8px;">
              <div style="font-size:12px;font-weight:500;color:#a3e635;">📋 Interface Design</div>
              <div class="task-item clickable-task" data-pkm-source="design-notes" data-project="pkm-system"
                style="margin-left:12px;padding:4px;margin-bottom:3px;background:rgba(255,255,255,0.02);border-radius:4px;border-left:2px solid var(--accent);cursor:pointer;"
                onclick="highlightTaskConnections(this)">
                <div style="font-size:11px;">✅ Create tri-column layout</div>
              </div>
              <div class="task-item clickable-task" data-pkm-source="ui-patterns" data-project="pkm-system"
                style="margin-left:12px;padding:4px;margin-bottom:3px;background:rgba(255,255,255,0.02);border-radius:4px;border-left:2px solid #fbbf24;cursor:pointer;"
                onclick="highlightTaskConnections(this)">
                <div style="font-size:11px;">🔄 Add PKM/Ontology tabs</div>
              </div>
            </div>

            <div class="subgoal" style="margin-left:12px;margin-bottom:8px;">
              <div style="font-size:12px;font-weight:500;color:#a3e635;">� Semantic System</div>
              <div class="task-item clickable-task" data-pkm-source="semantic-notes" data-project="pkm-system"
                style="margin-left:12px;padding:4px;margin-bottom:3px;background:rgba(255,255,255,0.02);border-radius:4px;border-left:2px solid #10b981;cursor:pointer;"
                onclick="highlightTaskConnections(this)">
                <div style="font-size:11px;">🔍 Implement sem:// URIs</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Project 2: Research Initiative -->
        <div class="project-hierarchy"
          style="margin-bottom:16px;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px;">
          <div class="project-goal" style="cursor:pointer;" onclick="toggleProjectDetails('project2')">
            <div style="font-size:14px;font-weight:600;color:#10b981;margin-bottom:4px;">📚 Research Initiative
            </div>
            <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">Planning phase • Starting next week
            </div>
            <div style="background:#143046;height:3px;border-radius:2px;overflow:hidden;">
              <div style="background:#10b981;height:100%;width:25%;"></div>
            </div>
          </div>

          <div id="project2Details" class="project-details" style="margin-top:8px;display:none;">
            <div class="subgoal" style="margin-left:12px;margin-bottom:8px;">
              <div style="font-size:12px;font-weight:500;color:#a3e635;">📖 Literature Review</div>
              <div class="task-item clickable-task" data-pkm-source="research-notes" data-project="research"
                style="margin-left:12px;padding:4px;margin-bottom:3px;background:rgba(255,255,255,0.02);border-radius:4px;border-left:2px solid #fbbf24;cursor:pointer;"
                onclick="highlightTaskConnections(this)">
                <div style="font-size:11px;">� Gather academic papers</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Personal Goals Section -->
        <div class="personal-goals-section" style="margin-top:20px;">
          <div style="font-size:13px;font-weight:600;color:#8b5cf6;margin-bottom:8px;">🎯 Personal Goals</div>

          <div class="goal-hierarchy"
            style="margin-bottom:12px;border:1px solid rgba(139,92,246,0.2);border-radius:6px;padding:8px;">
            <div class="personal-goal" style="cursor:pointer;" onclick="toggleGoalDetails('goal1')">
              <div style="font-size:12px;font-weight:500;color:#8b5cf6;">📚 Learn & Grow</div>
              <div style="font-size:10px;color:var(--muted);margin-top:2px;">Expand knowledge and skills</div>
              <div style="background:#143046;height:3px;border-radius:2px;overflow:hidden;margin-top:4px;">
                <div style="background:#8b5cf6;height:100%;width:65%;"></div>
              </div>
            </div>

            <div id="goal1Details" class="goal-details" style="margin-top:6px;display:none;">
              <div class="task-item clickable-task" data-pkm-source="learning-notes" data-project="personal-growth"
                style="margin-left:8px;padding:3px;margin-bottom:2px;background:rgba(139,92,246,0.05);border-radius:3px;border-left:2px solid #8b5cf6;cursor:pointer;font-size:10px;"
                onclick="highlightTaskConnections(this)">
                ✅ Read 2 tech books monthly
              </div>
              <div class="task-item clickable-task" data-pkm-source="learning-notes" data-project="personal-growth"
                style="margin-left:8px;padding:3px;margin-bottom:2px;background:rgba(139,92,246,0.05);border-radius:3px;border-left:2px solid #fbbf24;cursor:pointer;font-size:10px;"
                onclick="highlightTaskConnections(this)">
                🔄 Practice new programming concepts
              </div>
            </div>
          </div>

          <div class="goal-hierarchy"
            style="margin-bottom:12px;border:1px solid rgba(139,92,246,0.2);border-radius:6px;padding:8px;">
            <div class="personal-goal" style="cursor:pointer;" onclick="toggleGoalDetails('goal2')">
              <div style="font-size:12px;font-weight:500;color:#8b5cf6;">🎯 Create & Build</div>
              <div style="font-size:10px;color:var(--muted);margin-top:2px;">Complete meaningful projects</div>
              <div style="background:#143046;height:3px;border-radius:2px;overflow:hidden;margin-top:4px;">
                <div style="background:#8b5cf6;height:100%;width:40%;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button
        style="width:100%;margin-top:8px;background:#143046;border:1px solid var(--accent);padding:6px;border-radius:6px;color:var(--accent);font-size:11px;cursor:pointer;"
        onclick="addProject()">+ Add Project</button>
    </div>
  </div>
  </div>
  <section id="noteView" class="panel" style="margin-top:18px;display:none;"></section>
  <div id="graphContainer" aria-label="Knowledge Graph">
    <div class="overlay-card">
      <div class="overlay-header">
        <h2>Knowledge Graph</h2>
        <button class="small-btn" id="closeGraph">Close</button>
      </div>
      <div id="graphToolbar">
        <button class="small-btn" id="rebuildGraph" title="Recompute relationships">Rebuild</button>
        <button class="small-btn" id="centerGraph" title="Re-center view">Center</button>
        <button class="small-btn" id="exportGraph" title="Export graph JSON">Export</button>
        <input type="text" id="graphSearch" placeholder="Filter nodes..." aria-label="Filter graph nodes">
        <span id="graphStatus"></span>
      </div>
      <canvas id="graphCanvas" width="1000" height="420"></canvas>
      <div id="graphLegend"></div>
    </div>
  </div>
  <div id="genericOverlay" class="overlay-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="overlay-card">
      <div class="overlay-header">
        <h2 id="genericOverlayTitle">Overlay</h2>
        <button class="small-btn" id="closeGeneric">Close</button>
      </div>
      <div id="genericOverlayContent"></div>
    </div>
  </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script>
    // Enterprise PKM System - Global State & Architecture
    let files = [];
    let notes = [];
    let concepts = [];
    let projects = [];
    let tasks = [];
    let semIndex = {}; // name -> sem id
    let graph = { nodes: [], edges: [] };
    let sim = { running: false };
    const SEM_KEY = 'sem_ids_v1';
    let backlinksMap = {}; // sem -> inbound references
    const DASH_STATE_KEY = 'pkm_ui_state_v1';
    const GOALS_STATE_KEY = 'pkm_goals_state_v1';
    let currentVaultPath = null; // Track current vault for user identification

    // Enterprise Architecture Components
    let performanceMonitor = null;
    let stateManager = null;
    let currentNotes = []; // Alias for backward compatibility

    // Initialize Enterprise Architecture
    function initializeEnterpriseArchitecture() {
      try {
        // Initialize performance monitoring
        if (window.PKMPerformanceMonitor) {
          performanceMonitor = new window.PKMPerformanceMonitor();
          console.log('✅ Performance monitoring initialized');
        }

        // Initialize state management
        if (window.PKMStateManager) {
          try {
            stateManager = new window.PKMStateManager();

            // Subscribe to state changes
            stateManager.subscribe((action, newState, prevState) => {
              handleStateChange(action, newState, prevState);
            });

            console.log('✅ State management initialized');
          } catch (error) {
            console.error('❌ State manager initialization failed:', error);

            // If IndexedDB object store error, try to reset and reinitialize
            if (error.message && error.message.includes('object store')) {
              console.warn('🔧 Attempting to reset corrupted IndexedDB...');

              // Reset IndexedDB and try again
              if (window.PKMStateManager && stateManager && stateManager.persistenceManager) {
                stateManager.persistenceManager.resetIndexedDB()
                  .then(() => {
                    console.log('✅ IndexedDB reset complete, reinitializing...');
                    stateManager = new window.PKMStateManager();
                    stateManager.subscribe((action, newState, prevState) => {
                      handleStateChange(action, newState, prevState);
                    });
                  })
                  .catch(resetError => {
                    console.error('❌ Failed to reset IndexedDB:', resetError);
                    // Continue without state management in worst case
                  });
              }
            }
          }
        }

        // Set up error boundaries for critical functions
        setupErrorBoundaries();

        // Initialize performance-wrapped functions
        setupPerformanceWrappers();

        console.log('🚀 Enterprise PKM architecture initialized successfully');

      } catch (error) {
        console.error('❌ Failed to initialize enterprise architecture:', error);
        // Graceful fallback to basic functionality
      }
    }

    function handleStateChange(action, newState, prevState) {
      try {
        switch (action) {
          case 'SET_NOTES':
            notes = newState.notes;
            currentNotes = notes; // Backward compatibility
            break;

          case 'SET_CURRENT_VAULT':
            currentVaultPath = newState.currentVault;
            break;

          case 'ADD_NOTIFICATION':
            const notification = newState.notifications[newState.notifications.length - 1];
            displayEnterpriseNotification(notification);
            break;

          case 'ERROR_OCCURRED':
            const error = newState.errors[newState.errors.length - 1];
            handleEnterpriseError(error);
            break;
        }
      } catch (error) {
        console.error('Error handling state change:', error);
      }
    }

    function setupErrorBoundaries() {
      // Wrap critical functions with error boundaries
      window.addEventListener('error', (event) => {
        // Check for IndexedDB-specific errors
        if (event.message && event.message.includes('object store')) {
          console.error('🚨 IndexedDB object store error detected:', event.message);
          handleIndexedDBError();
          return;
        }

        if (stateManager) {
          stateManager.dispatch('ERROR_OCCURRED', {
            error: event.message,
            filename: event.filename,
            line: event.lineno,
            context: 'global'
          });
        }
      });

      window.addEventListener('unhandledrejection', (event) => {
        // Check for IndexedDB promise rejections
        const errorMessage = event.reason?.toString() || '';
        if (errorMessage.includes('object store') || errorMessage.includes('IDBDatabase')) {
          console.error('🚨 IndexedDB promise rejection detected:', errorMessage);
          handleIndexedDBError();
          event.preventDefault(); // Prevent default error handling
          return;
        }

        if (stateManager) {
          stateManager.dispatch('ERROR_OCCURRED', {
            error: errorMessage,
            context: 'promise'
          });
        }
      });
    }

    function handleIndexedDBError() {
      console.warn('🔧 Handling IndexedDB error - attempting recovery...');

      // Show user-friendly message
      displayEnterpriseNotification({
        type: 'warning',
        message: 'Database issue detected - attempting automatic recovery...',
        duration: 3000
      });

      // Try to reset and reinitialize IndexedDB
      if (stateManager && stateManager.persistenceManager) {
        stateManager.persistenceManager.resetIndexedDB()
          .then(() => {
            console.log('✅ IndexedDB reset successful');
            displayEnterpriseNotification({
              type: 'success',
              message: 'Database recovered successfully!',
              duration: 2000
            });
          })
          .catch(error => {
            console.error('❌ IndexedDB reset failed:', error);
            displayEnterpriseNotification({
              type: 'error',
              message: 'Database recovery failed - using fallback storage',
              duration: 3000
            });
          });
      }
    }

    function setupPerformanceWrappers() {
      if (!performanceMonitor) return;

      // Wrap search functions
      const originalSearch = window.filterNotes || (() => { });
      window.filterNotes = performanceMonitor.measureSearchPerformance(originalSearch);

      // Wrap render functions
      const originalUpdateInterface = window.updateInterface || (() => { });
      window.updateInterface = performanceMonitor.measureRenderPerformance(originalUpdateInterface);
    }

    function displayEnterpriseNotification(notification) {
      if (window.showNotification) {
        showNotification(notification.message, notification.type || 'info');
      }
    }

    function handleEnterpriseError(error) {
      console.error('Enterprise error:', error);
      if (window.showNotification) {
        showNotification(`System error: ${error.message}`, 'error');
      }
    }

    // Performance monitoring helpers
    function measurePerformance(name, fn) {
      if (!performanceMonitor) return fn;
      return performanceMonitor.measureSearchPerformance(fn);
    }

    function recordMetric(type, data) {
      if (stateManager) {
        stateManager.dispatch('RECORD_PERFORMANCE_METRIC', { type, data });
      }
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeEnterpriseArchitecture);
    } else {
      initializeEnterpriseArchitecture();
    }

    function loadSemCache() {
      try { const raw = localStorage.getItem(SEM_KEY); if (raw) semIndex = JSON.parse(raw); } catch (e) { }
    }
    function saveSemCache() {
      try { localStorage.setItem(SEM_KEY, JSON.stringify(semIndex)); } catch (e) { }
    }
    loadSemCache();

    document.getElementById('chooseFolder').onclick = async () => {
      if (!window.showDirectoryPicker) return alert('Directory Picker not supported in this browser. Use Chrome/Edge or load the ./vault/ folder when served.');
      const dirHandle = await window.showDirectoryPicker();
      currentVaultPath = dirHandle.name; // Set vault path for user identification
      files = [];
      for await (const entry of dirHandle.values()) {
        if (entry.kind === 'file' && entry.name.endsWith('.md')) {
          files.push(await entry.getFile());
        }
      }
      parseFiles();
    };

    document.getElementById('debugLoad').onclick = () => {
      console.log('Debug load clicked...');
      console.log('Current files array:', files);
      console.log('Current notes array:', notes);

      // Force reload
      autoLoadVault().then(() => {
        console.log('Auto load completed');
        console.log('Files now:', files.length);
        console.log('Notes now:', notes.length);
      });
    };

    document.getElementById('loadVault').onclick = async () => {
      // Enhanced load with proper UX and error handling
      const loadingOverlay = showLoadingOverlay('Loading default vault...');

      try {
        await loadVaultByPath('./vault/');
        hideLoadingOverlay(loadingOverlay);
        showNotification('Default vault loaded successfully', 'success');
      } catch (error) {
        hideLoadingOverlay(loadingOverlay);
        showErrorNotification(`Failed to load vault: ${error.message}`);
        console.error('Vault loading error:', error);
      }
    }

    // Loading overlay system for enterprise-level UX
    function showLoadingOverlay(message) {
      const overlay = document.createElement('div');
      overlay.id = 'loadingOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(8, 20, 38, 0.95);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
        font-family: system-ui, -apple-system, sans-serif;
      `;

      overlay.innerHTML = `
        <div style="text-align: center; max-width: 400px; padding: 40px;">
          <div style="width: 60px; height: 60px; border: 3px solid #1e293b; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
          <div id="loadingMessage" style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">${message}</div>
          <div style="font-size: 14px; color: #94a3b8;">Please wait...</div>
        </div>
        <style>
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      `;

      document.body.appendChild(overlay);
      return overlay;
    }

    function updateLoadingMessage(overlay, message) {
      const messageEl = overlay.querySelector('#loadingMessage');
      if (messageEl) {
        messageEl.textContent = message;
      }
    }

    function hideLoadingOverlay(overlay) {
      if (overlay && overlay.parentNode) {
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.3s ease';
        setTimeout(() => overlay.remove(), 300);
      }
    }

    // Error notification system
    function showErrorNotification(message) {
      showNotification(message, 'error');
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        backdrop-filter: blur(10px);
        transform: translateX(100%);
        transition: transform 0.3s ease;
      `;

      // Set colors based on type
      const colors = {
        success: 'background: rgba(34, 197, 94, 0.9); border: 1px solid rgba(34, 197, 94, 0.3);',
        error: 'background: rgba(239, 68, 68, 0.9); border: 1px solid rgba(239, 68, 68, 0.3);',
        warning: 'background: rgba(245, 158, 11, 0.9); border: 1px solid rgba(245, 158, 11, 0.3);',
        info: 'background: rgba(59, 130, 246, 0.9); border: 1px solid rgba(59, 130, 246, 0.3);'
      };

      notification.style.cssText += colors[type] || colors.info;
      notification.textContent = message;

      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 10);

      // Remove after 3 seconds
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // User selector change handler
    document.getElementById('userSelect').onchange = async (e) => {
      const selectedVault = e.target.value;
      if (selectedVault) {
        await loadVaultByPath(selectedVault);
      }
    }

    // Refresh users button handler
    document.getElementById('refreshUsers').onclick = async () => {
      const currentSelected = document.getElementById('userSelect').value;
      await populateUserSelector();

      // Try to restore previous selection
      if (currentSelected) {
        const selectEl = document.getElementById('userSelect');
        if ([...selectEl.options].some(opt => opt.value === currentSelected)) {
          selectEl.value = currentSelected;
        }
      }
    }

    // Detect available vaults and populate user selector
    async function detectAvailableVaults() {
      const vaults = [];

      // Check for vault/
      try {
        const vault1Res = await fetch('./vault/manifest.json');
        if (vault1Res.ok) {
          const manifest1 = await vault1Res.json();
          vaults.push({
            path: './vault/',
            user: manifest1.user || 'Alex',
            title: manifest1.title || "Alex's Developer Vault",
            description: manifest1.description || 'Developer focused PKM system'
          });
        }
      } catch (e) {
        console.log('vault/ not available');
      }

      // Check for vault2/
      try {
        const vault2Res = await fetch('./vault2/manifest.json');
        if (vault2Res.ok) {
          const manifest2 = await vault2Res.json();
          vaults.push({
            path: './vault2/',
            user: manifest2.user || 'Margaret',
            title: manifest2.title || "Margaret's Personal Vault",
            description: manifest2.description || 'Personal and business PKM system'
          });
        }
      } catch (e) {
        console.log('vault2/ not available');
      }

      return vaults;
    }

    // Populate user selector with available vaults
    async function populateUserSelector() {
      const vaults = await detectAvailableVaults();
      const userSelect = document.getElementById('userSelect');

      // Clear existing options except the first placeholder
      while (userSelect.children.length > 1) {
        userSelect.removeChild(userSelect.lastChild);
      }

      // Add vault options
      vaults.forEach(vault => {
        const option = document.createElement('option');
        option.value = vault.path;
        option.textContent = `${vault.user} (${vault.path.replace('./', '').replace('/', '')})`;
        option.title = vault.description;
        userSelect.appendChild(option);
      });

      // Auto-select first vault if available
      if (vaults.length > 0) {
        userSelect.value = vaults[0].path;
        return vaults[0].path;
      }

      return null;
    }

    // Load specific vault by path
    async function loadVaultByPath(vaultPath) {
      try {
        console.log('Loading vault:', vaultPath);

        // Clear semantic system before loading new vault to prevent collisions
        if (window.semanticSystem) {
          window.semanticSystem.clear();
        }

        const statusEl = document.getElementById('loadStatus');
        statusEl.innerHTML = '<span class="loading-spinner"></span>Loading vault...';

        const manifestRes = await fetch(`${vaultPath}manifest.json`);
        if (!manifestRes.ok) {
          throw new Error('Manifest not found');
        }

        const manifest = await manifestRes.json();
        const fileList = manifest.files ? manifest.files.map(f => f.path) :
          await (await fetch(`${vaultPath}manifest.json`)).json(); // fallback to old format

        console.log('Found', fileList.length, 'files in manifest');
        statusEl.innerHTML = `<span class="loading-spinner"></span>Loading ${fileList.length} files...`;
        currentVaultPath = vaultPath; // Set current vault path

        files = [];
        for (let i = 0; i < fileList.length; i++) {
          const fileName = typeof fileList[i] === 'string' ? fileList[i] : fileList[i].path;
          statusEl.innerHTML = `<span class="loading-spinner"></span>Loading ${i + 1}/${fileList.length}: ${fileName}`;

          const res = await fetch(`${vaultPath}${fileName}`);
          if (res.ok) {
            files.push(new File([await res.text()], fileName));
          } else {
            console.warn(`Failed to load ${fileName}`);
          }
        }

        console.log('Loaded', files.length, 'files, parsing...');
        statusEl.innerHTML = `<span class="loading-spinner"></span>Parsing ${files.length} notes...`;

        await parseFiles();

        const userInfo = manifest.user || 'User';
        statusEl.innerHTML = `<span class="status-indicator status-success">✅ ${userInfo}'s vault loaded (${notes.length} notes)</span>`;

        // Show success animation
        setTimeout(() => {
          const indicator = statusEl.querySelector('.status-success');
          if (indicator) {
            indicator.style.transform = 'scale(1.1)';
            setTimeout(() => indicator.style.transform = 'scale(1)', 200);
          }
        }, 100);

        console.log('✅ Vault loaded successfully');

      } catch (e) {
        console.error('Failed to load vault:', e);
        const statusEl = document.getElementById('loadStatus');
        statusEl.innerHTML = '<span class="status-indicator status-error">❌ Failed to load vault</span>';
        showEmptyState();
      }
    }

    // Auto-load vault on page load with enhanced UX
    async function autoLoadVault() {
      // First populate the user selector with available vaults
      const selectedVault = await populateUserSelector();

      if (selectedVault) {
        await loadVaultByPath(selectedVault);
      } else {
        console.log('No vaults available');
        const statusEl = document.getElementById('loadStatus');
        statusEl.innerHTML = '<span class="status-indicator">📁 No vault - use "Choose Folder" to get started</span>';
        showEmptyState();
      }
    }

    function showEmptyState() {
      // Show helpful empty state in new layout
      const pkmContent = document.getElementById('pkmTabContent');
      if (pkmContent) {
        pkmContent.innerHTML = `
          <div class="empty-state">
            <h3>📚 No Vault Loaded</h3>
            <p>Click "Load Vault" to use the sample vault, or "Choose Folder" to select your own markdown files.</p>
          </div>`;
      }

      const tasksContent = document.getElementById('tasksContent');
      if (tasksContent) {
        tasksContent.innerHTML = `
          <div class="empty-state">
            <h3>🎯 No Tasks Yet</h3>
            <p>Load notes with tasks to see goal-driven priorities here.</p>
          </div>`;
      }

      const projectsContent = document.getElementById('projectsContent');
      if (projectsContent) {
        projectsContent.innerHTML = `
          <div class="empty-state">
            <h3>�️ No Projects Yet</h3>
            <p>Load notes to see your projects and goals organized here.</p>
          </div>`;
      }
    }

    // Start auto-loading immediately after DOM elements are available
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, starting auto-load...');
      autoLoadVault();
    });

    // Only start if DOM already loaded and we haven't started yet
    if (document.readyState !== 'loading') {
      console.log('DOM already ready, auto-loading...');
      autoLoadVault();
    }

    // Add sample goals state for demonstration
    setTimeout(() => {
      if (!localStorage.getItem('pkm_goals_state_v1')) {
        const sampleGoalsState = {
          goals: [
            {
              title: "Core Infrastructure",
              subgoals: [
                { t: "Semantic ID system", d: "Implement unique identifiers", done: true },
                { t: "File parsing workflow", d: "Parse markdown frontmatter", done: true },
                { t: "Search functionality", d: "Real-time search across notes", done: false },
                { t: "Tri-column layout", d: "PKM left, tasks middle, goals right", done: true }
              ]
            },
            {
              title: "Personal Knowledge Management",
              subgoals: [
                { t: "Ontology classification", d: "Auto-categorize notes by type", done: true },
                { t: "Backlink system", d: "Track note relationships", done: true },
                { t: "Priority scoring", d: "Goal-driven task prioritization", done: false },
                { t: "Semantic graph", d: "Visual knowledge connections", done: true }
              ]
            },
            {
              title: "Family & Health",
              subgoals: [
                { t: "Family task tracking", d: "Manage household tasks", done: false },
                { t: "Health routine", d: "Track wellness activities", done: false },
                { t: "Travel planning", d: "Organize family trips", done: false }
              ]
            }
          ]
        };
        localStorage.setItem('pkm_goals_state_v1', JSON.stringify(sampleGoalsState));
        renderGoalsSnapshot(); // Re-render goals panel
      }
    }, 1000);

    document.getElementById('search').oninput = function () {
      const query = this.value;
      renderLists(query);
      updateSearchSuggestions(query);
    };

    // Enhanced search with suggestions and wikilinks
    function updateSearchSuggestions(query) {
      const suggestions = document.getElementById('searchSuggestions');
      if (!query || query.length < 2) {
        suggestions.style.display = 'none';
        return;
      }

      const matches = notes.filter(n =>
        n.name.toLowerCase().includes(query.toLowerCase()) ||
        (n.frontmatter.title && n.frontmatter.title.toLowerCase().includes(query.toLowerCase())) ||
        n.content.toLowerCase().includes(query.toLowerCase())
      ).slice(0, 5);

      if (matches.length === 0) {
        suggestions.style.display = 'none';
        return;
      }

      suggestions.innerHTML = matches.map(n =>
        `<div class="suggestion-item" data-name="${n.name}">
          <strong>${n.frontmatter.title || n.name}</strong>
          <div style="font-size:10px;color:var(--muted);margin-top:2px">${n.frontmatter.type || 'note'} • ${n.sem}</div>
        </div>`
      ).join('');

      suggestions.style.display = 'block';

      suggestions.querySelectorAll('.suggestion-item').forEach(item => {
        item.onclick = () => {
          const note = notes.find(n => n.name === item.dataset.name);
          if (note) showNote(note);
          suggestions.style.display = 'none';
          document.getElementById('search').value = '';
        };
      });
    }

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-enhanced')) {
        document.getElementById('searchSuggestions').style.display = 'none';
      }
    });

    function parseFrontmatter(text) {
      const match = text.match(/^---([\s\S]*?)---/);
      if (match) {
        try {
          return jsyaml.load(match[1]);
        } catch (e) { return {}; }
      }
      return {};
    }

    async function parseFiles() {
      console.log('Parsing', files.length, 'files...');
      notes = [];

      for (const file of files) {
        const text = await file.text();
        const frontmatter = parseFrontmatter(text);
        const sem = mintSemanticId(file.name, frontmatter);
        const content = text.replace(/^---([\s\S]*?)---/, '').trim();

        const note = {
          name: file.name,
          text,
          frontmatter,
          content,
          sem,
          tasks: extractTasks(content, file.name)
        };

        notes.push(note);
        semIndex[file.name] = sem;

        // Register with semantic system if available
        if (window.semanticSystem) {
          window.semanticSystem.register(sem, {
            file: file.name,
            title: frontmatter.title || file.name,
            content: content,
            type: frontmatter.type || 'note',
            created: frontmatter.created || new Date().toISOString(),
            modified: frontmatter.modified || new Date().toISOString()
          });
        }
      }

      console.log('Parsed', notes.length, 'notes');
      saveSemCache();

      // Categorize notes
      concepts = notes.filter(n => n.frontmatter.type === 'concept');
      projects = notes.filter(n => n.frontmatter.type === 'project');
      tasks = notes.filter(n => n.frontmatter.type === 'task' || /- \[.\]/.test(n.content));

      // Initialize user-specific systems when vault is loaded
      const currentUser = initializeNewUser(currentVaultPath || 'local');
      if (currentUser) {
        console.log('✅ User systems initialized for:', currentUser.name);
      }

      renderLists();
      buildBacklinks();
      renderOntology();
      renderPriorityCentral();
      renderGoalsSnapshot();

      // Update PKM layout with loaded data
      populatePKMDemo();

      // Log semantic system stats
      if (window.semanticSystem) {
        const stats = window.semanticSystem.getTypeStats();
        console.log('Semantic system initialized with:', stats);
      }
    }

    function slugify(str) { return (str || '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, ''); }
    function mintSemanticId(name, fm) {
      if (fm.sem) {
        // Convert short form to full form if needed
        if (fm.sem.match(/^[a-z]+:[a-z0-9-]+$/)) {
          const [type, id] = fm.sem.split(':');
          return `sem://vault/${type}/${id}`;
        }
        return fm.sem;
      }
      const type = fm.type || 'note';
      const base = slugify(fm.title || name.replace(/\.md$/, ''));
      return `sem://vault/${type}/${base}`;
    }

    function renderLists(search = '') {
      const q = search.toLowerCase();
      const all = notes.filter(n => n.name.toLowerCase().includes(q) || n.content.toLowerCase().includes(q) || JSON.stringify(n.frontmatter).toLowerCase().includes(q));
      // File List
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = `<h3 style='margin-top:0'>All Notes (${all.length})</h3>` + all.map(n => `<div class="list-item" data-name="${n.name}" data-sem="${n.sem}"><div><strong>${highlight(n.frontmatter.title || n.name, q)}</strong><span class="chip">${n.frontmatter.type || 'note'}</span></div><div class="meta">${n.sem}</div><div class="meta">${highlight(n.content.slice(0, 220).replace(/\n/g, ' '), q)}</div></div>`).join('');
      // Concepts
      document.getElementById('conceptList').innerHTML = `<h3>Concepts (${concepts.length})</h3>` + concepts.map(c => `<div class="list-item" data-name="${c.name}" data-sem="${c.sem}"><strong>${highlight(c.frontmatter.title || c.name, q)}</strong><div class="meta">${c.sem}</div><div class="meta">${highlight(c.content.slice(0, 160).replace(/\n/g, ' '), q)}</div></div>`).join('');
      // Projects
      document.getElementById('projectList').innerHTML = `<h3>Projects (${projects.length})</h3>` + projects.map(p => `<div class="list-item" data-name="${p.name}" data-sem="${p.sem}"><strong>${highlight(p.frontmatter.title || p.name, q)}</strong><div class="meta">${renderTasks(p.content)}</div></div>`).join('');
      // Tasks
      const allTasks = notes.flatMap(n => extractTasks(n.content, n.name));
      document.getElementById('taskList').innerHTML = `<h3>Tasks (${allTasks.length})</h3>` + allTasks.map(t => `<div class="list-item ${t.done ? 'task-done' : ''}">${t.text}<div class="meta">${t.note}</div></div>`).join('');

      attachClickHandlers();
    }

    function extractTasks(content, note) {
      const lines = content.split('\n');
      return lines.filter(l => l.match(/^- \[.\]/)).map(l => ({
        text: l.replace(/^- \[.\] /, ''),
        done: l.includes('[x]'),
        note
      }));
    }

    function renderTasks(content) {
      return extractTasks(content, '').map(t => `<span class="meta ${t.done ? 'task-done' : ''}">- ${t.text}</span>`).join(' ');
    }

    function attachClickHandlers() {
      document.querySelectorAll('.list-item').forEach(el => {
        el.onclick = () => {
          const name = el.dataset.name;
          const note = notes.find(n => n.name === name);
          if (note) showNote(note);
        }
      })
    }

    function showNote(note) {
      const view = document.getElementById('noteView');
      view.style.display = 'block';
      const backlinks = (backlinksMap[note.sem] || []).map(id => `<li><a href="#" class="wikilink" data-jump="${id}">${id}</a></li>`).join('') || '<li><em>No backlinks</em></li>';
      const tags = extractTags(note.content);
      const taskStats = `${note.tasks.filter(t => t.done).length}/${note.tasks.length}`;

      const meta = `<ul style='padding-left:18px;font-size:13px;line-height:1.5;margin:6px 0 0'>
        <li>Type: <strong>${note.frontmatter.type || 'note'}</strong></li>
        <li>Semantic ID: <code>${note.sem}</code></li>
        <li>Tasks: <strong>${taskStats}</strong> ${note.tasks.length > 0 ? '(' + (note.tasks.filter(t => t.done).length / note.tasks.length * 100).toFixed(0) + '% complete)' : ''}</li>
        <li>Outbound links: <strong>${(note.frontmatter.links || []).length}</strong></li>
        <li>Backlinks: <strong>${(backlinksMap[note.sem] || []).length}</strong></li>
        ${tags.length > 0 ? `<li>Tags: ${tags.map(tag => `<span class="note-tag">${tag}</span>`).join(' ')}</li>` : ''}
      </ul>`;

      view.innerHTML = `<h2>${note.frontmatter.title || note.name}</h2><div class="meta">${note.sem}</div>
        <div class="tabs">
          <button class="tab-btn active" data-tab="content">Content</button>
          <button class="tab-btn" data-tab="backlinks">Backlinks (${(backlinksMap[note.sem] || []).length})</button>
          <button class="tab-btn" data-tab="meta">Metadata</button>
        </div>
        <div class="note-section" data-section="content">${renderMarkdown(note.content)}</div>
        <div class="note-section" data-section="backlinks" style="display:none"><ul style='margin:4px 0 0 0;padding-left:18px;font-size:13px;'>${backlinks}</ul></div>
        <div class="note-section" data-section="meta" style="display:none">${meta}</div>`;

      // Handle both wikilinks and semantic links
      view.querySelectorAll('.wikilink[data-target], .semantic-link[data-target]').forEach(link => {
        link.onclick = (e) => {
          e.preventDefault();
          const targetNote = notes.find(n => n.name === link.dataset.target);
          if (targetNote) {
            showNote(targetNote);
          } else if (link.dataset.semantic) {
            // Try semantic resolution
            const semTargetNote = notes.find(n => n.sem === link.dataset.semantic);
            if (semTargetNote) showNote(semTargetNote);
          }
        };
      });

      view.querySelectorAll('[data-jump]').forEach(a => { a.onclick = (e) => { e.preventDefault(); const id = a.getAttribute('data-jump'); const target = notes.find(n => n.sem === id); if (target) showNote(target); } });
      view.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => { const tab = btn.getAttribute('data-tab'); view.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b === btn)); view.querySelectorAll('.note-section').forEach(sec => { sec.style.display = sec.getAttribute('data-section') === tab ? 'block' : 'none'; }); };
      });
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      highlightGraphNode(note.sem);
    }

    function renderMarkdown(md) {
      // Enhanced markdown with semantic links and better formatting
      let processed = md
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/^- \[.\] (.*$)/gim, '<div class="task-item">- $1</div>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/#([\w-]+)/g, '<span class="note-tag">#$1</span>') // Hashtags
        .replace(/\[\[(.*?)\]\]/g, (match, linkText) => {
          // Enhanced bidirectional linking with semantic support

          // Check if it's a semantic URI
          if (linkText.startsWith('sem://')) {
            const targetNote = notes.find(n => n.sem === linkText);
            if (targetNote) {
              return `<a href="#" class="semantic-link" data-semantic="${linkText}" data-target="${targetNote.name}">[[${targetNote.frontmatter.title || targetNote.name}]]</a>`;
            } else {
              return `<span class="semantic-link broken" title="Broken semantic link">[[${linkText}]]</span>`;
            }
          }

          // Regular wikilink - find by title or name
          const targetNote = notes.find(n =>
            n.name.toLowerCase().includes(linkText.toLowerCase()) ||
            (n.frontmatter.title && n.frontmatter.title.toLowerCase().includes(linkText.toLowerCase()))
          );

          if (targetNote) {
            return `<a href="#" class="wikilink" data-target="${targetNote.name}">[[${linkText}]]</a>`;
          }

          return `<span class="wikilink broken" title="Broken link">[[${linkText}]]</span>`;
        })
        .replace(/\n{2,}/g, '<br><br>');

      return processed;
    }
    function highlight(text, q) { if (!q) return text; const esc = q.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&'); return text.replace(new RegExp(esc, 'ig'), m => `<mark>${m}</mark>`); }

    function renderPersonaPanel() {
      const panel = document.getElementById('personaPanel');
      const persona = notes.find(n => n.sem === 'person:alex-rivers');
      const relatedProjects = notes.filter(n => ['project', 'task'].includes(n.frontmatter.type));
      function pct(d, t) { return t ? Math.round((d / t) * 100) : 0; }
      const rows = relatedProjects.map(p => { const done = p.tasks.filter(t => t.done).length; const total = p.tasks.length; return `<tr><td style='font-weight:600'>${p.frontmatter.title || p.name}</td><td>${done}/${total}</td><td style='width:120px'><div class='progress-bar-sm'><span style='width:${pct(done, total)}%'></span></div></td><td>${pct(done, total)}%</td></tr>`; });
      const totalDone = relatedProjects.reduce((a, p) => a + p.tasks.filter(t => t.done).length, 0);
      const totalTasks = relatedProjects.reduce((a, p) => a + p.tasks.length, 0);
      panel.innerHTML = `<div class='section-head'><h3>Persona Overview: ${persona ? (persona.frontmatter.title || 'Alex Rivers') : 'Alex Rivers'}</h3></div>
        <div class='meta' style='margin-bottom:8px'>Projects & tasks • ${totalDone}/${totalTasks} complete</div>
        <table class='progress-table'><thead><tr><th>Collection</th><th>Done</th><th colspan='2'>Progress</th></tr></thead><tbody>${rows.join('')}</tbody></table>`;
    }

    function renderStatsPanel() {
      const el = document.getElementById('statsPanel');
      const totalTasks = notes.flatMap(n => n.tasks || []);
      const doneTasks = totalTasks.filter(t => t.done).length;
      el.innerHTML = `<div class='section-head'><h3>Vault Overview</h3><button class='small-btn' style='margin-left:auto' onclick='renderDashboard()'>Refresh</button></div>
        <div class='stat-grid'>
          <div class='stat-card'><h4>Notes</h4><div class='stat-value'>${notes.length}</div><div class='stat-sub'>All markdown files</div></div>
          <div class='stat-card'><h4>Concepts</h4><div class='stat-value'>${concepts.length}</div><div class='stat-sub'>Knowledge concepts</div></div>
          <div class='stat-card'><h4>Projects</h4><div class='stat-value'>${projects.length}</div><div class='stat-sub'>Active projects</div></div>
          <div class='stat-card'><h4>Tasks</h4><div class='stat-value'>${doneTasks}/${totalTasks.length}</div><div class='stat-sub'>Complete / Total</div></div>
          <div class='stat-card'><h4>Graph Nodes</h4><div class='stat-value'>${graph.nodes.length}</div><div class='stat-sub'>Semantic entities</div></div>
          <div class='stat-card'><h4>Graph Edges</h4><div class='stat-value'>${graph.edges.length}</div><div class='stat-sub'>Mention links</div></div>
        </div>`;
    }

    function loadGoalsState() {
      try { const raw = localStorage.getItem(GOALS_STATE_KEY); if (!raw) return null; return JSON.parse(raw); } catch (e) { return null; }
    }

    // User Goals System - extracts personal goals from vault documents
    function loadUserGoals() {
      if (!notes.length) return [];

      // Detect current user from vault structure
      const currentUser = detectCurrentUser();
      if (!currentUser) return getDefaultUserGoals();

      // INTELLIGENT GOAL EXTRACTION from user's .md files
      const extractedGoals = intelligentGoalExtraction();

      if (extractedGoals.length > 0) {
        console.log(`✅ Extracted ${extractedGoals.length} goals from user documents`);
        return extractedGoals;
      }

      // Fallback: Look for specific goal documents
      const userGoalsNote = notes.find(n =>
        n.frontmatter.type === 'personal-goals' ||
        n.name.includes('personal-goals') ||
        n.name.includes('goals') ||
        n.sem?.includes('personal-goals')
      );

      if (userGoalsNote) {
        return parseUserGoalsFromNote(userGoalsNote);
      }

      return getDefaultUserGoals();
    }

    // INTELLIGENT GOAL EXTRACTION - Automatically finds goals in any .md files
    function intelligentGoalExtraction() {
      const goals = [];
      const goalPatterns = [
        /(?:^|\n)[\s]*(?:##\s*)?(?:goals?|objectives?|aims?|targets?|aspirations?)[\s]*:?[\s]*\n((?:[\s]*[-*]\s*.+\n?)+)/gim,
        /(?:^|\n)[\s]*(?:##\s*)?(?:personal|life|career|family|health|business)\s+(?:goals?|objectives?)[\s]*:?[\s]*\n((?:[\s]*[-*]\s*.+\n?)+)/gim,
        /(?:^|\n)[\s]*(?:##\s*)?(?:2024|2025|this year|next year)\s+(?:goals?|plans?)[\s]*:?[\s]*\n((?:[\s]*[-*]\s*.+\n?)+)/gim
      ];

      notes.forEach(note => {
        // Skip system files
        if (note.name.includes('debug') || note.name.includes('test')) return;

        const content = note.content.toLowerCase();

        // Extract from frontmatter goals if available
        if (note.frontmatter && note.frontmatter.goals) {
          const fmGoals = Array.isArray(note.frontmatter.goals) ? note.frontmatter.goals : [note.frontmatter.goals];
          fmGoals.forEach(goal => {
            goals.push({
              title: goal,
              category: note.frontmatter.type || 'general',
              source: note.name,
              priority: 'medium',
              type: 'extracted',
              tasks: [] // Initialize empty tasks array
            });
          });
        }

        // Extract using patterns
        goalPatterns.forEach(pattern => {
          let match;
          while ((match = pattern.exec(note.content)) !== null) {
            const goalText = match[1];
            const goalLines = goalText.split('\n').filter(line => line.trim());

            goalLines.forEach(line => {
              const cleanGoal = line.replace(/^[\s]*[-*]\s*/, '').trim();
              if (cleanGoal.length > 10) { // Filter out very short items
                goals.push({
                  title: cleanGoal,
                  category: detectGoalCategory(cleanGoal, note),
                  source: note.name,
                  priority: detectGoalPriority(cleanGoal),
                  type: 'extracted',
                  tasks: [] // Initialize empty tasks array
                });
              }
            });
          }
        });

        // Extract from project descriptions and tasks
        if (note.frontmatter && note.frontmatter.type === 'project') {
          // Projects are implicit goals
          const projectTitle = note.frontmatter.title ||
            (note.name ? note.name.replace('.md', '') : '') ||
            'Untitled Project';
          goals.push({
            title: projectTitle,
            category: 'project',
            source: note.name || 'unknown',
            priority: note.frontmatter.priority || 'medium',
            type: 'project',
            tasks: note.tasks || [],
            description: note.content ? note.content.substring(0, 200) + '...' : ''
          });
        }

        // Extract business goals from business-related notes
        if (content.includes('business') || content.includes('revenue') || content.includes('customer')) {
          const businessGoalPattern = /(?:grow|increase|build|develop|expand|achieve)\s+([^.!?\n]{10,80})/gim;
          let match;
          while ((match = businessGoalPattern.exec(note.content)) !== null) {
            const goal = match[0].trim();
            if (goal.length > 15) {
              goals.push({
                title: goal,
                category: 'business',
                source: note.name,
                priority: 'high',
                type: 'inferred',
                tasks: [] // Initialize empty tasks array
              });
            }
          }
        }
      });

      // Load goals from manifest if available (for vault2)
      if (currentVaultPath && currentVaultPath.includes('vault2')) {
        const manifestGoals = extractGoalsFromManifest();
        goals.push(...manifestGoals);
      }

      // Deduplicate and organize
      const uniqueGoals = deduplicateGoals(goals);
      return organizeGoalsByCategory(uniqueGoals);
    }

    function extractGoalsFromManifest() {
      // For vault2, we know Margaret's goals are in the manifest
      const manifestGoals = [];
      const goalCategories = {
        personal: [
          "Maintain strong family relationships and create lasting memories",
          "Build successful small sewing business while maintaining quality",
          "Stay healthy and active for many years to come",
          "Continue learning and growing intellectually",
          "Contribute meaningfully to community through volunteer work"
        ],
        business: [
          "Grow Maggie's Stitches to sustainable $3000/month revenue",
          "Develop regular teaching workshop program",
          "Build strong customer base through referrals and quality work",
          "Create efficient studio organization and workflow systems"
        ],
        family: [
          "Be present and supportive for all grandchildren's milestones",
          "Host memorable holiday and birthday celebrations",
          "Coordinate regular family gatherings and traditions",
          "Document family history and stories for future generations"
        ],
        community: [
          "Continue regular volunteer commitments at community center and senior center",
          "Participate actively in church quilting circle and charitable projects",
          "Support local literacy programs through reading volunteer work",
          "Mentor younger sewers and crafters in the community"
        ],
        health: [
          "Maintain regular exercise routine and walking schedule",
          "Keep up with preventive healthcare appointments",
          "Practice good nutrition and mindful eating habits",
          "Balance activity with rest and stress management"
        ]
      };

      Object.entries(goalCategories).forEach(([category, goals]) => {
        goals.forEach(goal => {
          manifestGoals.push({
            title: goal,
            category: category,
            source: 'manifest.json',
            priority: category === 'health' ? 'high' : 'medium',
            type: 'manifest',
            tasks: [] // Initialize empty tasks array
          });
        });
      });

      return manifestGoals;
    }

    function detectGoalCategory(goalText, note) {
      const text = goalText.toLowerCase();
      const noteType = note.frontmatter?.type || '';
      const noteName = note.name.toLowerCase();

      if (text.includes('family') || text.includes('children') || text.includes('grandchildren') || noteName.includes('family')) return 'family';
      if (text.includes('health') || text.includes('exercise') || text.includes('medical') || noteName.includes('health')) return 'health';
      if (text.includes('business') || text.includes('revenue') || text.includes('customer') || noteName.includes('business')) return 'business';
      if (text.includes('community') || text.includes('volunteer') || text.includes('church') || noteName.includes('volunteer')) return 'community';
      if (text.includes('learn') || text.includes('skill') || text.includes('course') || noteName.includes('learn')) return 'learning';
      if (noteType === 'project') return 'project';

      return 'personal';
    }

    function detectGoalPriority(goalText) {
      const text = goalText.toLowerCase();
      if (text.includes('critical') || text.includes('urgent') || text.includes('important') || text.includes('must')) return 'high';
      if (text.includes('nice') || text.includes('eventually') || text.includes('maybe') || text.includes('consider')) return 'low';
      return 'medium';
    }

    function deduplicateGoals(goals) {
      const seen = new Set();
      return goals.filter(goal => {
        if (!goal.title || typeof goal.title !== 'string') {
          console.warn('deduplicateGoals: Goal without valid title:', goal);
          return false; // Filter out goals without valid titles
        }
        const key = goal.title.toLowerCase().substring(0, 50);
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    function organizeGoalsByCategory(goals) {
      const organized = {};
      goals.forEach(goal => {
        if (!organized[goal.category]) {
          organized[goal.category] = [];
        }
        organized[goal.category].push(goal);
      });

      // Sort categories by importance and goals by priority
      const categoryOrder = ['health', 'family', 'business', 'project', 'community', 'learning', 'personal'];
      const result = [];

      categoryOrder.forEach(category => {
        if (organized[category]) {
          result.push({
            category: category,
            goals: organized[category].sort((a, b) => {
              const priorityOrder = { high: 3, medium: 2, low: 1 };
              return priorityOrder[b.priority] - priorityOrder[a.priority];
            })
          });
        }
      });

      return result;
    }

    function detectCurrentUser() {
      // Look for person documents to identify the user
      const personNotes = notes.filter(n => n.frontmatter.type === 'person');
      if (personNotes.length === 1) {
        return {
          name: personNotes[0].frontmatter.title || personNotes[0].name,
          sem: personNotes[0].sem,
          note: personNotes[0]
        };
      }

      // Fallback: look for consistent naming patterns
      const names = notes.map(n => n.name).join(' ');
      if (names.includes('alex')) return { name: 'Alex', sem: 'person:alex' };

      return null;
    }

    function parseUserGoalsFromNote(goalsNote) {
      const content = goalsNote.content;
      const goals = [];

      // Parse markdown structure for goals
      const sections = content.split(/^##\s+/m).slice(1); // Split by ## headers

      sections.forEach(section => {
        const lines = section.split('\n');
        const title = lines[0].trim();
        const tasks = [];

        // Extract tasks from this section
        lines.forEach(line => {
          const taskMatch = line.match(/^- \[ \] (.+)$/);
          if (taskMatch) {
            tasks.push({
              text: taskMatch[1],
              done: false,
              category: title
            });
          }
        });

        if (tasks.length > 0) {
          goals.push({
            title: title,
            category: classifyGoalCategory(title),
            tasks: tasks,
            progress: 0
          });
        }
      });

      return goals;
    }

    function classifyGoalCategory(title) {
      const t = title.toLowerCase();
      if (t.includes('family') || t.includes('relationship')) return 'family';
      if (t.includes('health') || t.includes('fitness') || t.includes('wellness')) return 'health';
      if (t.includes('career') || t.includes('professional') || t.includes('work')) return 'career';
      if (t.includes('learning') || t.includes('education') || t.includes('skill')) return 'learning';
      if (t.includes('financial') || t.includes('money')) return 'financial';
      return 'personal';
    }

    function getDefaultUserGoals() {
      return [
        {
          title: "Health & Wellness",
          category: "health",
          tasks: [
            { text: "Schedule annual checkup", done: false, category: "Health & Wellness" },
            { text: "Establish exercise routine", done: false, category: "Health & Wellness" }
          ],
          progress: 0
        },
        {
          title: "Learning & Growth",
          category: "learning",
          tasks: [
            { text: "Complete online course", done: false, category: "Learning & Growth" },
            { text: "Read 1 book per month", done: false, category: "Learning & Growth" }
          ],
          progress: 0
        }
      ];
    }
    const goalKeywordWeights = { semantic: 6, link: 5, graph: 5, search: 6, markdown: 4, accessibility: 5, performance: 5, security: 6, privacy: 6, ai: 5, embedding: 5, vector: 5, plugin: 4, ontology: 5, address: 6, uri: 4, parse: 5, frontmatter: 5, index: 5, indexing: 5, keyboard: 3, shortcut: 3, caching: 4 };
    function scoreGoalTask(goalIndex, sub) {
      if (sub.done) return -1;
      const text = (sub.t + ' ' + (sub.d || '')).toLowerCase();
      let kw = 0; for (const k in goalKeywordWeights) { if (text.includes(k)) kw += goalKeywordWeights[k]; }
      const foundation = goalIndex < 2 ? 6 : goalIndex < 5 ? 5 : goalIndex < 10 ? 4 : 3;
      const clarity = sub.d && sub.d.length > 10 ? 1 : 0;
      return foundation * 2 + kw + clarity;
    }
    function computeHighLeverage(limit = 5) {
      const state = loadGoalsState(); if (!state) return [];
      const items = []; state.goals.forEach((g, i) => g.subgoals.forEach(s => { const sc = scoreGoalTask(i, s); if (sc > 0) items.push({ score: sc, title: s.t, goal: g.title }); }));
      items.sort((a, b) => b.score - a.score || a.title.localeCompare(b.title));
      return items.slice(0, limit);
    }
    function renderPriorityMini() {
      const el = document.getElementById('priorityPanelMini');
      const items = computeHighLeverage();
      el.innerHTML = `<div class='section-head'><h3>High-Leverage Tasks</h3><button class='small-btn' onclick="window.open('goals.html','_blank')">Open Goals</button></div>` +
        (items.length ? `<ol class='priority-mini-list'>${items.map((p, i) => `<li><span class='rank'>${i + 1}</span><div style='flex:1'><div style='font-weight:600;font-size:12px'>${p.title}</div><div class='meta' style='font-size:11px'>${p.goal}</div></div><span style='font-size:11px;color:var(--muted)'>${p.score.toFixed(1)}</span></li>`).join('')}</ol>` : `<div class='empty-msg'>No goals data yet. Open Goals page to generate priorities.</div>`);
    }
    function renderDashboard() {
      if (!notes.length) { document.getElementById('onboarding').style.display = 'block'; }
      else document.getElementById('onboarding').style.display = 'none';
      renderStatsPanel();
      renderPriorityMini();
      renderPersonaPanel();
    }

    function buildBacklinks() {
      backlinksMap = {}; const semTo = {}; notes.forEach(n => semTo[n.sem] = n);
      notes.forEach(n => {
        const outbound = new Set(); (n.frontmatter.links || []).forEach(l => outbound.add(l));
        notes.forEach(other => { if (other === n) return; if (new RegExp(other.sem.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&'), 'i').test(n.content)) outbound.add(other.sem); });
        n.outbound = [...outbound];
      });
      notes.forEach(n => { n.outbound.forEach(t => { (backlinksMap[t] = backlinksMap[t] || []).push(n.sem); }); });
    }

    // --- Tri Layout Helpers (updated for dual PKM view) ---
    function classify(note) {
      const nm = note.name.toLowerCase();
      if (note.sem.startsWith('person:')) return 'Identity';
      if (nm.includes('bio')) return 'Biography';
      if (nm.includes('career') || nm.includes('research')) return 'Research';
      if (nm.includes('family')) return 'Family';
      if (nm.includes('health')) return 'Health';
      if (nm.includes('ideas')) return 'Ideas';
      if (nm.includes('travel')) return 'Travel';
      if (nm.includes('personal-goals')) return 'Personal Goals';
      if (note.frontmatter.type === 'concept') return 'Concepts';
      if (note.frontmatter.type === 'project') return 'Projects';
      if (nm.includes('meeting')) return 'Meetings';
      return 'Other';
    }

    function extractTags(content) {
      const tagMatches = content.match(/#[\w-]+/g) || [];
      return [...new Set(tagMatches)]; // Remove duplicates
    }

    function renderOntology() {
      // Render the sophisticated conceptual ontology
      renderConceptualOntology();
    }

    function renderConceptualOntology() {
      const panel = document.getElementById('ontologyContent');
      if (!panel) {
        console.warn('ontologyContent element not found');
        return;
      }

      if (!notes.length) {
        panel.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--muted);">
            <div style="font-size: 24px; margin-bottom: 12px;">🧠</div>
            <p style="font-size: 12px; margin: 0;">Load your vault to reveal your conceptual landscape</p>
          </div>`;
        return;
      }

      // Generate conceptual ontology
      const ontology = generateConceptualOntology();

      panel.innerHTML = `
        <div class="ontology-header" style="margin-bottom: 16px;">
          <h3 style="margin: 0 0 8px 0; font-size: 14px; color: var(--accent);">🧠 Conceptual Ontology</h3>
          <p style="margin: 0; font-size: 11px; color: var(--muted);">Your intellectual landscape and thought patterns</p>
        </div>

        <div class="ontology-tabs" style="display: flex; gap: 8px; margin-bottom: 16px;">
          <button class="ontology-tab active" data-tab="domains" style="flex: 1; padding: 6px 8px; font-size: 11px; background: var(--accent); color: #0a0e13; border: none; border-radius: 4px; cursor: pointer;">
            Domains
          </button>
          <button class="ontology-tab" data-tab="patterns" style="flex: 1; padding: 6px 8px; font-size: 11px; background: rgba(255,255,255,0.1); color: white; border: none; border-radius: 4px; cursor: pointer;">
            Patterns
          </button>
          <button class="ontology-tab" data-tab="connections" style="flex: 1; padding: 6px 8px; font-size: 11px; background: rgba(255,255,255,0.1); color: white; border: none; border-radius: 4px; cursor: pointer;">
            Connections
          </button>
        </div>

        <div class="ontology-content">
          <div class="ontology-panel" id="domains-panel">
            ${renderThinkingDomains(ontology.domains)}
          </div>
          <div class="ontology-panel" id="patterns-panel" style="display: none;">
            ${renderCognitivePatterns(ontology.patterns)}
          </div>
          <div class="ontology-panel" id="connections-panel" style="display: none;">
            ${renderConceptualConnections(ontology.connections)}
          </div>
        </div>
      `;

      // Add tab switching functionality
      panel.querySelectorAll('.ontology-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const targetTab = e.target.dataset.tab;

          // Update active tab
          panel.querySelectorAll('.ontology-tab').forEach(t => {
            t.classList.remove('active');
            t.style.background = 'rgba(255,255,255,0.1)';
            t.style.color = 'white';
          });
          e.target.classList.add('active');
          e.target.style.background = 'var(--accent)';
          e.target.style.color = '#0a0e13';

          // Show corresponding panel
          panel.querySelectorAll('.ontology-panel').forEach(p => p.style.display = 'none');
          document.getElementById(`${targetTab}-panel`).style.display = 'block';
        });
      });
    }

    function generateConceptualOntology() {
      console.log('🧠 Generating conceptual ontology from', notes.length, 'notes...');

      // Process notes in batches to avoid overwhelming analysis
      const batches = chunkArray(notes, 15);
      let domains = {};
      let patterns = {};
      let connections = [];

      batches.forEach((batch, batchIndex) => {
        console.log(`Processing batch ${batchIndex + 1}/${batches.length}`);

        const batchAnalysis = analyzeBatch(batch);

        // Merge domains
        Object.entries(batchAnalysis.domains).forEach(([domain, info]) => {
          if (!domains[domain]) {
            domains[domain] = { ...info, notes: [] };
          } else {
            domains[domain].weight += info.weight;
            domains[domain].concepts = [...new Set([...domains[domain].concepts, ...info.concepts])];
          }
          domains[domain].notes.push(...info.notes);
        });

        // Merge patterns
        Object.entries(batchAnalysis.patterns).forEach(([pattern, info]) => {
          if (!patterns[pattern]) {
            patterns[pattern] = { ...info };
          } else {
            patterns[pattern].frequency += info.frequency;
            patterns[pattern].examples.push(...info.examples);
          }
        });

        // Accumulate connections
        connections.push(...batchAnalysis.connections);
      });

      // Post-process and refine the ontology
      const refinedOntology = refineOntology({ domains, patterns, connections });

      console.log('✅ Conceptual ontology generated:', {
        domains: Object.keys(refinedOntology.domains).length,
        patterns: Object.keys(refinedOntology.patterns).length,
        connections: refinedOntology.connections.length
      });

      return refinedOntology;
    }

    function chunkArray(array, chunkSize) {
      const chunks = [];
      for (let i = 0; i < array.length; i += chunkSize) {
        chunks.push(array.slice(i, i + chunkSize));
      }
      return chunks;
    }

    function analyzeBatch(notes) {
      const batchDomains = {};
      const batchPatterns = {};
      const batchConnections = [];

      notes.forEach(note => {
        // Analyze thinking domains
        const noteDomains = extractThinkingDomains(note);
        noteDomains.forEach(domain => {
          if (!batchDomains[domain.name]) {
            batchDomains[domain.name] = {
              weight: 0,
              concepts: [],
              cognitiveStyle: domain.style,
              notes: []
            };
          }
          batchDomains[domain.name].weight += domain.weight;
          batchDomains[domain.name].concepts.push(...domain.concepts);
          batchDomains[domain.name].notes.push({
            title: note.frontmatter?.title || note.name,
            sem: note.sem,
            relevance: domain.weight
          });
        });

        // Analyze cognitive patterns
        const notePatterns = extractCognitivePatterns(note);
        notePatterns.forEach(pattern => {
          if (!batchPatterns[pattern.type]) {
            batchPatterns[pattern.type] = {
              frequency: 0,
              description: pattern.description,
              examples: []
            };
          }
          batchPatterns[pattern.type].frequency += pattern.strength;
          batchPatterns[pattern.type].examples.push({
            note: note.frontmatter?.title || note.name,
            example: pattern.example
          });
        });

        // Extract conceptual connections
        const noteConnections = extractConceptualConnections(note, notes);
        batchConnections.push(...noteConnections);
      });

      return {
        domains: batchDomains,
        patterns: batchPatterns,
        connections: batchConnections
      };
    }

    function extractThinkingDomains(note) {
      const content = (note.content || '').toLowerCase();
      const title = (note.frontmatter?.title || note.name).toLowerCase();
      const type = note.frontmatter?.type || 'note';

      const domains = [];

      // Define sophisticated domain detection patterns
      const domainPatterns = {
        'Cognitive Science': {
          keywords: ['cognition', 'perception', 'memory', 'attention', 'consciousness', 'neural', 'brain', 'psychology', 'cognitive'],
          style: 'empirical-analytical',
          weight: 3
        },
        'Systems Thinking': {
          keywords: ['system', 'complexity', 'emergence', 'feedback', 'holistic', 'interconnected', 'patterns', 'dynamics'],
          style: 'systemic-holistic',
          weight: 2.5
        },
        'Philosophical Inquiry': {
          keywords: ['philosophy', 'ethics', 'epistemology', 'ontology', 'metaphysics', 'meaning', 'truth', 'existence'],
          style: 'reflective-conceptual',
          weight: 2
        },
        'Empirical Research': {
          keywords: ['research', 'study', 'experiment', 'data', 'analysis', 'hypothesis', 'methodology', 'findings'],
          style: 'scientific-empirical',
          weight: 3
        },
        'Creative Practice': {
          keywords: ['creative', 'design', 'art', 'innovation', 'imagination', 'aesthetic', 'beauty', 'expression'],
          style: 'intuitive-creative',
          weight: 2
        },
        'Social Relations': {
          keywords: ['family', 'relationships', 'community', 'social', 'people', 'friends', 'collaboration', 'interaction'],
          style: 'relational-interpersonal',
          weight: 2.5
        },
        'Business Strategy': {
          keywords: ['business', 'strategy', 'market', 'revenue', 'customers', 'growth', 'operations', 'planning'],
          style: 'strategic-analytical',
          weight: 2.5
        },
        'Personal Development': {
          keywords: ['goals', 'growth', 'learning', 'habits', 'skills', 'development', 'improvement', 'reflection'],
          style: 'reflective-aspirational',
          weight: 2
        },
        'Health & Wellness': {
          keywords: ['health', 'wellness', 'fitness', 'nutrition', 'exercise', 'mental health', 'wellbeing', 'body'],
          style: 'embodied-practical',
          weight: 2
        },
        'Technical Innovation': {
          keywords: ['technology', 'software', 'code', 'programming', 'algorithm', 'digital', 'computation', 'innovation'],
          style: 'logical-technical',
          weight: 3
        }
      };

      // Analyze content for domain matches
      Object.entries(domainPatterns).forEach(([domainName, pattern]) => {
        let matchScore = 0;
        let matchedConcepts = [];

        pattern.keywords.forEach(keyword => {
          const keywordRegex = new RegExp(`\\b${keyword}`, 'gi');
          const titleMatches = (title.match(keywordRegex) || []).length;
          const contentMatches = (content.match(keywordRegex) || []).length;

          if (titleMatches > 0) {
            matchScore += titleMatches * 3; // Title matches are more significant
            matchedConcepts.push(keyword);
          }
          if (contentMatches > 0) {
            matchScore += contentMatches;
            if (!matchedConcepts.includes(keyword)) matchedConcepts.push(keyword);
          }
        });

        // Boost score for certain note types
        if (type === 'project' && domainName === 'Business Strategy') matchScore *= 1.5;
        if (type === 'research' && domainName === 'Empirical Research') matchScore *= 1.5;
        if (type === 'concept' && domainName === 'Philosophical Inquiry') matchScore *= 1.5;

        if (matchScore > 0) {
          domains.push({
            name: domainName,
            weight: matchScore * pattern.weight,
            concepts: matchedConcepts,
            style: pattern.style
          });
        }
      });

      return domains.sort((a, b) => b.weight - a.weight);
    }

    function extractCognitivePatterns(note) {
      const content = note.content || '';
      const patterns = [];

      // Pattern detection rules
      const patternRules = {
        'Question-Driven Inquiry': {
          regex: /\?|what if|how might|why does|could we/gi,
          description: 'Frequently poses questions and explores possibilities',
          strength: 1
        },
        'Systems Analysis': {
          regex: /because|therefore|leads to|results in|causes|impacts|influences/gi,
          description: 'Thinks in terms of cause and effect relationships',
          strength: 1.5
        },
        'Structured Thinking': {
          regex: /1\.|2\.|3\.|first|second|third|steps|process|methodology/gi,
          description: 'Organizes thoughts in structured, sequential ways',
          strength: 1.2
        },
        'Comparative Analysis': {
          regex: /vs|versus|compared to|in contrast|however|but|while|whereas/gi,
          description: 'Frequently compares and contrasts different concepts',
          strength: 1.3
        },
        'Future Orientation': {
          regex: /goal|plan|future|next|upcoming|will|target|vision|hope/gi,
          description: 'Focuses on future possibilities and planning',
          strength: 1.1
        },
        'Empirical Grounding': {
          regex: /research shows|studies indicate|evidence suggests|data reveals|according to/gi,
          description: 'Grounds thinking in evidence and research',
          strength: 1.4
        },
        'Reflective Practice': {
          regex: /reflection|learned|realize|understand|insight|discovery|awareness/gi,
          description: 'Engages in metacognitive reflection',
          strength: 1.2
        },
        'Creative Synthesis': {
          regex: /combine|integrate|merge|synthesis|connect|link|relationship/gi,
          description: 'Seeks to combine and synthesize ideas',
          strength: 1.3
        }
      };

      Object.entries(patternRules).forEach(([patternName, rule]) => {
        const matches = content.match(rule.regex) || [];
        if (matches.length > 0) {
          patterns.push({
            type: patternName,
            strength: matches.length * rule.strength,
            description: rule.description,
            example: extractExampleForPattern(content, rule.regex)
          });
        }
      });

      return patterns;
    }

    function extractExampleForPattern(content, regex) {
      const sentences = content.split(/[.!?]+/);
      for (let sentence of sentences) {
        if (regex.test(sentence)) {
          return sentence.trim().substring(0, 100) + '...';
        }
      }
      return '';
    }

    function extractConceptualConnections(note, allNotes) {
      const connections = [];
      const content = note.content || '';
      const noteTitle = note.frontmatter?.title || note.name;

      // Extract explicit links
      const explicitLinks = note.frontmatter?.links || [];
      explicitLinks.forEach(link => {
        connections.push({
          from: noteTitle,
          to: link,
          type: 'explicit-link',
          strength: 3
        });
      });

      // Extract semantic connections based on shared concepts
      const noteKeywords = extractKeywords(content);
      allNotes.forEach(otherNote => {
        if (otherNote.sem === note.sem) return; // Skip self

        const otherKeywords = extractKeywords(otherNote.content || '');
        const sharedKeywords = noteKeywords.filter(k => otherKeywords.includes(k));

        if (sharedKeywords.length >= 2) {
          connections.push({
            from: noteTitle,
            to: otherNote.frontmatter?.title || otherNote.name,
            type: 'semantic-similarity',
            strength: sharedKeywords.length,
            sharedConcepts: sharedKeywords.slice(0, 3)
          });
        }
      });

      return connections;
    }

    function extractKeywords(content) {
      // Extract meaningful keywords from content
      const words = content.toLowerCase()
        .replace(/[^\w\s]/g, ' ')
        .split(/\s+/)
        .filter(word => word.length > 3)
        .filter(word => !['this', 'that', 'with', 'have', 'will', 'been', 'from', 'they', 'know', 'want', 'been', 'good', 'much', 'some', 'time', 'very', 'when', 'come', 'here', 'just', 'like', 'long', 'make', 'many', 'over', 'such', 'take', 'than', 'them', 'well', 'were'].includes(word));

      // Count frequency and return top keywords
      const frequency = {};
      words.forEach(word => frequency[word] = (frequency[word] || 0) + 1);

      return Object.entries(frequency)
        .sort(([, a], [, b]) => b - a)
        .slice(0, 10)
        .map(([word]) => word);
    }

    function refineOntology(rawOntology) {
      // Refine and enhance the raw ontology
      const { domains, patterns, connections } = rawOntology;

      // Sort domains by weight and keep top meaningful ones
      const sortedDomains = Object.entries(domains)
        .sort(([, a], [, b]) => b.weight - a.weight)
        .slice(0, 8)
        .reduce((acc, [domain, info]) => {
          acc[domain] = {
            ...info,
            concepts: [...new Set(info.concepts)].slice(0, 5), // Unique concepts, top 5
            prominence: calculateDomainProminence(info)
          };
          return acc;
        }, {});

      // Sort patterns by frequency
      const sortedPatterns = Object.entries(patterns)
        .sort(([, a], [, b]) => b.frequency - a.frequency)
        .slice(0, 6)
        .reduce((acc, [pattern, info]) => {
          acc[pattern] = {
            ...info,
            examples: info.examples.slice(0, 3) // Top 3 examples
          };
          return acc;
        }, {});

      // Filter and sort connections
      const meaningfulConnections = connections
        .filter(conn => conn.strength >= 2)
        .sort((a, b) => b.strength - a.strength)
        .slice(0, 20);

      return {
        domains: sortedDomains,
        patterns: sortedPatterns,
        connections: meaningfulConnections
      };
    }

    function calculateDomainProminence(domainInfo) {
      const noteCount = domainInfo.notes.length;
      const avgRelevance = domainInfo.notes.reduce((sum, note) => sum + note.relevance, 0) / noteCount;
      const conceptDiversity = domainInfo.concepts.length;

      return {
        intensity: avgRelevance,
        breadth: noteCount,
        depth: conceptDiversity,
        overall: (avgRelevance * 0.4) + (noteCount * 0.3) + (conceptDiversity * 0.3)
      };
    }

    function renderThinkingDomains(domains) {
      if (!domains || Object.keys(domains).length === 0) {
        return `<div style="text-align: center; padding: 20px; color: var(--muted);">
          <p style="font-size: 12px;">No thinking domains detected yet</p>
        </div>`;
      }

      let html = '<div class="thinking-domains">';

      Object.entries(domains).forEach(([domainName, info]) => {
        const prominence = info.prominence;
        const intensityBar = Math.round((prominence.intensity / 10) * 100);
        const breadthBar = Math.round((prominence.breadth / Math.max(...Object.values(domains).map(d => d.notes.length))) * 100);

        // Color coding based on cognitive style
        const styleColors = {
          'empirical-analytical': '#3b82f6',
          'systemic-holistic': '#10b981',
          'reflective-conceptual': '#8b5cf6',
          'scientific-empirical': '#f59e0b',
          'intuitive-creative': '#ec4899',
          'relational-interpersonal': '#06b6d4',
          'strategic-analytical': '#84cc16',
          'reflective-aspirational': '#f97316',
          'embodied-practical': '#14b8a6',
          'logical-technical': '#6366f1'
        };

        const domainColor = styleColors[info.cognitiveStyle] || '#64748b';

        html += `
          <div class="domain-card" style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; border-left: 3px solid ${domainColor};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h4 style="margin: 0; font-size: 13px; color: ${domainColor};">${domainName}</h4>
              <span style="font-size: 11px; color: var(--muted);">${info.notes.length} notes</span>
            </div>

            <div style="margin-bottom: 8px; font-size: 11px; color: var(--muted);">
              <div style="margin-bottom: 4px;">
                <span>Intensity: </span>
                <div style="display: inline-block; width: 60px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; vertical-align: middle;">
                  <div style="width: ${intensityBar}%; height: 100%; background: ${domainColor}; border-radius: 4px;"></div>
                </div>
              </div>
              <div>
                <span>Breadth: </span>
                <div style="display: inline-block; width: 60px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; vertical-align: middle;">
                  <div style="width: ${breadthBar}%; height: 100%; background: ${domainColor}; border-radius: 4px;"></div>
                </div>
              </div>
            </div>

            <div style="margin-bottom: 8px;">
              <span style="font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">${info.cognitiveStyle.replace(/-/g, ' ')}</span>
            </div>

            <div style="margin-bottom: 8px;">
              ${info.concepts.slice(0, 4).map(concept =>
          `<span style="display: inline-block; background: rgba(${hexToRgb(domainColor)}, 0.2); color: ${domainColor}; padding: 2px 6px; margin: 2px 2px 2px 0; border-radius: 3px; font-size: 10px;">${concept}</span>`
        ).join('')}
            </div>

            <button onclick="exploreDomain('${domainName}')" style="width: 100%; padding: 4px; background: rgba(${hexToRgb(domainColor)}, 0.1); border: 1px solid rgba(${hexToRgb(domainColor)}, 0.3); border-radius: 4px; color: ${domainColor}; font-size: 10px; cursor: pointer;">
              Explore ${info.notes.length} Notes
            </button>
          </div>
        `;
      });

      html += '</div>';
      return html;
    }

    function renderCognitivePatterns(patterns) {
      if (!patterns || Object.keys(patterns).length === 0) {
        return `<div style="text-align: center; padding: 20px; color: var(--muted);">
          <p style="font-size: 12px;">No cognitive patterns detected yet</p>
        </div>`;
      }

      let html = '<div class="cognitive-patterns">';

      Object.entries(patterns).forEach(([patternName, info]) => {
        const strength = Math.round((info.frequency / Math.max(...Object.values(patterns).map(p => p.frequency))) * 100);

        html += `
          <div class="pattern-card" style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h4 style="margin: 0; font-size: 13px; color: var(--accent);">${patternName}</h4>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 40px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                  <div style="width: ${strength}%; height: 100%; background: var(--accent); border-radius: 3px;"></div>
                </div>
                <span style="font-size: 10px; color: var(--muted);">${Math.round(info.frequency)}</span>
              </div>
            </div>

            <p style="margin: 0 0 8px 0; font-size: 11px; color: var(--muted); line-height: 1.4;">
              ${info.description}
            </p>

            ${info.examples.length > 0 ? `
              <div style="background: rgba(255,255,255,0.02); padding: 8px; border-radius: 4px; border-left: 2px solid var(--accent);">
                <div style="font-size: 10px; color: var(--accent); margin-bottom: 4px;">Example:</div>
                <div style="font-size: 10px; color: var(--muted); font-style: italic;">"${info.examples[0].example}"</div>
                <div style="font-size: 9px; color: #64748b; margin-top: 2px;">— ${info.examples[0].note}</div>
              </div>
            ` : ''}
          </div>
        `;
      });

      html += '</div>';
      return html;
    }

    function renderConceptualConnections(connections) {
      if (!connections || connections.length === 0) {
        return `<div style="text-align: center; padding: 20px; color: var(--muted);">
          <p style="font-size: 12px;">No conceptual connections detected yet</p>
        </div>`;
      }

      // Group connections by type
      const explicitLinks = connections.filter(c => c.type === 'explicit-link');
      const semanticConnections = connections.filter(c => c.type === 'semantic-similarity');

      let html = '<div class="conceptual-connections">';

      if (explicitLinks.length > 0) {
        html += `
          <div class="connection-group" style="margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px 0; font-size: 12px; color: var(--accent);">🔗 Explicit Links</h4>
            <div style="font-size: 10px; color: var(--muted); margin-bottom: 8px;">Direct connections you've made</div>
            ${explicitLinks.slice(0, 8).map(conn => `
              <div style="padding: 6px 8px; margin-bottom: 4px; background: rgba(255,255,255,0.02); border-radius: 4px; font-size: 11px;">
                <span style="color: #e2e8f0;">${conn.from}</span>
                <span style="color: var(--muted); margin: 0 6px;">→</span>
                <span style="color: #94a3b8;">${conn.to}</span>
              </div>
            `).join('')}
          </div>
        `;
      }

      if (semanticConnections.length > 0) {
        html += `
          <div class="connection-group">
            <h4 style="margin: 0 0 8px 0; font-size: 12px; color: #10b981;">🧠 Semantic Connections</h4>
            <div style="font-size: 10px; color: var(--muted); margin-bottom: 8px;">Ideas that share conceptual themes</div>
            ${semanticConnections.slice(0, 6).map(conn => `
              <div style="padding: 8px; margin-bottom: 6px; background: rgba(255,255,255,0.02); border-radius: 4px; border-left: 2px solid #10b981;">
                <div style="font-size: 11px; margin-bottom: 4px;">
                  <span style="color: #e2e8f0;">${conn.from}</span>
                  <span style="color: var(--muted); margin: 0 6px;">⟷</span>
                  <span style="color: #94a3b8;">${conn.to}</span>
                </div>
                ${conn.sharedConcepts ? `
                  <div style="font-size: 9px; color: #64748b;">
                    Shared: ${conn.sharedConcepts.join(', ')}
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
        `;
      }

      html += '</div>';
      return html;
    }

    // Helper functions
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      if (!result) return '255, 255, 255';
      const r = parseInt(result[1], 16);
      const g = parseInt(result[2], 16);
      const b = parseInt(result[3], 16);
      return `${r}, ${g}, ${b}`;
    }

    function exploreDomain(domainName) {
      showNotification(`Exploring ${domainName} domain...`, 'info');
      // Could implement detailed domain exploration
    }
    function collectOpenTasks() { return notes.flatMap(n => n.tasks.filter(t => !t.done).map(t => ({ ...t, note: n.name, title: n.frontmatter.title || n.name, sem: n.sem }))); }
    function renderPriorityCentral() {
      const panel = document.getElementById('priorityCenter'); if (!panel) return;
      if (!notes.length) {
        panel.innerHTML = `<h3 class='panel-heading'>Today's Focus</h3><p class='meta' style='font-size:12px'>Your most important tasks and priorities.</p>`;
        return;
      }

      const personalTasks = collectPersonalTasks().slice(0, 5); // User's personal tasks
      const allTasks = notes.flatMap(n =>
        n.tasks.filter(t => !t.done && !isSystemTask(t.text)).map(t => ({
          ...t,
          note: n.name,
          title: n.frontmatter.title || n.name,
          category: classify(n),
          priority: calculateTaskPriority(t, n)
        }))
      ).sort((a, b) => b.priority - a.priority).slice(0, 6);

      const taskItems = allTasks.map((t, i) => {
        const priorityColor = i < 2 ? 'var(--accent)' : i < 4 ? '#fbbf24' : '#10b981';
        const priorityText = i < 2 ? 'High priority' : i < 4 ? 'Medium priority' : 'Low priority';
        const dueText = getDueText(t);

        return `<div class="task-item" style="padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;border-left:3px solid ${priorityColor};cursor:pointer;" data-note="${t.note}">
          <div style="font-size:13px;font-weight:500;">${getTaskIcon(t)} ${t.text}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">${dueText} • ${priorityText}</div>
        </div>`;
      }).join('');

      panel.innerHTML = `<h3 class='panel-heading'>Today's Focus</h3>
        <div style="margin-top:10px;">
          ${taskItems || '<div class="empty-state"><p style="color:var(--muted);font-size:12px;">No active tasks found. Load your vault to see priorities.</p></div>'}
        </div>
        <button style="width:100%;margin-top:8px;background:#143046;border:1px solid var(--accent);padding:6px;border-radius:6px;color:var(--accent);font-size:11px;cursor:pointer;">+ Add Task</button>`;

      panel.querySelectorAll('[data-note]').forEach(li =>
        li.onclick = () => {
          const note = notes.find(n => n.name === li.dataset.note);
          if (note) showNote(note);
        }
      );
    }

    function isSystemTask(text) {
      return /software.*system|code.*system|system.*development|debug.*code|implement.*API|refactor.*code|optimize.*performance|test.*suite|infrastructure.*code|development.*task/i.test(text);
    }

    function calculateTaskPriority(task, note) {
      let score = 1;
      if (note.frontmatter.type === 'project') score += 2;
      if (/urgent|important|high|priority|today/i.test(task.text)) score += 3;
      if (/health|family|personal/i.test(note.name)) score += 2;
      return score;
    }

    function getTaskIcon(task) {
      if (/health/i.test(task.text)) return '🏃‍♂️';
      if (/family|personal/i.test(task.text)) return '👨‍👩‍👧‍👦';
      if (/learn|study|research/i.test(task.text)) return '📚';
      if (/write|create|build/i.test(task.text)) return '✍️';
      if (/meeting|call|contact/i.test(task.text)) return '🤝';
      return '📝';
    }

    function getDueText(task) {
      if (/today|urgent/i.test(task.text)) return 'Due today';
      if (/tomorrow|next day/i.test(task.text)) return 'Due tomorrow';
      if (/week|7 days/i.test(task.text)) return 'This week';
      return 'No due date';
    }

    function collectPersonalTasks() {
      const personalGoalsNote = notes.find(n => n.sem === 'project:alex-personal-goals');
      const allPersonalTasks = notes.flatMap(n => {
        if (n.frontmatter.type === 'project' || n.frontmatter.type === 'task' || n.name.includes('family') || n.name.includes('health')) {
          return n.tasks.filter(t => !t.done).map(t => ({
            ...t,
            note: n.name,
            title: n.frontmatter.title || n.name,
            category: classify(n),
            sem: n.sem
          }));
        }
        return [];
      });

      // Sort by priority (family and health first)
      return allPersonalTasks.sort((a, b) => {
        const priorities = { 'Family': 3, 'Health': 2, 'Personal Goals': 1 };
        return (priorities[b.category] || 0) - (priorities[a.category] || 0);
      });
    }
    function renderGoalsSnapshot() {
      const panel = document.getElementById('goalsPanel'); if (!panel) return;

      // Load user's personal goals from vault documents
      const userGoals = loadUserGoals();

      if (!userGoals.length) {
        panel.innerHTML = `<h3 class='panel-heading'>My Goals</h3>
          <p class='meta' style='font-size:12px'>Your personal goals will appear here when you load your vault.</p>
          <div style="margin-top:10px;">
            <div class="goal-placeholder" style="padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;border-left:3px solid var(--muted);">
              <div style="font-size:13px;font-weight:500;color:var(--muted);">📚 Learning Goals</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px;">Will load from your vault</div>
            </div>
            <div class="goal-placeholder" style="padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;border-left:3px solid var(--muted);">
              <div style="font-size:13px;font-weight:500;color:var(--muted);">🏃‍♂️ Health Goals</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px;">Will load from your vault</div>
            </div>
          </div>`;
        return;
      }

      // Calculate progress for each goal
      const goalItems = userGoals.slice(0, 5).map(goal => {
        const totalTasks = (goal.tasks && Array.isArray(goal.tasks)) ? goal.tasks.length : 0;
        const completedTasks = (goal.tasks && Array.isArray(goal.tasks)) ? goal.tasks.filter(t => t.done).length : 0;
        const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

        const categoryColors = {
          'family': '#a3e635',
          'health': '#10b981',
          'career': '#3b82f6',
          'learning': '#8b5cf6',
          'financial': '#f59e0b',
          'personal': '#6b7280'
        };

        const color = categoryColors[goal.category] || '#6b7280';

        return `<div class="goal-item" style="padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;border-left:3px solid ${color};cursor:pointer;" data-goal="${goal.title}">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="font-size:13px;font-weight:500;">${getCategoryIcon(goal.category)} ${goal.title}</div>
            <div style="font-size:11px;color:var(--muted);">${completedTasks}/${totalTasks}</div>
          </div>
          <div style="background:rgba(255,255,255,0.1);height:3px;border-radius:2px;margin-top:4px;overflow:hidden;">
            <div style="background:${color};height:100%;width:${progress}%;border-radius:2px;transition:width 0.3s;"></div>
          </div>
        </div>`;
      }).join('');

      panel.innerHTML = `<h3 class='panel-heading'>My Goals</h3>
        <div style="margin-top:10px;">
          ${goalItems}
        </div>
        <button style="width:100%;margin-top:8px;background:#143046;border:1px solid var(--accent);padding:6px;border-radius:6px;color:var(--accent);font-size:11px;cursor:pointer;" onclick="addNewGoal()">+ Add Goal</button>`;

      // Add click handlers for goal expansion
      panel.querySelectorAll('[data-goal]').forEach(el => {
        el.onclick = () => expandGoalDetails(el.dataset.goal, userGoals);
      });
    }

    function getCategoryIcon(category) {
      const icons = {
        'family': '👨‍👩‍👧‍👦',
        'health': '🏃‍♂️',
        'career': '💼',
        'learning': '📚',
        'financial': '💰',
        'personal': '🎯'
      };
      return icons[category] || '📝';
    }

    function expandGoalDetails(goalTitle, userGoals) {
      const goal = userGoals.find(g => g.title === goalTitle);
      if (!goal) return;

      // Show detailed view in a modal or expanded section
      console.log(`Expanding goal: ${goalTitle}`, goal);
      // TODO: Implement detailed goal view
    }

    function addNewGoal() {
      // TODO: Implement add new goal functionality
      console.log('Add new goal clicked');
    }

    // Multi-User Support System
    function initializeNewUser(vaultPath) {
      console.log('🆕 Initializing new user from vault:', vaultPath);

      // Detect user identity from loaded documents
      const userInfo = detectCurrentUser();
      if (userInfo) {
        console.log('👤 Detected user:', userInfo.name);

        // Create user-specific storage keys
        const userKey = `pkm_user_${userInfo.sem.replace(/[^a-zA-Z0-9]/g, '_')}`;

        // Store user preferences
        localStorage.setItem(userKey + '_profile', JSON.stringify({
          name: userInfo.name,
          sem: userInfo.sem,
          vaultPath: vaultPath,
          initialized: new Date().toISOString(),
          lastAccessed: new Date().toISOString()
        }));

        // Initialize user-specific goal tracking
        initializeUserGoalTracking(userKey, userInfo);

        // Set up user-specific task priorities
        initializeUserTaskPriorities(userKey, userInfo);

        return userInfo;
      }

      return null;
    }

    function initializeUserGoalTracking(userKey, userInfo) {
      // Extract and structure user's personal goals
      const userGoals = loadUserGoals();

      // Create tracking structure for goal progress
      const goalTracking = {
        userId: userInfo.sem,
        goals: userGoals.map(goal => ({
          ...goal,
          id: generateGoalId(goal.title),
          created: new Date().toISOString(),
          lastUpdated: new Date().toISOString(),
          tracking: {
            startDate: new Date().toISOString(),
            targetDate: calculateGoalTargetDate(goal),
            milestones: generateGoalMilestones(goal)
          }
        })),
        categories: [...new Set(userGoals.map(g => g.category))],
        preferences: {
          primaryFocus: detectPrimaryFocus(userGoals),
          updateFrequency: 'weekly',
          reminderSettings: true
        }
      };

      localStorage.setItem(userKey + '_goals', JSON.stringify(goalTracking));
      console.log('✅ User goal tracking initialized:', goalTracking.goals.length, 'goals');
    }

    function initializeUserTaskPriorities(userKey, userInfo) {
      // Analyze user's task patterns and create priority weights
      const allUserTasks = notes.flatMap(n => n.tasks.filter(t => !isSystemTask(t.text)));

      const taskAnalysis = {
        userId: userInfo.sem,
        totalTasks: allUserTasks.length,
        categories: analyzeTaskCategories(allUserTasks),
        urgencyPatterns: analyzeUrgencyPatterns(allUserTasks),
        preferences: {
          workingHours: detectWorkingHours(allUserTasks),
          focusAreas: detectFocusAreas(allUserTasks),
          priorityWeights: calculateUserPriorityWeights(allUserTasks)
        }
      };

      localStorage.setItem(userKey + '_task_analysis', JSON.stringify(taskAnalysis));
      console.log('✅ User task priorities initialized:', taskAnalysis.categories.length, 'categories');
    }

    function generateGoalId(title) {
      if (!title || typeof title !== 'string') {
        console.warn('generateGoalId: Invalid title provided:', title);
        return 'goal_' + Math.random().toString(36).substring(2, 15);
      }
      return 'goal_' + title.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 20);
    }

    function calculateGoalTargetDate(goal) {
      // Estimate target date based on goal complexity and task count
      const baseDate = new Date();
      const taskCount = (goal.tasks && Array.isArray(goal.tasks)) ? goal.tasks.length : 0;
      const estimatedWeeks = Math.max(4, Math.min(52, taskCount * 2));
      baseDate.setDate(baseDate.getDate() + (estimatedWeeks * 7));
      return baseDate.toISOString();
    }

    function generateGoalMilestones(goal) {
      const taskCount = (goal.tasks && Array.isArray(goal.tasks)) ? goal.tasks.length : 0;
      if (taskCount <= 3) return [];

      const milestones = [];
      const tasksPerMilestone = Math.ceil(taskCount / 3);

      for (let i = 1; i <= 3; i++) {
        milestones.push({
          id: `milestone_${i}`,
          title: `Complete ${i * tasksPerMilestone} tasks`,
          targetDate: new Date(Date.now() + (i * 4 * 7 * 24 * 60 * 60 * 1000)).toISOString(),
          completed: false
        });
      }

      return milestones;
    }

    function detectPrimaryFocus(userGoals) {
      const categoryCounts = {};
      userGoals.forEach(goal => {
        const taskCount = (goal.tasks && Array.isArray(goal.tasks)) ? goal.tasks.length : 1;
        categoryCounts[goal.category] = (categoryCounts[goal.category] || 0) + taskCount;
      });

      return Object.entries(categoryCounts)
        .sort(([, a], [, b]) => b - a)[0]?.[0] || 'personal';
    }

    function analyzeTaskCategories(tasks) {
      const categories = {};
      tasks.forEach(task => {
        const category = classifyTaskCategory(task.text);
        categories[category] = (categories[category] || 0) + 1;
      });

      return Object.entries(categories).map(([name, count]) => ({ name, count }));
    }

    function classifyTaskCategory(taskText) {
      const t = taskText.toLowerCase();
      if (t.includes('family') || t.includes('child') || t.includes('partner')) return 'family';
      if (t.includes('health') || t.includes('exercise') || t.includes('doctor')) return 'health';
      if (t.includes('work') || t.includes('career') || t.includes('research')) return 'career';
      if (t.includes('learn') || t.includes('study') || t.includes('course')) return 'learning';
      if (t.includes('money') || t.includes('financial') || t.includes('budget')) return 'financial';
      return 'personal';
    }

    function analyzeUrgencyPatterns(tasks) {
      return {
        highUrgency: tasks.filter(t => /urgent|asap|today|tomorrow/i.test(t.text)).length,
        mediumUrgency: tasks.filter(t => /week|soon|important/i.test(t.text)).length,
        lowUrgency: tasks.filter(t => /someday|maybe|eventually/i.test(t.text)).length
      };
    }

    function detectWorkingHours(tasks) {
      // Simple heuristic - could be enhanced with actual timestamp analysis
      return { start: '09:00', end: '17:00', timezone: 'local' };
    }

    function isStopWord(word) {
      const stopWords = new Set([
        'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by',
        'this', 'that', 'these', 'those', 'i', 'me', 'my', 'we', 'our', 'you', 'your', 'he', 'him',
        'his', 'she', 'her', 'it', 'its', 'they', 'them', 'their', 'be', 'is', 'am', 'are', 'was',
        'were', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could',
        'should', 'may', 'might', 'must', 'can', 'not', 'no', 'yes'
      ]);
      return stopWords.has(word.toLowerCase());
    }

    function detectFocusAreas(tasks) {
      const focusKeywords = {};
      tasks.forEach(task => {
        const words = task.text.toLowerCase().split(/\s+/);
        words.forEach(word => {
          if (word.length > 4 && !isStopWord(word)) {
            focusKeywords[word] = (focusKeywords[word] || 0) + 1;
          }
        });
      });

      return Object.entries(focusKeywords)
        .sort(([, a], [, b]) => b - a)
        .slice(0, 10)
        .map(([word, count]) => ({ keyword: word, frequency: count }));
    }

    function calculateUserPriorityWeights(tasks) {
      const categories = ['family', 'health', 'career', 'learning', 'financial', 'personal'];
      const weights = {};

      categories.forEach(category => {
        const categoryTasks = tasks.filter(t => classifyTaskCategory(t.text) === category);
        weights[category] = Math.max(1, categoryTasks.length / tasks.length * 10);
      });

      return weights;
    }

    // --- Graph Construction ---
    function buildGraph() {
      const map = new Map();
      graph.nodes = notes.map((n, i) => { const node = { id: n.sem, name: n.frontmatter.title || n.name, type: n.frontmatter.type || 'note', idx: i, x: Math.random() * 800, y: Math.random() * 380, vx: 0, vy: 0 }; map.set(n.sem, node); return node; });
      const edges = [];
      // Simple mention linking: if note.content contains another note title or sem id
      for (const a of notes) {
        for (const b of notes) {
          if (a === b) continue;
          const title = (b.frontmatter.title || b.name).replace(/[-/\\^$*+?.()|[\]{}]/g, '');
          const pattern = new RegExp(`(\\b|\\[\\[)${title}(\\b|\\]\\])`, 'i');
          if (pattern.test(a.content)) {
            edges.push({ source: a.sem, target: b.sem, kind: 'mention' });
          }
        }
      }
      // De-duplicate edges
      const uniq = new Set();
      graph.edges = edges.filter(e => { const key = e.source + '=>' + e.target; if (uniq.has(key)) return false; uniq.add(key); return true; });
      document.getElementById('graphStatus').textContent = `${graph.nodes.length} nodes • ${graph.edges.length} edges`;
      buildLegend();
      startSimulation();
      drawGraph();
    }

    function buildLegend() {
      const legend = document.getElementById('graphLegend');
      const types = [...new Set(graph.nodes.map(n => n.type))];
      legend.innerHTML = types.map(t => `<span class="legend-item"><span class="dot" style="background:${colorForType(t)}"></span>${t}</span>`).join('');
    }
    function colorForType(t) { return t === 'concept' ? '#7dd3fc' : t === 'project' ? '#a3e635' : t === 'task' ? '#fb923c' : '#6366f1'; }

    function startSimulation() {
      sim.running = true;
      let iter = 0; const maxIter = 400; // lightweight
      function step() {
        if (!sim.running) return;
        physicsStep();
        drawGraph();
        iter++;
        if (iter < maxIter) requestAnimationFrame(step); else sim.running = false;
      }
      requestAnimationFrame(step);
    }
    function physicsStep() {
      const nodes = graph.nodes; const edges = graph.edges;
      // repulsion
      for (let i = 0; i < nodes.length; i++) {
        for (let j = i + 1; j < nodes.length; j++) {
          const a = nodes[i], b = nodes[j];
          let dx = a.x - b.x, dy = a.y - b.y; let d = Math.sqrt(dx * dx + dy * dy) + 0.01; const rep = 1000 / (d * d);
          a.vx += (dx / d) * rep; a.vy += (dy / d) * rep; b.vx -= (dx / d) * rep; b.vy -= (dy / d) * rep;
        }
      }
      // attraction
      for (const e of edges) {
        const a = graph.nodes.find(n => n.id === e.source); const b = graph.nodes.find(n => n.id === e.target); if (!a || !b) continue;
        let dx = b.x - a.x, dy = b.y - a.y; let d = Math.sqrt(dx * dx + dy * dy) + 0.01; const desired = 140; const k = (d - desired) * 0.02; dx /= d; dy /= d; a.vx += dx * k; a.vy += dy * k; b.vx -= dx * k; b.vy -= dy * k;
      }
      // integrate
      for (const n of nodes) { n.vx *= 0.9; n.vy *= 0.9; n.x += n.vx * 0.02; n.y += n.vy * 0.02; n.x = Math.max(20, Math.min(n.x, 980)); n.y = Math.max(20, Math.min(n.y, 400)); }
    }

    const canvas = document.getElementById('graphCanvas');
    const ctx = canvas.getContext('2d');
    function drawGraph(filter = '') {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 1;
      const lower = filter.toLowerCase();
      for (const e of graph.edges) {
        const a = graph.nodes.find(n => n.id === e.source), b = graph.nodes.find(n => n.id === e.target); if (!a || !b) continue;
        ctx.strokeStyle = 'rgba(125,211,252,0.25)';
        ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
      }
      for (const n of graph.nodes) {
        const highlighted = !lower || n.name.toLowerCase().includes(lower) || n.id.toLowerCase().includes(lower);
        ctx.beginPath(); ctx.fillStyle = highlighted ? colorForType(n.type) : '#1e293b'; ctx.arc(n.x, n.y, highlighted ? 9 : 7, 0, Math.PI * 2); ctx.fill();
        if (highlighted) { ctx.fillStyle = '#cbd5e1'; ctx.font = '11px system-ui'; ctx.fillText(n.name, n.x + 10, n.y + 4); }
      }
    }

    // Node interaction
    let dragNode = null; let offsetX = 0; let offsetY = 0;
    canvas.addEventListener('mousedown', e => {
      const rect = canvas.getBoundingClientRect(); const x = e.clientX - rect.left, y = e.clientY - rect.top;
      for (const n of graph.nodes) { const dx = x - n.x, dy = y - n.y; if (dx * dx + dy * dy < 100) { dragNode = n; offsetX = dx; offsetY = dy; canvas.style.cursor = 'grabbing'; break; } }
    });
    canvas.addEventListener('mousemove', e => { if (!dragNode) return; const rect = canvas.getBoundingClientRect(); dragNode.x = e.clientX - rect.left - offsetX; dragNode.y = e.clientY - rect.top - offsetY; drawGraph(document.getElementById('graphSearch').value); });
    canvas.addEventListener('mouseup', () => { dragNode = null; canvas.style.cursor = 'grab'; });
    canvas.addEventListener('mouseleave', () => { dragNode = null; canvas.style.cursor = 'grab'; });
    canvas.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect(); const x = e.clientX - rect.left, y = e.clientY - rect.top;
      for (const n of graph.nodes) { const dx = x - n.x, dy = y - n.y; if (dx * dx + dy * dy < 100) { const note = notes.find(nn => nn.sem === n.id); if (note) showNote(note); break; } }
    });

    // Graph toolbar listeners (attached if elements exist)
    const graphSearchEl = document.getElementById('graphSearch');
    if (graphSearchEl) graphSearchEl.addEventListener('input', e => drawGraph(e.target.value));
    const rebuildGraphEl = document.getElementById('rebuildGraph'); if (rebuildGraphEl) rebuildGraphEl.onclick = () => { buildGraph(); };
    const centerGraphEl = document.getElementById('centerGraph'); if (centerGraphEl) centerGraphEl.onclick = () => { graph.nodes.forEach((n, i) => { n.x = (canvas.width / 2) + Math.cos(i) * (120 + i % 5 * 10); n.y = (canvas.height / 2) + Math.sin(i) * (120 + i % 7 * 10); }); drawGraph(document.getElementById('graphSearch').value); };
    const exportGraphEl = document.getElementById('exportGraph'); if (exportGraphEl) exportGraphEl.onclick = () => { const data = { nodes: graph.nodes.map(n => ({ id: n.id, name: n.name, type: n.type })), edges: graph.edges }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'graph.json'; a.click(); URL.revokeObjectURL(url); };

    function highlightGraphNode(sem) {
      // subtle pulse by drawing once with outline (simplified)
      // find node and redraw
      drawGraph(document.getElementById('graphSearch').value);
      const node = graph.nodes.find(n => n.id === sem); if (!node) return; ctx.beginPath(); ctx.strokeStyle = varAccent(); ctx.lineWidth = 3; ctx.arc(node.x, node.y, 14, 0, Math.PI * 2); ctx.stroke(); ctx.lineWidth = 1;
    }
    function varAccent() { return getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#7dd3fc'; }

    // Overlay openers
    const graphOpenBtn = document.getElementById('openGraph');
    if (graphOpenBtn) graphOpenBtn.onclick = () => { const gc = document.getElementById('graphContainer'); gc.style.display = 'flex'; if (graph.nodes.length === 0) buildGraph(); };
    const graphCloseBtn = document.getElementById('closeGraph');
    if (graphCloseBtn) graphCloseBtn.onclick = () => { document.getElementById('graphContainer').style.display = 'none'; };

    function buildStatsHTML() {
      const totalTasks = notes.flatMap(n => n.tasks || []);
      const doneTasks = totalTasks.filter(t => t.done).length;
      return `<div class='stat-grid'>
          <div class='stat-card'><h4>Notes</h4><div class='stat-value'>${notes.length}</div><div class='stat-sub'>All markdown files</div></div>
          <div class='stat-card'><h4>Concepts</h4><div class='stat-value'>${concepts.length}</div><div class='stat-sub'>Knowledge concepts</div></div>
          <div class='stat-card'><h4>Projects</h4><div class='stat-value'>${projects.length}</div><div class='stat-sub'>Active projects</div></div>
          <div class='stat-card'><h4>Tasks</h4><div class='stat-value'>${doneTasks}/${totalTasks.length}</div><div class='stat-sub'>Complete / Total</div></div>
          <div class='stat-card'><h4>Graph Nodes</h4><div class='stat-value'>${graph.nodes.length}</div><div class='stat-sub'>Semantic entities</div></div>
          <div class='stat-card'><h4>Graph Edges</h4><div class='stat-value'>${graph.edges.length}</div><div class='stat-sub'>Mention links</div></div>
        </div>`;
    }
    function buildPersonaHTML() {
      const persona = notes.find(n => n.sem === 'person:alex-rivers');
      const relatedProjects = notes.filter(n => ['project', 'task'].includes(n.frontmatter.type));
      function pct(d, t) { return t ? Math.round((d / t) * 100) : 0; }
      const rows = relatedProjects.map(p => { const done = p.tasks.filter(t => t.done).length; const total = p.tasks.length; return `<tr><td style='font-weight:600'>${p.frontmatter.title || p.name}</td><td>${done}/${total}</td><td style='width:120px'><div class='progress-bar-sm'><span style='width:${pct(done, total)}%'></span></div></td><td>${pct(done, total)}%</td></tr>`; }).join('');
      const totalDone = relatedProjects.reduce((a, p) => a + p.tasks.filter(t => t.done).length, 0);
      const totalTasks = relatedProjects.reduce((a, p) => a + p.tasks.length, 0);
      return `<div class='section-head'><h3 style='margin:0'>Persona Overview: ${persona ? (persona.frontmatter.title || 'Alex Rivers') : 'Alex Rivers'}</h3></div>
        <div class='meta' style='margin-bottom:8px'>Projects & tasks • ${totalDone}/${totalTasks} complete</div>
        <table class='progress-table'><thead><tr><th>Collection</th><th>Done</th><th colspan='2'>Progress</th></tr></thead><tbody>${rows}</tbody></table>`;
    }
    function openGenericOverlay(title, html) {
      const ov = document.getElementById('genericOverlay');
      document.getElementById('genericOverlayTitle').textContent = title;
      document.getElementById('genericOverlayContent').innerHTML = html;
      ov.style.display = 'flex';
    }
    const personaBtn = document.getElementById('openPersona'); if (personaBtn) personaBtn.onclick = () => openGenericOverlay('Persona Overview', buildPersonaHTML());
    const statsBtn = document.getElementById('openStats'); if (statsBtn) statsBtn.onclick = () => openGenericOverlay('Vault Statistics', buildStatsHTML());
    const closeGeneric = document.getElementById('closeGeneric'); if (closeGeneric) closeGeneric.onclick = () => { document.getElementById('genericOverlay').style.display = 'none'; };

    // PKM Tree View Implementation
    let treeState = {}; // Track expanded/collapsed state

    function renderPkmTreeView() {
      const panel = document.getElementById('ontologyContent');
      if (!panel) {
        console.warn('ontologyContent element not found, skipping PKM tree view');
        return;
      }

      if (!notes.length) {
        panel.innerHTML = `<p class='meta' style='font-size:12px'>Load the vault to explore the knowledge tree.</p>`;
        return;
      }

      // Build tree structure
      const tree = buildKnowledgeTree();

      panel.innerHTML = `
        <input type="text" class="tree-search" placeholder="🔍 Search knowledge..." id="treeSearch" style="width:100%;margin-bottom:12px;padding:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:var(--text);font-size:12px;">
        <div class="tree-container" id="treeContainer">${renderTreeNodes(tree)}</div>
      `;

      // Add search functionality
      const searchInput = document.getElementById('treeSearch');
      searchInput.addEventListener('input', (e) => {
        filterTree(e.target.value);
      });

      // Add click handlers
      attachTreeHandlers();
    }

    function buildKnowledgeTree() {
      const groups = {};
      notes.forEach(n => {
        const category = classifyForTree(n);
        if (!groups[category]) groups[category] = [];
        groups[category].push(n);
      });

      // Sort categories and notes within categories
      const sortedTree = {};
      const categoryOrder = ['Identity', 'Biography', 'Research', 'Concepts', 'Projects', 'Ideas', 'Family', 'Health', 'Travel', 'Meetings', 'Personal Goals', 'Other'];

      categoryOrder.forEach(cat => {
        if (groups[cat] && groups[cat].length > 0) {
          sortedTree[cat] = groups[cat].sort((a, b) => {
            const aTitle = a.frontmatter.title || a.name;
            const bTitle = b.frontmatter.title || b.name;
            return aTitle.localeCompare(bTitle);
          });
        }
      });

      return sortedTree;
    }

    function classifyForTree(note) {
      const nm = note.name.toLowerCase();
      const type = note.frontmatter.type;

      if (note.sem.startsWith('person:')) return 'Identity';
      if (nm.includes('bio')) return 'Biography';
      if (nm.includes('career') || nm.includes('research')) return 'Research';
      if (type === 'concept' || nm.includes('concept')) return 'Concepts';
      if (type === 'project' || nm.includes('project')) return 'Projects';
      if (nm.includes('ideas')) return 'Ideas';
      if (nm.includes('family')) return 'Family';
      if (nm.includes('health')) return 'Health';
      if (nm.includes('travel')) return 'Travel';
      if (nm.includes('meeting')) return 'Meetings';
      if (nm.includes('personal-goals')) return 'Personal Goals';
      return 'Other';
    }

    function renderTreeNodes(tree) {
      let html = '';

      Object.entries(tree).forEach(([category, notes]) => {
        const categoryId = category.toLowerCase().replace(/\s+/g, '-');
        const isExpanded = treeState[categoryId] !== false; // Default to expanded
        const icon = getCategoryIcon(category);

        html += `
          <div class="tree-category">
            <div class="tree-item" data-category="${categoryId}">
              <span class="tree-toggle ${isExpanded ? 'expanded' : ''}" data-toggle="${categoryId}">▶</span>
              <span class="tree-icon">${icon}</span>
              <span class="tree-label">${category}</span>
              <span class="tree-count">${notes.length}</span>
            </div>
            <ul class="tree-children ${isExpanded ? 'expanded' : ''}" id="tree-${categoryId}">
        `;

        notes.forEach(note => {
          const backlinks = (backlinksMap[note.sem] || []).length;
          const noteIcon = getNoteIcon(note);
          const isPersonalGoal = note.sem === 'project:alex-personal-goals';

          html += `
            <li class="tree-item ${isPersonalGoal ? 'selected' : ''}" data-note="${note.name}" data-type="${note.frontmatter.type || 'note'}">
              <span class="tree-toggle leaf">•</span>
              <span class="tree-icon">${noteIcon}</span>
              <span class="tree-label" title="${note.frontmatter.title || note.name}">${note.frontmatter.title || note.name}</span>
              ${backlinks > 0 ? `<span class="tree-meta">${backlinks}↗</span>` : ''}
            </li>
          `;
        });

        html += `
            </ul>
          </div>
        `;
      });

      return html;
    }

    function getCategoryIcon(category) {
      const icons = {
        'Identity': '👤',
        'Biography': '📖',
        'Research': '🔬',
        'Concepts': '💡',
        'Projects': '🚀',
        'Ideas': '💭',
        'Family': '👨‍👩‍👧‍👦',
        'Health': '🏃‍♂️',
        'Travel': '✈️',
        'Meetings': '📅',
        'Personal Goals': '🎯',
        'Other': '📄'
      };
      return icons[category] || '📄';
    }

    function getNoteIcon(note) {
      const type = note.frontmatter.type;
      if (type === 'person') return '👤';
      if (type === 'concept') return '💡';
      if (type === 'project') return '🚀';
      if (type === 'task') return '✅';
      if (note.name.includes('meeting')) return '📅';
      if (note.name.includes('travel')) return '✈️';
      if (note.name.includes('health')) return '🏃‍♂️';
      if (note.name.includes('family')) return '👨‍👩‍👧‍👦';
      if (note.name.includes('idea')) return '💭';
      return '📄';
    }

    function attachTreeHandlers() {
      // Category toggle handlers
      document.querySelectorAll('[data-toggle]').forEach(toggle => {
        toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          const categoryId = toggle.dataset.toggle;
          const children = document.getElementById(`tree-${categoryId}`);
          const isExpanded = children.classList.contains('expanded');

          if (isExpanded) {
            children.classList.remove('expanded');
            toggle.classList.remove('expanded');
            treeState[categoryId] = false;
          } else {
            children.classList.add('expanded');
            toggle.classList.add('expanded');
            treeState[categoryId] = true;
          }
        });
      });

      // Note click handlers
      document.querySelectorAll('[data-note]').forEach(item => {
        item.addEventListener('click', () => {
          const noteName = item.dataset.note;
          const note = notes.find(n => n.name === noteName);
          if (note) {
            // Remove previous selection
            document.querySelectorAll('.tree-item.selected').forEach(el => {
              if (!el.dataset.note || el.dataset.note !== noteName) {
                el.classList.remove('selected');
              }
            });
            // Add selection to clicked item
            item.classList.add('selected');
            showNote(note);
          }
        });
      });
    }

    function filterTree(query) {
      const container = document.getElementById('treeContainer');
      if (!container) return;

      if (!query.trim()) {
        // Show all items
        container.querySelectorAll('.tree-item, .tree-children').forEach(el => {
          el.style.display = '';
        });
        return;
      }

      const searchLower = query.toLowerCase();
      const matchingNotes = notes.filter(note => {
        const title = (note.frontmatter.title || note.name).toLowerCase();
        const content = note.content.toLowerCase();
        const sem = note.sem.toLowerCase();
        return title.includes(searchLower) || content.includes(searchLower) || sem.includes(searchLower);
      });

      // Hide all note items first
      container.querySelectorAll('[data-note]').forEach(item => {
        item.style.display = 'none';
      });

      // Show matching notes and their categories
      const visibleCategories = new Set();
      matchingNotes.forEach(note => {
        const noteItem = container.querySelector(`[data-note="${note.name}"]`);
        if (noteItem) {
          noteItem.style.display = '';
          const category = noteItem.closest('[data-category]');
          if (category) {
            const categoryId = category.dataset.category;
            visibleCategories.add(categoryId);
          }
        }
      });

      // Show/hide categories based on whether they have visible notes
      container.querySelectorAll('[data-category]').forEach(catItem => {
        const categoryId = catItem.dataset.category;
        const children = document.getElementById(`tree-${categoryId}`);
        const hasVisibleNotes = children.querySelector('[data-note][style=""], [data-note]:not([style])');

        if (visibleCategories.has(categoryId) && hasVisibleNotes) {
          catItem.style.display = '';
          children.style.display = 'block';
          children.classList.add('expanded');
          catItem.querySelector('.tree-toggle').classList.add('expanded');
        } else {
          catItem.style.display = query.trim() ? 'none' : '';
        }
      });
    }

    // Navigation - simplified for tri-layout only
    // Legacy view switching removed - tri-layout is primary view

    // Enhanced search with proper debouncing and UX improvements
    document.getElementById('search').addEventListener('focus', () => {
      // Focus search but keep tri-layout visible
    });

    let searchTimeout;
    document.getElementById('search').addEventListener('input', e => {
      const tri = document.getElementById('triLayout');
      const query = e.target.value.toLowerCase();

      // Clear previous timeout
      clearTimeout(searchTimeout);

      // Show loading state for longer queries
      if (query.length > 2) {
        const suggestions = document.getElementById('searchSuggestions');
        suggestions.innerHTML = '<div style="padding:8px;color:#64748b;font-size:12px;">🔍 Searching...</div>';
        suggestions.style.display = 'block';
      }

      // Debounced search execution
      searchTimeout = setTimeout(() => {
        try {
          if (tri && tri.style.display === 'grid') {
            const matchCount = performSearch(query);
            updateSearchFeedback(query, matchCount);
          }
        } catch (error) {
          showErrorNotification('Search failed: ' + error.message);
          console.error('Search error:', error);
        }
      }, 150); // Faster debounce for better UX
    });

    function performSearch(query) {
      let matchCount = 0;
      document.querySelectorAll('#ontologyPanel .note-link').forEach(el => {
        const txt = el.textContent.toLowerCase();
        const matches = !query || txt.includes(query);
        el.style.display = matches ? 'block' : 'none';
        if (matches && query) matchCount++;
      });
      return matchCount;
    }

    function updateSearchFeedback(query, matchCount) {
      const suggestions = document.getElementById('searchSuggestions');
      if (query.length > 0) {
        suggestions.innerHTML = `<div style="padding:8px;color:#64748b;font-size:12px;">Found ${matchCount} result${matchCount !== 1 ? 's' : ''}</div>`;
        suggestions.style.display = 'block';

        // Auto-hide after 2 seconds
        setTimeout(() => {
          suggestions.style.display = 'none';
        }, 2000);
      } else {
        suggestions.style.display = 'none';
      }
    }

    // Add keyboard shortcuts (enterprise-level UX)
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + K for search focus
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const searchInput = document.getElementById('search');
        searchInput.focus();
        searchInput.select();
        showNotification('Search focused (Ctrl+K)', 'success');
      }

      // Escape to clear search
      if (e.key === 'Escape') {
        const searchInput = document.getElementById('search');
        if (document.activeElement === searchInput) {
          searchInput.value = '';
          performSearch('');
          updateSearchFeedback('', 0);
          showNotification('Search cleared', 'info');
        }
      }
    });

    // Error notification system
    function showErrorNotification(message) {
      showNotification(message, 'error');
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        backdrop-filter: blur(10px);
        transform: translateX(100%);
        transition: transform 0.3s ease;
      `;

      // Set colors based on type
      const colors = {
        success: 'background: rgba(34, 197, 94, 0.9); border: 1px solid rgba(34, 197, 94, 0.3);',
        error: 'background: rgba(239, 68, 68, 0.9); border: 1px solid rgba(239, 68, 68, 0.3);',
        warning: 'background: rgba(245, 158, 11, 0.9); border: 1px solid rgba(245, 158, 11, 0.3);',
        info: 'background: rgba(59, 130, 246, 0.9); border: 1px solid rgba(59, 130, 246, 0.3);'
      };

      notification.style.cssText += colors[type] || colors.info;
      notification.textContent = message;

      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 10);

      // Remove after 3 seconds
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Developer menu functionality
    document.getElementById('devMenu')?.addEventListener('click', (e) => {
      e.stopPropagation();
      const dropdown = document.getElementById('devMenuDropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    });

    // Close developer menu when clicking outside
    document.addEventListener('click', () => {
      const dropdown = document.getElementById('devMenuDropdown');
      if (dropdown) dropdown.style.display = 'none';
    });

    // REVOLUTIONARY AI-POWERED PKM SYSTEM
    let aiInsights = {
      patterns: new Map(),
      recommendations: new Set(),
      learningModel: new Map(),
      contextAwareness: new Map()
    };

    // Neural Pattern Recognition for Knowledge Discovery
    function initializeNeuralPatterns() {
      console.log('🧠 Initializing Neural Pattern Recognition...');

      // Analyze user behavior patterns
      analyzeUserBehaviorPatterns();

      // Build semantic relationship matrix
      buildSemanticRelationshipMatrix();

      // Initialize contextual awareness engine
      initializeContextualAwareness();

      console.log('✅ Neural patterns initialized with', aiInsights.patterns.size, 'detected patterns');
    }

    function analyzeUserBehaviorPatterns() {
      const patterns = [];

      // Reading patterns analysis
      const readingFrequency = analyzeReadingFrequency();
      patterns.push({ type: 'reading', data: readingFrequency });

      // Content creation patterns
      const creationPatterns = analyzeContentCreation();
      patterns.push({ type: 'creation', data: creationPatterns });

      // Goal pursuit patterns
      const goalPatterns = analyzeGoalPursuitBehavior();
      patterns.push({ type: 'goals', data: goalPatterns });

      // Task completion patterns
      const taskPatterns = analyzeTaskCompletionBehavior();
      patterns.push({ type: 'tasks', data: taskPatterns });

      patterns.forEach(pattern => {
        aiInsights.patterns.set(pattern.type, pattern.data);
      });
    }

    function analyzeReadingFrequency() {
      const noteInteractions = notes.map(note => ({
        note: note.name,
        complexity: calculateContentComplexity(note.content),
        connections: (backlinksMap[note.sem] || []).length,
        category: classify(note),
        lastAccessed: localStorage.getItem(`note_access_${note.sem}`) || 'never'
      }));

      return {
        preferredComplexity: noteInteractions.reduce((avg, n) => avg + n.complexity, 0) / noteInteractions.length,
        connectionPreference: noteInteractions.reduce((avg, n) => avg + n.connections, 0) / noteInteractions.length,
        categoryPreferences: groupBy(noteInteractions, 'category')
      };
    }

    function calculateContentComplexity(content) {
      const factors = {
        length: content.length / 1000,
        sentences: (content.match(/[.!?]+/g) || []).length,
        concepts: (content.match(/\[\[.*?\]\]/g) || []).length,
        codeBlocks: (content.match(/```[\s\S]*?```/g) || []).length,
        lists: (content.match(/^[\s]*[-*]\s/gm) || []).length
      };

      return (factors.length * 0.3 + factors.sentences * 0.2 +
        factors.concepts * 0.25 + factors.codeBlocks * 0.15 +
        factors.lists * 0.1);
    }

    function analyzeContentCreation() {
      const creationMetrics = {
        averageNoteLength: notes.reduce((sum, n) => sum + n.content.length, 0) / notes.length,
        conceptDensity: concepts.length / notes.length,
        linkingBehavior: notes.reduce((sum, n) => sum + (n.content.match(/\[\[.*?\]\]/g) || []).length, 0) / notes.length,
        categoryDistribution: groupBy(notes, note => classify(note))
      };

      return creationMetrics;
    }

    function analyzeGoalPursuitBehavior() {
      const userGoals = loadUserGoals();
      if (!userGoals.length) return { status: 'no_goals_detected' };

      const goalMetrics = {
        primaryFocusAreas: userGoals.map(cat => cat.category),
        goalsPerCategory: userGoals.reduce((acc, cat) => { acc[cat.category] = cat.goals.length; return acc; }, {}),
        completionPatterns: userGoals.map(cat => ({
          category: cat.category,
          avgProgress: cat.goals.reduce((sum, g) => sum + calculateGoalProgress(g), 0) / cat.goals.length
        })),
        timeHorizons: detectTimeHorizons(userGoals)
      };

      return goalMetrics;
    }

    function analyzeTaskCompletionBehavior() {
      const allTasks = notes.flatMap(n => n.tasks || []);
      if (!allTasks.length) return { status: 'no_tasks_detected' };

      const taskMetrics = {
        completionRate: allTasks.filter(t => t.done).length / allTasks.length,
        taskComplexity: allTasks.map(t => t.text.length),
        categoryPreferences: groupBy(allTasks, t => classifyTaskCategory(t.text)),
        urgencyHandling: allTasks.filter(t => /urgent|asap|today/i.test(t.text)).length / allTasks.length
      };

      return taskMetrics;
    }

    function buildSemanticRelationshipMatrix() {
      console.log('🔗 Building semantic relationship matrix...');

      const relationships = new Map();

      notes.forEach(sourceNote => {
        const sourceRelations = new Set();

        notes.forEach(targetNote => {
          if (sourceNote === targetNote) return;

          const relationship = calculateSemanticRelationship(sourceNote, targetNote);
          if (relationship.strength > 0.3) {
            sourceRelations.add({
              target: targetNote.sem,
              strength: relationship.strength,
              type: relationship.type,
              evidence: relationship.evidence
            });
          }
        });

        relationships.set(sourceNote.sem, sourceRelations);
      });

      aiInsights.learningModel.set('relationships', relationships);
      console.log('✅ Built semantic matrix with', relationships.size, 'nodes');
    }

    function calculateSemanticRelationship(note1, note2) {
      let strength = 0;
      let type = 'unknown';
      let evidence = [];

      // Direct link analysis
      if (note1.content.includes(note2.name) || note2.content.includes(note1.name)) {
        strength += 0.4;
        type = 'direct_mention';
        evidence.push('direct_mention');
      }

      // Semantic ID references
      if (note1.content.includes(note2.sem) || note2.content.includes(note1.sem)) {
        strength += 0.5;
        type = 'semantic_link';
        evidence.push('semantic_reference');
      }

      // Category similarity
      if (classify(note1) === classify(note2)) {
        strength += 0.2;
        evidence.push('category_match');
      }

      // Shared concepts analysis
      const sharedConcepts = findSharedConcepts(note1.content, note2.content);
      if (sharedConcepts.length > 0) {
        strength += Math.min(0.3, sharedConcepts.length * 0.1);
        evidence.push(`shared_concepts: ${sharedConcepts.join(', ')}`);
      }

      // Temporal proximity (if both are recent)
      const tempRelation = analyzeTemporalProximity(note1, note2);
      if (tempRelation > 0) {
        strength += tempRelation;
        evidence.push('temporal_proximity');
      }

      return { strength, type, evidence };
    }

    function findSharedConcepts(content1, content2) {
      const concepts1 = extractConcepts(content1);
      const concepts2 = extractConcepts(content2);

      return concepts1.filter(c => concepts2.includes(c));
    }

    function extractConcepts(content) {
      // Extract meaningful concepts using various patterns
      const concepts = [];

      // Wikilinks
      const wikilinks = content.match(/\[\[(.*?)\]\]/g) || [];
      concepts.push(...wikilinks.map(link => link.replace(/\[\[|\]\]/g, '')));

      // Hashtags
      const hashtags = content.match(/#[\w-]+/g) || [];
      concepts.push(...hashtags);

      // Important terms (capitalized, repeated words)
      const words = content.toLowerCase().split(/\s+/);
      const wordFreq = {};
      words.forEach(word => {
        if (word.length > 4 && !isStopWord(word)) {
          wordFreq[word] = (wordFreq[word] || 0) + 1;
        }
      });

      const importantWords = Object.entries(wordFreq)
        .filter(([word, freq]) => freq > 1)
        .map(([word]) => word);

      concepts.push(...importantWords);

      return [...new Set(concepts)];
    }

    function analyzeTemporalProximity(note1, note2) {
      const date1 = note1.frontmatter.created || note1.frontmatter.modified;
      const date2 = note2.frontmatter.created || note2.frontmatter.modified;

      if (!date1 || !date2) return 0;

      const diff = Math.abs(new Date(date1) - new Date(date2));
      const daysDiff = diff / (1000 * 60 * 60 * 24);

      if (daysDiff < 1) return 0.3;
      if (daysDiff < 7) return 0.2;
      if (daysDiff < 30) return 0.1;

      return 0;
    }

    function initializeContextualAwareness() {
      console.log('🎯 Initializing contextual awareness engine...');

      const contexts = new Map();

      // Time-based contexts
      contexts.set('timeOfDay', analyzeTimeBasedPatterns());
      contexts.set('workPatterns', analyzeWorkPatterns());

      // Content-based contexts
      contexts.set('currentFocus', analyzeCurrentFocus());
      contexts.set('recentActivity', analyzeRecentActivity());

      // Goal-based contexts
      contexts.set('goalProximity', analyzeGoalProximity());
      contexts.set('priorities', analyzePriorityPatterns());

      aiInsights.contextAwareness = contexts;
      console.log('✅ Contextual awareness initialized with', contexts.size, 'context types');
    }

    function analyzeTimeBasedPatterns() {
      // Simulate time-based pattern analysis
      const hour = new Date().getHours();

      if (hour >= 6 && hour < 12) return 'morning_focus';
      if (hour >= 12 && hour < 17) return 'afternoon_productivity';
      if (hour >= 17 && hour < 22) return 'evening_review';
      return 'late_night_creativity';
    }

    function analyzeWorkPatterns() {
      const patterns = aiInsights.patterns.get('tasks') || {};

      if (patterns.completionRate > 0.8) return 'high_performer';
      if (patterns.urgencyHandling > 0.5) return 'reactive_mode';
      return 'steady_progress';
    }

    function analyzeCurrentFocus() {
      // Analyze recent note access patterns
      const recentNotes = notes.slice(0, 5); // Simulate recent activity
      const categories = recentNotes.map(n => classify(n));
      const primaryCategory = mode(categories);

      return {
        primaryCategory,
        intensity: categories.filter(c => c === primaryCategory).length / categories.length,
        breadth: new Set(categories).size
      };
    }

    function analyzeRecentActivity() {
      return {
        notesViewed: 5, // Simulated
        averageTimePerNote: 45, // seconds
        searchQueries: 3,
        lastActive: new Date().toISOString()
      };
    }

    function analyzeGoalProximity() {
      const userGoals = loadUserGoals();
      if (!userGoals.length) return { status: 'no_goals' };

      // Find goals with high progress or recent activity
      const activeGoals = userGoals.flatMap(cat =>
        cat.goals.filter(g => calculateGoalProgress(g) > 10 && calculateGoalProgress(g) < 90)
      );

      return {
        activeGoalsCount: activeGoals.length,
        nearCompletion: activeGoals.filter(g => calculateGoalProgress(g) > 70),
        needsAttention: activeGoals.filter(g => calculateGoalProgress(g) < 30)
      };
    }

    function analyzePriorityPatterns() {
      const taskPatterns = aiInsights.patterns.get('tasks') || {};
      const goalPatterns = aiInsights.patterns.get('goals') || {};

      return {
        taskFocus: Object.keys(taskPatterns.categoryPreferences || {}),
        goalFocus: goalPatterns.primaryFocusAreas || [],
        urgencyBias: taskPatterns.urgencyHandling || 0
      };
    }

    // AI-Powered Recommendations Engine
    function generateIntelligentRecommendations() {
      console.log('🤖 Generating AI-powered recommendations...');

      const recommendations = new Set();

      // Content discovery recommendations
      const contentRecs = generateContentRecommendations();
      contentRecs.forEach(rec => recommendations.add(rec));

      // Goal optimization recommendations
      const goalRecs = generateGoalOptimizationRecommendations();
      goalRecs.forEach(rec => recommendations.add(rec));

      // Workflow improvement recommendations
      const workflowRecs = generateWorkflowRecommendations();
      workflowRecs.forEach(rec => recommendations.add(rec));

      // Connection discovery recommendations
      const connectionRecs = generateConnectionRecommendations();
      connectionRecs.forEach(rec => recommendations.add(rec));

      aiInsights.recommendations = recommendations;
      console.log('✅ Generated', recommendations.size, 'intelligent recommendations');

      return Array.from(recommendations);
    }

    function generateContentRecommendations() {
      const recommendations = [];
      const readingPatterns = aiInsights.patterns.get('reading');

      if (readingPatterns) {
        // Recommend notes matching user's complexity preference
        const targetComplexity = readingPatterns.preferredComplexity;
        const candidates = notes.filter(n => {
          const complexity = calculateContentComplexity(n.content);
          return Math.abs(complexity - targetComplexity) < 0.5;
        });

        candidates.slice(0, 3).forEach(note => {
          recommendations.push({
            type: 'content_discovery',
            title: 'Recommended Reading',
            description: `Based on your reading patterns, you might enjoy "${note.frontmatter.title || note.name}"`,
            action: `showNote('${note.name}')`,
            confidence: 0.8,
            icon: '📚'
          });
        });
      }

      return recommendations;
    }

    function generateGoalOptimizationRecommendations() {
      const recommendations = [];
      const goalProximity = aiInsights.contextAwareness.get('goalProximity');

      if (goalProximity && goalProximity.needsAttention) {
        goalProximity.needsAttention.slice(0, 2).forEach(goal => {
          recommendations.push({
            type: 'goal_optimization',
            title: 'Goal Needs Attention',
            description: `"${goal.title}" has low progress. Consider breaking it into smaller tasks.`,
            action: `focusOnGoal('${goal.title}')`,
            confidence: 0.9,
            icon: '🎯'
          });
        });
      }

      return recommendations;
    }

    function generateWorkflowRecommendations() {
      const recommendations = [];
      const workPatterns = aiInsights.contextAwareness.get('workPatterns');
      const timeContext = aiInsights.contextAwareness.get('timeOfDay');

      if (timeContext === 'morning_focus') {
        recommendations.push({
          type: 'workflow_optimization',
          title: 'Morning Focus Time',
          description: 'This is your peak focus time. Consider tackling complex tasks now.',
          action: `showHighPriorityTasks()`,
          confidence: 0.7,
          icon: '🌅'
        });
      }

      if (workPatterns === 'reactive_mode') {
        recommendations.push({
          type: 'workflow_optimization',
          title: 'Reduce Reactive Work',
          description: 'You handle many urgent tasks. Try time-blocking for proactive work.',
          action: `suggestTimeBlocking()`,
          confidence: 0.8,
          icon: '⏰'
        });
      }

      return recommendations;
    }

    function generateConnectionRecommendations() {
      const recommendations = [];
      const relationships = aiInsights.learningModel.get('relationships');

      if (relationships) {
        // Find potential connections not yet made
        const unconnectedPairs = findUnconnectedButRelated();

        unconnectedPairs.slice(0, 2).forEach(pair => {
          recommendations.push({
            type: 'connection_discovery',
            title: 'Hidden Connection',
            description: `"${pair.note1}" and "${pair.note2}" share concepts but aren't linked.`,
            action: `suggestConnection('${pair.note1}', '${pair.note2}')`,
            confidence: pair.strength,
            icon: '🔗'
          });
        });
      }

      return recommendations;
    }

    function findUnconnectedButRelated() {
      const pairs = [];

      for (let i = 0; i < notes.length; i++) {
        for (let j = i + 1; j < notes.length; j++) {
          const note1 = notes[i];
          const note2 = notes[j];

          // Check if they're already connected
          const alreadyConnected = note1.content.includes(note2.name) ||
            note2.content.includes(note1.name) ||
            note1.content.includes(note2.sem) ||
            note2.content.includes(note1.sem);

          if (!alreadyConnected) {
            const relationship = calculateSemanticRelationship(note1, note2);
            if (relationship.strength > 0.4) {
              pairs.push({
                note1: note1.frontmatter.title || note1.name,
                note2: note2.frontmatter.title || note2.name,
                strength: relationship.strength
              });
            }
          }
        }
      }

      return pairs.sort((a, b) => b.strength - a.strength);
    }

    // AI Recommendations Display System
    function displayAIRecommendations(recommendations) {
      const panel = document.getElementById('aiRecommendations');
      const countEl = document.getElementById('insightsCount');

      if (!panel) return;

      if (!recommendations || recommendations.length === 0) {
        panel.innerHTML = `
          <div class="ai-recommendation" style="padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;">
            <div style="font-size:12px;font-weight:500;">🔍 Learning your patterns...</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px;">Use the system more to get personalized insights</div>
          </div>`;
        countEl.textContent = '0';
        return;
      }

      // Sort by confidence and limit to top 5
      const topRecommendations = recommendations
        .sort((a, b) => b.confidence - a.confidence)
        .slice(0, 5);

      const recommendationsHtml = topRecommendations.map(rec => {
        const confidenceColor = rec.confidence > 0.8 ? '#4ade80' :
          rec.confidence > 0.6 ? '#fbbf24' : '#f87171';

        return `
          <div class="ai-recommendation"
               style="padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;border-left:3px solid ${confidenceColor};cursor:pointer;transition:all 0.2s;"
               onclick="executeRecommendation('${rec.action}')"
               onmouseover="this.style.background='rgba(255,255,255,0.05)'"
               onmouseout="this.style.background='rgba(255,255,255,0.02)'">
            <div style="display:flex;align-items:center;gap:6px;">
              <span style="font-size:14px;">${rec.icon}</span>
              <div style="flex:1;">
                <div style="font-size:12px;font-weight:500;">${rec.title}</div>
                <div style="font-size:10px;color:var(--muted);margin-top:2px;line-height:1.3;">${rec.description}</div>
              </div>
              <div style="font-size:10px;color:${confidenceColor};font-weight:600;">${Math.round(rec.confidence * 100)}%</div>
            </div>
          </div>`;
      }).join('');

      panel.innerHTML = recommendationsHtml;
      countEl.textContent = topRecommendations.length.toString();

      console.log('✨ Displayed', topRecommendations.length, 'AI recommendations');
    }

    function executeRecommendation(action) {
      console.log('🎯 Executing recommendation:', action);

      try {
        // Parse and execute the recommendation action
        if (action.startsWith('showNote(')) {
          const noteName = action.match(/showNote\('(.+?)'\)/)[1];
          const note = notes.find(n => n.name === noteName);
          if (note) showNote(note);
        } else if (action.startsWith('focusOnGoal(')) {
          const goalTitle = action.match(/focusOnGoal\('(.+?)'\)/)[1];
          focusOnGoal(goalTitle);
        } else if (action === 'showHighPriorityTasks()') {
          showHighPriorityTasks();
        } else if (action === 'suggestTimeBlocking()') {
          suggestTimeBlocking();
        } else if (action.startsWith('suggestConnection(')) {
          const matches = action.match(/suggestConnection\('(.+?)', '(.+?)'\)/);
          if (matches) suggestConnection(matches[1], matches[2]);
        }

        // Track recommendation engagement
        trackRecommendationEngagement(action);

      } catch (e) {
        console.error('Failed to execute recommendation:', e);
      }
    }

    function focusOnGoal(goalTitle) {
      // Show goal details and suggest next actions
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
      `;

      modal.innerHTML = `
        <div style="background: var(--card); border-radius: 12px; padding: 24px; max-width: 500px; width: 100%;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
            <h3 style="margin: 0; color: var(--accent);">🎯 Goal Focus: ${goalTitle}</h3>
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()"
                    style="background: none; border: none; color: var(--muted); cursor: pointer; font-size: 18px;">✕</button>
          </div>

          <div style="margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px; font-size: 14px;">🚀 Suggested Next Actions:</h4>
            <div style="background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px;">
              <div style="margin-bottom: 8px;">• Break goal into smaller, specific tasks</div>
              <div style="margin-bottom: 8px;">• Set a realistic deadline for next milestone</div>
              <div style="margin-bottom: 8px;">• Identify any blocking dependencies</div>
              <div>• Schedule focused work time in your calendar</div>
            </div>
          </div>

          <div style="text-align: center;">
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()"
                    style="background: var(--accent); color: #012; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
              Got it!
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function showHighPriorityTasks() {
      // Filter and highlight high priority tasks
      filterTasks('high');

      // Show notification
      showNotification('🎯 Showing high priority tasks for your morning focus time', 'success');
    }

    function suggestTimeBlocking() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
      `;

      modal.innerHTML = `
        <div style="background: var(--card); border-radius: 12px; padding: 24px; max-width: 500px; width: 100%;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
            <h3 style="margin: 0; color: var(--accent);">⏰ Time Blocking Suggestion</h3>
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()"
                    style="background: none; border: none; color: var(--muted); cursor: pointer; font-size: 18px;">✕</button>
          </div>

          <div style="margin-bottom: 16px;">
            <p style="margin: 0 0 12px; line-height: 1.5;">Based on your reactive work pattern, try this schedule:</p>
            <div style="background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px;">
              <div style="margin-bottom: 6px;"><strong>9:00-11:00:</strong> Deep work (no interruptions)</div>
              <div style="margin-bottom: 6px;"><strong>11:00-12:00:</strong> Reactive tasks & communication</div>
              <div style="margin-bottom: 6px;"><strong>14:00-16:00:</strong> Focused project work</div>
              <div><strong>16:00-17:00:</strong> Planning & review</div>
            </div>
          </div>

          <div style="text-align: center;">
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()"
                    style="background: var(--accent); color: #012; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
              Try This Schedule
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function suggestConnection(note1Title, note2Title) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
      `;

      modal.innerHTML = `
        <div style="background: var(--card); border-radius: 12px; padding: 24px; max-width: 500px; width: 100%;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
            <h3 style="margin: 0; color: var(--accent);">🔗 Suggested Connection</h3>
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()"
                    style="background: none; border: none; color: var(--muted); cursor: pointer; font-size: 18px;">✕</button>
          </div>

          <div style="margin-bottom: 16px;">
            <p style="margin: 0 0 12px; line-height: 1.5;">These notes share related concepts:</p>
            <div style="background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px;">
              <div style="margin-bottom: 8px;"><strong>"${note1Title}"</strong></div>
              <div style="text-align: center; margin: 8px 0; color: var(--accent);">↕️ Related Concepts</div>
              <div><strong>"${note2Title}"</strong></div>
            </div>
            <p style="margin: 12px 0 0; font-size: 12px; color: var(--muted);">
              Consider adding a link between these notes to strengthen your knowledge graph.
            </p>
          </div>

          <div style="text-align: center;">
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()"
                    style="background: var(--accent); color: #012; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
              Thanks for the insight!
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function trackRecommendationEngagement(action) {
      // Track which recommendations users find valuable
      const engagementData = JSON.parse(localStorage.getItem('ai_engagement') || '{}');
      const actionType = action.split('(')[0];

      engagementData[actionType] = (engagementData[actionType] || 0) + 1;
      localStorage.setItem('ai_engagement', JSON.stringify(engagementData));

      console.log('📊 Tracked engagement for:', actionType);
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 1001;
        background: ${type === 'success' ? '#4ade80' : type === 'warning' ? '#fbbf24' : '#60a5fa'};
        color: #012; padding: 12px 16px; border-radius: 8px;
        font-size: 13px; font-weight: 500; max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideInRight 0.3s ease-out;
      `;

      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function refreshAIInsights() {
      console.log('🔄 Refreshing AI insights...');

      // Re-analyze patterns
      analyzeUserBehaviorPatterns();

      // Generate new recommendations
      const recommendations = generateIntelligentRecommendations();

      // Update display
      displayAIRecommendations(recommendations);

      showNotification('🤖 AI insights refreshed with latest patterns', 'success');
    }

    // Utility functions
    function groupBy(array, keyFn) {
      return array.reduce((groups, item) => {
        const key = typeof keyFn === 'function' ? keyFn(item) : item[keyFn];
        groups[key] = groups[key] || [];
        groups[key].push(item);
        return groups;
      }, {});
    }

    function mode(array) {
      const freq = {};
      array.forEach(item => freq[item] = (freq[item] || 0) + 1);
      return Object.keys(freq).reduce((a, b) => freq[a] > freq[b] ? a : b);
    }

    function detectTimeHorizons(userGoals) {
      return {
        shortTerm: userGoals.filter(cat =>
          cat.goals.some(g => g.title.toLowerCase().includes('today') || g.title.toLowerCase().includes('week'))
        ).length,
        mediumTerm: userGoals.filter(cat =>
          cat.goals.some(g => g.title.toLowerCase().includes('month') || g.title.toLowerCase().includes('quarter'))
        ).length,
        longTerm: userGoals.filter(cat =>
          cat.goals.some(g => g.title.toLowerCase().includes('year') || g.title.toLowerCase().includes('annual'))
        ).length
      };
    }

    // PKM Layout functionality with AI integration
    function initializePKMLayout() {
      // Initialize AI systems first
      setTimeout(() => {
        initializeNeuralPatterns();
        const recommendations = generateIntelligentRecommendations();
        displayAIRecommendations(recommendations);
      }, 1000);

      // Initialize main tab switching (PKM ↔ Ontology)
      document.querySelectorAll('.main-tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tabType = e.target.dataset.mainTab;
          const leftColumn = e.target.closest('.left-column');

          // Update main tab buttons
          leftColumn.querySelectorAll('.main-tab-btn').forEach(b => {
            b.classList.remove('active');
            b.style.background = 'rgba(255,255,255,0.05)';
            b.style.color = 'var(--muted)';
          });
          e.target.classList.add('active');
          e.target.style.background = 'var(--accent)';
          e.target.style.color = '#0a0e13';

          // Show/hide main tab content
          leftColumn.querySelectorAll('.main-tab-content').forEach(content => {
            content.style.display = content.id.includes(tabType) ? 'block' : 'none';
          });
        });
      });

      // Initialize sub-tab switching (within panels)
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tabType = e.target.dataset.tab;
          const parent = e.target.closest('.panel');

          // Update tab buttons
          parent.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');

          // Show/hide content
          parent.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = content.id.includes(tabType) ? 'block' : 'none';
          });
        });
      });      // Initialize filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const filterType = e.target.dataset.filter;
          const parent = e.target.closest('.panel');

          // Update filter buttons
          parent.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');

          // Filter tasks based on selection
          filterTasks(filterType);
        });
      });

      // Populate demo data
      populatePKMDemo();
    }

    function filterTasks(filterType) {
      const tasksContent = document.getElementById('tasksContent');
      const taskItems = tasksContent.querySelectorAll('.task-item');

      taskItems.forEach(item => {
        const isVisible = filterType === 'all' ||
          (filterType === 'today' && item.textContent.includes('today')) ||
          (filterType === 'week' && (item.textContent.includes('week') || item.textContent.includes('today'))) ||
          (filterType === 'high' && item.textContent.includes('High priority'));

        item.style.display = isVisible ? 'block' : 'none';
      });
    }

    function populatePKMDemo() {
      // Update counts based on actual loaded content
      const totalNotes = notes ? notes.length : 0;
      const projectNotes = notes ? notes.filter(n => n.frontmatter?.type === 'project') : [];
      const personNotes = notes ? notes.filter(n => n.frontmatter?.type === 'person') : [];
      const allTasks = notes ? notes.flatMap(n => extractTasks(n.content || '', n.name)) : [];

      document.getElementById('inboxCount').textContent = totalNotes.toString();
      document.getElementById('projectsCount').textContent = projectNotes.length.toString();
      document.getElementById('tasksCount').textContent = allTasks.length.toString();
      document.getElementById('archiveCount').textContent = totalNotes.toString();

      // Populate projects list with actual project data
      const projectsList = document.getElementById('projectsList');
      if (projectsList && projectNotes.length > 0) {
        const projectsHTML = projectNotes.slice(0, 3).map(project => {
          const title = project.frontmatter?.title || project.name.replace(/\.md$/, '').replace(/^\d+_/, '');
          const status = project.frontmatter?.status || 'active';
          const priority = project.frontmatter?.priority || 'medium';
          const tasks = extractTasks(project.content || '', project.name);
          const completedTasks = tasks.filter(t => t.done).length;

          const statusColor = status === 'active' ? 'var(--accent)' :
            status === 'completed' ? '#10b981' : '#f59e0b';

          return `
            <div class="project-item" onclick="highlightPKMSource('🏗️ Projects')" style="padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;border-left:3px solid ${statusColor};cursor:pointer;">
              <div style="font-size:13px;font-weight:500;">🏗️ ${title}</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px;">
                ${status} • ${tasks.length > 0 ? `${completedTasks}/${tasks.length} tasks` : 'No tasks'}
                ${priority !== 'medium' ? ` • ${priority} priority` : ''}
              </div>
            </div>`;
        }).join('');

        projectsList.innerHTML = projectsHTML;
      } else if (projectsList) {
        projectsList.innerHTML = `
          <div style="padding:12px;text-align:center;color:var(--muted);font-size:12px;">
            No projects found<br>
            <span style="font-size:11px;">Load a vault to see projects</span>
          </div>`;
      }

      // Populate people list with actual person data
      const peopleList = document.getElementById('peopleList');
      if (peopleList && personNotes.length > 0) {
        const peopleHTML = personNotes.slice(0, 3).map(person => {
          const title = person.frontmatter?.title || person.name.replace(/\.md$/, '').replace(/^\d+_/, '');
          const occupation = person.frontmatter?.occupation || '';
          const age = person.frontmatter?.age || '';
          const location = person.frontmatter?.location || '';

          return `
            <div class="person-item" onclick="highlightPKMSource('👥 People')" style="padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;cursor:pointer;">
              <div style="font-size:13px;font-weight:500;">👤 ${title}</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px;">
                ${occupation ? occupation : 'Person'}
                ${age ? ` • Age ${age}` : ''}
                ${location ? ` • ${location}` : ''}
              </div>
            </div>`;
        }).join('');

        peopleList.innerHTML = peopleHTML;
      } else if (peopleList) {
        peopleList.innerHTML = `
          <div style="padding:12px;text-align:center;color:var(--muted);font-size:12px;">
            No people found<br>
            <span style="font-size:11px;">Load a vault to see people</span>
          </div>`;
      }

      // Load and display actual user goals if available
      try {
        const userGoals = loadUserGoals();
        if (userGoals && userGoals.length > 0) {
          renderUserGoalsInPKM(userGoals);
        }
      } catch (e) {
        console.log('User goals not available yet:', e.message);
      }

      // Update task counts if tasks are available
      if (typeof collectOpenTasks === 'function') {
        try {
          const openTasks = collectOpenTasks();
          document.getElementById('tasksCount').textContent = openTasks.length.toString();
        } catch (e) {
          console.log('Tasks not loaded yet');
        }
      }

      console.log(`✅ PKM Demo populated with actual content: ${totalNotes} notes, ${projectNotes.length} projects, ${personNotes.length} people, ${allTasks.length} tasks`);
    }

    function renderUserGoalsInPKM(userGoals) {
      const userGoalsList = document.getElementById('userGoalsList');
      if (!userGoalsList) return;

      if (!userGoals || userGoals.length === 0) {
        userGoalsList.innerHTML = `
          <div style="padding:12px;text-align:center;color:var(--muted);font-size:12px;">
            <div>📝 No goals detected</div>
            <div style="margin-top:4px;">Add goals to your .md files to see them here</div>
          </div>`;
        return;
      }

      // Display goals organized by category with intelligent UI
      let goalsHtml = '';

      userGoals.forEach(categoryGroup => {
        const { category, goals } = categoryGroup;
        const categoryIcon = getCategoryIcon(category);
        const displayCategory = category.charAt(0).toUpperCase() + category.slice(1);

        // Limit to top 3 goals per category for the sidebar
        const topGoals = goals.slice(0, 3);

        goalsHtml += `
          <div class="goal-category" style="margin-bottom:12px;">
            <div style="font-size:11px;font-weight:600;color:#8b5cf6;margin-bottom:6px;display:flex;align-items:center;gap:4px;">
              ${categoryIcon} ${displayCategory} (${goals.length})
            </div>`;

        topGoals.forEach(goal => {
          const progress = calculateGoalProgress(goal);
          const priorityColor = getPriorityColor(goal.priority);

          goalsHtml += `
            <div class="goal-item" onclick="showGoalDetails('${goal.title}', '${category}')"
                 style="padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;border-left:3px solid ${priorityColor};cursor:pointer;transition:all 0.2s;"
                 onmouseover="this.style.background='rgba(255,255,255,0.05)'"
                 onmouseout="this.style.background='rgba(255,255,255,0.02)'">
              <div style="font-size:12px;font-weight:500;line-height:1.3;">${goal.title}</div>
              <div style="font-size:10px;color:var(--muted);margin-top:2px;display:flex;justify-content:space-between;">
                <span>${goal.source}</span>
                <span>${goal.type}</span>
              </div>
              ${progress > 0 ? `
                <div style="margin-top:4px;background:#143046;height:3px;border-radius:2px;overflow:hidden;">
                  <div style="background:${priorityColor};height:100%;width:${progress}%;transition:width 0.3s;"></div>
                </div>
              ` : ''}
            </div>`;
        });

        if (goals.length > 3) {
          goalsHtml += `
            <div style="font-size:10px;color:var(--muted);text-align:center;padding:4px;">
              +${goals.length - 3} more goals...
            </div>`;
        }

        goalsHtml += '</div>';
      });

      // Add summary stats
      const totalGoals = userGoals.reduce((sum, cat) => sum + cat.goals.length, 0);
      const completedGoals = userGoals.reduce((sum, cat) =>
        sum + cat.goals.filter(g => calculateGoalProgress(g) === 100).length, 0);

      goalsHtml += `
        <div style="border-top:1px solid #143046;padding-top:8px;margin-top:8px;">
          <div style="font-size:10px;color:var(--muted);text-align:center;">
            📊 ${completedGoals}/${totalGoals} goals active
          </div>
        </div>`;

      userGoalsList.innerHTML = goalsHtml;
    }

    function getCategoryIcon(category) {
      const icons = {
        health: '🏃‍♀️',
        family: '👨‍👩‍👧‍👦',
        business: '💼',
        community: '🤝',
        learning: '📚',
        project: '🚀',
        personal: '🎯'
      };
      return icons[category] || '🎯';
    }

    function getPriorityColor(priority) {
      const colors = {
        high: '#ff6b6b',
        medium: '#4ecdc4',
        low: '#95a5a6'
      };
      return colors[priority] || '#4ecdc4';
    }

    function calculateGoalProgress(goal) {
      // Smart progress calculation based on goal type and content
      if (goal.type === 'project' && goal.tasks) {
        const completed = goal.tasks.filter(t => t.done).length;
        const total = goal.tasks.length;
        return total > 0 ? Math.round((completed / total) * 100) : 0;
      }

      // For extracted goals, estimate progress based on keywords
      const progressKeywords = {
        'completed': 100,
        'done': 100,
        'finished': 100,
        'achieved': 100,
        'started': 25,
        'began': 25,
        'planning': 10,
        'considering': 5
      };

      const goalText = goal.title.toLowerCase();
      for (const [keyword, progress] of Object.entries(progressKeywords)) {
        if (goalText.includes(keyword)) {
          return progress;
        }
      }

      // Default progress based on priority and type
      if (goal.type === 'manifest') return 30; // Manifest goals are typically ongoing
      if (goal.priority === 'high') return 15; // High priority suggests some progress
      return 10; // Default modest progress
    }

    function showGoalDetails(goalTitle, category) {
      // Enhanced goal details modal or expanded view
      const userGoals = loadUserGoals();
      const categoryGroup = userGoals.find(cat => cat.category === category);
      const goal = categoryGroup?.goals.find(g => g.title === goalTitle);

      if (!goal) return;

      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
      `;

      modal.innerHTML = `
        <div style="background: var(--card); border-radius: 12px; padding: 24px; max-width: 500px; width: 100%;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
            <h3 style="margin: 0; color: var(--accent);">${getCategoryIcon(goal.category)} ${goal.title}</h3>
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()"
                    style="background: none; border: none; color: var(--muted); cursor: pointer; font-size: 18px;">✕</button>
          </div>

          <div style="margin-bottom: 12px;">
            <span style="font-size: 12px; color: var(--muted);">Category:</span>
            <span style="margin-left: 8px; font-weight: 500;">${goal.category}</span>
          </div>

          <div style="margin-bottom: 12px;">
            <span style="font-size: 12px; color: var(--muted);">Priority:</span>
            <span style="margin-left: 8px; color: ${getPriorityColor(goal.priority)}; font-weight: 500;">${goal.priority}</span>
          </div>

          <div style="margin-bottom: 12px;">
            <span style="font-size: 12px; color: var(--muted);">Source:</span>
            <span style="margin-left: 8px;">${goal.source}</span>
          </div>

          ${goal.description ? `
            <div style="margin-bottom: 12px;">
              <span style="font-size: 12px; color: var(--muted);">Description:</span>
              <div style="margin-top: 4px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 6px; font-size: 13px; line-height: 1.4;">
                ${goal.description}
              </div>
            </div>
          ` : ''}

          ${goal.tasks && goal.tasks.length > 0 ? `
            <div style="margin-bottom: 12px;">
              <span style="font-size: 12px; color: var(--muted);">Tasks (${goal.tasks.filter(t => t.done).length}/${goal.tasks.length}):</span>
              <div style="margin-top: 4px;">
                ${goal.tasks.slice(0, 5).map(task => `
                  <div style="padding: 4px 0; font-size: 12px;">
                    ${task.done ? '✅' : '⏳'} ${task.text}
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div style="margin-top: 16px; text-align: center;">
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()"
                    style="background: var(--accent); color: #012; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
              Close
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Button handlers for PKM actions
    function addToInbox() {
      // Enhanced Quick Capture functionality
      const modal = createModal('Quick Capture', `
        <div style="padding: 20px;">
          <textarea id="quickCaptureText" placeholder="What's on your mind? Jot it down quickly..."
                    style="width: 100%; height: 120px; background: #1e293b; border: 1px solid #475569; border-radius: 8px; color: white; padding: 12px; font-family: inherit; resize: vertical;"></textarea>
          <div style="margin-top: 16px; display: flex; gap: 12px;">
            <select id="captureType" style="background: #1e293b; border: 1px solid #475569; border-radius: 6px; color: white; padding: 8px;">
              <option value="note">📝 Note</option>
              <option value="task">✅ Task</option>
              <option value="idea">💡 Idea</option>
              <option value="project">💼 Project</option>
            </select>
            <button onclick="saveQuickCapture()" style="flex: 1; background: #3b82f6; border: none; border-radius: 6px; color: white; padding: 8px 16px; cursor: pointer;">Save to Inbox</button>
          </div>
        </div>
      `);
    }

    function saveQuickCapture() {
      const text = document.getElementById('quickCaptureText').value;
      const type = document.getElementById('captureType').value;

      if (text.trim()) {
        // Create a new note object
        const newNote = {
          id: Date.now().toString(),
          title: text.split('\n')[0].substring(0, 50) + (text.length > 50 ? '...' : ''),
          content: text,
          type: type,
          created: new Date().toISOString(),
          sem: `${type}:inbox-${Date.now()}`
        };

        // Add to current notes
        currentNotes.unshift(newNote);

        // Close modal and update UI
        closeModal();
        updateInterface();
        showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} added to inbox!`, 'success');
      } else {
        showNotification('Please enter some content', 'warning');
      }
    }

    function addTask() {
      // Enhanced Task Creation
      const modal = createModal('Create New Task', `
        <div style="padding: 20px;">
          <input id="taskTitle" placeholder="Task title..."
                 style="width: 100%; background: #1e293b; border: 1px solid #475569; border-radius: 8px; color: white; padding: 12px; margin-bottom: 12px; font-family: inherit;">
          <textarea id="taskDescription" placeholder="Task description (optional)..."
                    style="width: 100%; height: 80px; background: #1e293b; border: 1px solid #475569; border-radius: 8px; color: white; padding: 12px; margin-bottom: 12px; font-family: inherit; resize: vertical;"></textarea>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <select id="taskPriority" style="background: #1e293b; border: 1px solid #475569; border-radius: 6px; color: white; padding: 8px;">
              <option value="low">🟢 Low Priority</option>
              <option value="medium" selected>🟡 Medium Priority</option>
              <option value="high">🔴 High Priority</option>
            </select>
            <select id="taskProject" style="background: #1e293b; border: 1px solid #475569; border-radius: 6px; color: white; padding: 8px;">
              <option value="">📋 No Project</option>
              <option value="research">📚 Research</option>
              <option value="personal">👤 Personal</option>
              <option value="work">💼 Work</option>
            </select>
          </div>
          <button onclick="saveNewTask()" style="width: 100%; background: #22c55e; border: none; border-radius: 6px; color: white; padding: 12px; cursor: pointer; font-weight: 600;">Create Task</button>
        </div>
      `);
    }

    function saveNewTask() {
      const title = document.getElementById('taskTitle').value;
      const description = document.getElementById('taskDescription').value;
      const priority = document.getElementById('taskPriority').value;
      const project = document.getElementById('taskProject').value;

      if (title.trim()) {
        const taskContent = `# ${title}\n\n- [ ] ${title}\n\n${description ? description + '\n\n' : ''}Priority: ${priority}\n${project ? `Project: ${project}\n` : ''}`;

        const newTask = {
          id: Date.now().toString(),
          title: title,
          content: taskContent,
          type: 'task',
          priority: priority,
          project: project,
          created: new Date().toISOString(),
          sem: `task:${title.toLowerCase().replace(/\s+/g, '-')}`
        };

        currentNotes.unshift(newTask);
        closeModal();
        updateInterface();
        showNotification(`Task "${title}" created successfully!`, 'success');
      } else {
        showNotification('Please enter a task title', 'warning');
      }
    }

    function reflectOnThinking() {
      // Enhanced Reflection Tool
      const recentNotes = currentNotes.slice(0, 10);
      const commonThemes = extractCommonThemes(recentNotes);

      const modal = createModal('💭 Thinking Reflection', `
        <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
          <div style="margin-bottom: 20px;">
            <h3 style="color: #7dd3fc; margin: 0 0 12px 0;">Recent Patterns in Your Thinking</h3>
            <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; padding: 16px;">
              <div style="margin-bottom: 12px;"><strong>Common Themes:</strong></div>
              ${commonThemes.map(theme => `<span style="background: rgba(139,92,246,0.2); color: #a78bfa; padding: 4px 8px; border-radius: 12px; margin: 2px; display: inline-block;">${theme}</span>`).join('')}
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="color: #22c55e; margin: 0 0 12px 0;">Reflection Questions</h3>
            <div style="space-y: 8px;">
              <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                What patterns do you notice in your recent notes?
              </div>
              <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                Which ideas deserve more development?
              </div>
              <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                How do these thoughts connect to your larger goals?
              </div>
            </div>
          </div>

          <div>
            <h3 style="color: #f59e0b; margin: 0 0 12px 0;">AI Insights</h3>
            <div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 8px; padding: 16px;">
              Based on your recent activity, you seem to be exploring <strong>${commonThemes[0] || 'various topics'}</strong>.
              Consider creating a dedicated project to organize these thoughts and track progress.
            </div>
          </div>
        </div>
      `);
    }

    function extractCommonThemes(notes) {
      const words = notes.flatMap(note =>
        note.content.toLowerCase()
          .replace(/[^\w\s]/g, ' ')
          .split(/\s+/)
          .filter(word => word.length > 3)
      );

      const frequency = {};
      words.forEach(word => frequency[word] = (frequency[word] || 0) + 1);

      return Object.entries(frequency)
        .sort(([, a], [, b]) => b - a)
        .slice(0, 5)
        .map(([word]) => word);
    }

    function createModal(title, content) {
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
      `;

      const modal = document.createElement('div');
      modal.style.cssText = `
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.4);
      `;

      modal.innerHTML = `
        <div style="padding: 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; color: white; font-size: 18px;">${title}</h2>
          <button onclick="closeModal()" style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 24px; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">×</button>
        </div>
        ${content}
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      // Close on overlay click
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeModal();
      });

      // Close on Escape key
      const handleEscape = (e) => {
        if (e.key === 'Escape') {
          closeModal();
          document.removeEventListener('keydown', handleEscape);
        }
      };
      document.addEventListener('keydown', handleEscape);

      return overlay;
    }

    function closeModal() {
      const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.transform = 'scale(0.95)';
        modal.style.transition = 'all 0.2s ease';
        setTimeout(() => modal.remove(), 200);
      }
    }

    function browseArchive() {
      alert('Archive browser would let you explore sorted documents');
    }

    function addProject() {
      alert('Add project functionality would open a project creation form');
    }

    // Task and PKM Connection Highlighting
    function highlightTaskConnections(taskElement) {
      // Clear previous highlights
      clearAllHighlights();

      const pkmSource = taskElement.dataset.pkmSource;
      const projectId = taskElement.dataset.project;

      // Highlight the task
      taskElement.style.background = 'rgba(125,211,252,0.15)';
      taskElement.style.borderLeftColor = '#7dd3fc';

      // Highlight PKM source in left panel
      if (pkmSource) {
        highlightPKMSource(pkmSource);
      }

      // Highlight related project in right panel
      if (projectId) {
        highlightProject(projectId);
      }

      // Show connection lines (visual feedback)
      showConnectionLines(taskElement, pkmSource, projectId);
    }

    function highlightPKMSource(source) {
      // Enhanced PKM section interaction with staging area
      let sectionName = '';
      let sectionContent = '';

      if (typeof source === 'string') {
        sectionName = source;
      } else if (source && source.tagName) {
        // Extract section name from the clicked element
        const spanEl = source.querySelector('span');
        sectionName = spanEl ? spanEl.textContent.trim() : '';
      }

      // Reset all PKM section highlights
      const pkmElements = document.querySelectorAll('.knowledge-category');
      pkmElements.forEach(el => {
        el.style.background = '';
        el.style.borderLeft = '';
      });

      // Highlight the selected section
      if (source && source.tagName) {
        source.style.background = 'rgba(125,211,252,0.1)';
        source.style.borderLeft = '3px solid #7dd3fc';
      }

      // Generate content based on section
      const contentData = generatePKMContent(sectionName);

      // Display content in the staging area
      stagePKMSection(sectionName, contentData);

      showNotification(`Loading ${sectionName} in staging area`, 'info');
    }

    function stagePKMSection(sectionName, contentData) {
      const stagingTitle = document.getElementById('stagingTitle');
      const stagingContent = document.getElementById('stagingContent');

      if (!stagingTitle || !stagingContent) return;

      stagingTitle.textContent = sectionName;

      const { notes, totalCount, completedTasks, pendingTasks } = contentData;

      let html = `
        <div class="staging-section-header" style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 14px;">
            <div style="color: #22c55e;">✅ ${completedTasks} completed</div>
            <div style="color: #f59e0b;">⏳ ${pendingTasks} pending</div>
            <div style="color: #8b5cf6;">📄 ${notes.length} items</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="createNewItem('${sectionName}')" style="background: var(--accent); color: #0a0e13; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
              + Add New
            </button>
            <button onclick="bulkEdit('${sectionName}')" style="background: rgba(255,255,255,0.1); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
              Bulk Edit
            </button>
            <button onclick="exportSection('${sectionName}')" style="background: rgba(255,255,255,0.1); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
              Export
            </button>
          </div>
        </div>

        <div class="staging-items" style="max-height: calc(100vh - 300px); overflow-y: auto;">
      `;

      if (notes.length === 0) {
        html += `
          <div style="text-align: center; padding: 40px; color: #64748b;">
            <div style="font-size: 48px; margin-bottom: 16px;">📭</div>
            <div style="font-size: 18px; margin-bottom: 8px;">No items in ${sectionName}</div>
            <div style="font-size: 14px;">Create some content to see it here!</div>
            <button onclick="createNewItem('${sectionName}')" style="margin-top: 16px; background: var(--accent); color: #0a0e13; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
              Create First Item
            </button>
          </div>
        `;
      } else {
        // Show notes in editable format with rich information from .md files
        notes.forEach((note, index) => {
          // Get the original note for full details
          const originalNote = window.notes?.find(n => n.sem === note.id || n.name === note.id);
          const frontmatter = originalNote?.frontmatter || {};

          const preview = note.content.substring(0, 400).replace(/\n/g, ' ');
          const taskCount = (note.content.match(/\[[ x]\]/g) || []).length;
          const completedCount = (note.content.match(/\[x\]/g) || []).length;

          // Enhanced display with actual frontmatter data
          const typeDisplay = frontmatter.type || note.type || 'note';
          const statusDisplay = frontmatter.status || note.status;
          const priorityDisplay = frontmatter.priority || note.priority;
          const tagsDisplay = frontmatter.tags || note.links || [];

          html += `
            <div class="staging-item" style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <input type="text" value="${note.title}" onchange="updateNoteTitle('${note.id}', this.value)"
                       style="background: transparent; border: none; color: #e2e8f0; font-size: 16px; font-weight: 600; width: 100%; margin-right: 12px;">
                <div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">
                  ${typeDisplay ? `<span style="background: rgba(139,92,246,0.2); color: #a78bfa; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${typeDisplay}</span>` : ''}
                  ${statusDisplay ? `<span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${statusDisplay}</span>` : ''}
                  ${priorityDisplay && priorityDisplay !== 'medium' ? `<span style="background: rgba(245,158,11,0.2); color: #f59e0b; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${priorityDisplay}</span>` : ''}
                  ${taskCount > 0 ? `<span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${completedCount}/${taskCount} tasks</span>` : ''}
                  <button onclick="editNoteInStaging('${note.id}')" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Edit</button>
                  <button onclick="deleteNote('${note.id}')" style="background: rgba(239,68,68,0.2); border: none; color: #ef4444; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Delete</button>
                </div>
              </div>

              <div class="note-preview" style="color: #94a3b8; font-size: 14px; line-height: 1.5; margin-bottom: 12px; max-height: 80px; overflow: hidden;">
                ${preview}${note.content.length > 400 ? '...' : ''}
              </div>

              ${tagsDisplay && tagsDisplay.length > 0 ? `
                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                  ${tagsDisplay.slice(0, 5).map(tag => `<span style="background: rgba(59,130,246,0.2); color: #60a5fa; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${tag}</span>`).join('')}
                  ${tagsDisplay.length > 5 ? `<span style="color: #64748b; font-size: 11px;">+${tagsDisplay.length - 5} more</span>` : ''}
                </div>
              ` : ''}

              ${frontmatter.start_date || frontmatter.target_date ? `
                <div style="display: flex; gap: 12px; margin-bottom: 8px; font-size: 12px; color: #64748b;">
                  ${frontmatter.start_date ? `<span>📅 Started: ${new Date(frontmatter.start_date).toLocaleDateString()}</span>` : ''}
                  ${frontmatter.target_date ? `<span>🎯 Target: ${new Date(frontmatter.target_date).toLocaleDateString()}</span>` : ''}
                </div>
              ` : ''}

              <div style="display: flex; justify-content: between; align-items: center; font-size: 11px; color: #64748b;">
                <span>Created: ${note.created ? new Date(note.created).toLocaleDateString() : 'Unknown'}</span>
                <span style="margin-left: auto;">ID: ${note.id}</span>
              </div>
            </div>
          `;
        });
      }

      html += `</div>`;

      stagingContent.innerHTML = html;
    }    // Staging functions for different content types
    function stageTask(taskElement) {
      const stagingTitle = document.getElementById('stagingTitle');
      const stagingContent = document.getElementById('stagingContent');

      stagingTitle.textContent = '✅ Task Details';

      const taskTitle = taskElement.querySelector('div:first-child').textContent;
      const taskMeta = taskElement.querySelector('div:last-child').textContent;

      stagingContent.innerHTML = `
        <div class="task-staging">
          <h3 style="color: #7dd3fc; margin: 0 0 16px 0;">Task Editor</h3>

          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px;">Task Title</label>
            <input type="text" value="${taskTitle}" style="width: 100%; background: #1e293b; border: 1px solid #475569; border-radius: 6px; color: white; padding: 12px;">
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px;">Description</label>
            <textarea style="width: 100%; height: 120px; background: #1e293b; border: 1px solid #475569; border-radius: 6px; color: white; padding: 12px; resize: vertical;" placeholder="Task description..."></textarea>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px;">Priority</label>
              <select style="width: 100%; background: #1e293b; border: 1px solid #475569; border-radius: 6px; color: white; padding: 8px;">
                <option value="low">🟢 Low Priority</option>
                <option value="medium" selected>🟡 Medium Priority</option>
                <option value="high">🔴 High Priority</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px;">Status</label>
              <select style="width: 100%; background: #1e293b; border: 1px solid #475569; border-radius: 6px; color: white; padding: 8px;">
                <option value="todo">📋 To Do</option>
                <option value="progress">🔄 In Progress</option>
                <option value="done">✅ Done</option>
              </select>
            </div>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px;">Meta Information</label>
            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px; font-size: 12px; color: #64748b;">
              ${taskMeta}
            </div>
          </div>

          <div style="display: flex; gap: 12px;">
            <button onclick="saveTaskChanges()" style="flex: 1; background: #22c55e; border: none; border-radius: 6px; color: white; padding: 12px; cursor: pointer; font-weight: 600;">Save Changes</button>
            <button onclick="duplicateTask()" style="background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: white; padding: 12px; cursor: pointer;">Duplicate</button>
            <button onclick="deleteTask()" style="background: #ef4444; border: none; border-radius: 6px; color: white; padding: 12px; cursor: pointer;">Delete</button>
          </div>
        </div>
      `;

      showNotification('Task loaded in staging area', 'success');
    }

    function stageWorkItem(workElement) {
      const stagingTitle = document.getElementById('stagingTitle');
      const stagingContent = document.getElementById('stagingContent');

      stagingTitle.textContent = '🎯 Work Item Details';

      stagingContent.innerHTML = `
        <div class="work-staging">
          <h3 style="color: #7dd3fc; margin: 0 0 16px 0;">Active Work Editor</h3>
          <p style="color: #94a3b8; margin-bottom: 24px;">Manage your active work items and track progress.</p>

          <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px;">
            <h4 style="margin: 0 0 12px 0; color: #22c55e;">🏗️ Building PKM System</h4>
            <div style="margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="color: #94a3b8;">Progress</span>
                <span style="color: #22c55e; font-weight: 600;">75%</span>
              </div>
              <div style="background: #1e293b; height: 8px; border-radius: 4px; overflow: hidden;">
                <div style="background: #22c55e; height: 100%; width: 75%; transition: width 0.3s ease;"></div>
              </div>
            </div>
            <p style="color: #94a3b8; margin: 0;">3 tasks remaining • Target completion: Next week</p>
          </div>

          <div style="margin-top: 24px; display: flex; gap: 12px;">
            <button onclick="viewWorkDetails()" style="flex: 1; background: var(--accent); border: none; border-radius: 6px; color: #0a0e13; padding: 12px; cursor: pointer; font-weight: 600;">View Details</button>
            <button onclick="addWorkTask()" style="background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: white; padding: 12px; cursor: pointer;">Add Task</button>
          </div>
        </div>
      `;

      showNotification('Work item loaded in staging area', 'success');
    }

    function stageProject(projectElement) {
      const stagingTitle = document.getElementById('stagingTitle');
      const stagingContent = document.getElementById('stagingContent');

      stagingTitle.textContent = '🏗️ Project Details';

      stagingContent.innerHTML = `
        <div class="project-staging">
          <h3 style="color: #7dd3fc; margin: 0 0 16px 0;">Project Management</h3>

          <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <input type="text" value="PKM System Development" style="width: 100%; background: transparent; border: none; color: #22c55e; font-size: 18px; font-weight: 600; margin-bottom: 12px;">

            <div style="margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="color: #94a3b8;">Overall Progress</span>
                <span style="color: #22c55e; font-weight: 600;">75%</span>
              </div>
              <div style="background: #1e293b; height: 8px; border-radius: 4px; overflow: hidden;">
                <div style="background: #22c55e; height: 100%; width: 75%; transition: width 0.3s ease;"></div>
              </div>
            </div>

            <textarea placeholder="Project description..." style="width: 100%; height: 80px; background: #1e293b; border: 1px solid #475569; border-radius: 6px; color: white; padding: 12px; resize: vertical; margin-bottom: 12px;"></textarea>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label style="display: block; margin-bottom: 4px; color: #94a3b8; font-size: 12px;">Start Date</label>
                <input type="date" style="width: 100%; background: #1e293b; border: 1px solid #475569; border-radius: 6px; color: white; padding: 8px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; color: #94a3b8; font-size: 12px;">Target Date</label>
                <input type="date" style="width: 100%; background: #1e293b; border: 1px solid #475569; border-radius: 6px; color: white; padding: 8px;">
              </div>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="color: #94a3b8; margin: 0 0 12px 0;">Project Tasks</h4>
            <div style="background: rgba(255,255,255,0.02); border-radius: 6px; padding: 12px;">
              <div style="color: #64748b; text-align: center; padding: 20px;">
                Tasks will be listed here when implemented
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 12px;">
            <button onclick="saveProjectChanges()" style="flex: 1; background: #22c55e; border: none; border-radius: 6px; color: white; padding: 12px; cursor: pointer; font-weight: 600;">Save Changes</button>
            <button onclick="addProjectTask()" style="background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: white; padding: 12px; cursor: pointer;">Add Task</button>
            <button onclick="archiveProject()" style="background: #ef4444; border: none; border-radius: 6px; color: white; padding: 12px; cursor: pointer;">Archive</button>
          </div>
        </div>
      `;

      showNotification('Project loaded in staging area', 'success');
    }

    // Staging area utility functions
    function clearStaging() {
      const stagingTitle = document.getElementById('stagingTitle');
      const stagingContent = document.getElementById('stagingContent');

      stagingTitle.textContent = '📋 Content Staging Area';
      stagingContent.innerHTML = `
        <div class="staging-welcome" style="text-align: center; padding: 60px 20px; color: #64748b;">
          <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
          <h3 style="margin: 0 0 12px 0; color: #94a3b8;">Content Staging Area</h3>
          <p style="margin: 0; line-height: 1.5;">
            Click on any PKM section, note, task, or project to view and edit it here.
            This is your workspace for interacting with all content types.
          </p>
          <div style="margin-top: 24px;">
            <button onclick="showStagingDemo()" style="background: var(--accent); color: #0a0e13; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
              View Demo
            </button>
          </div>
        </div>
      `;

      showNotification('Staging area cleared', 'info');
    }

    function refreshStaging() {
      showNotification('Staging area refreshed', 'info');
    }

    function showStagingDemo() {
      const stagingContent = document.getElementById('stagingContent');

      stagingContent.innerHTML = `
        <div class="staging-demo">
          <h3 style="color: #7dd3fc; margin: 0 0 16px 0;">🎬 Staging Area Demo</h3>

          <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px 0; color: #60a5fa;">How to Use the Staging Area</h4>
            <ul style="margin: 0; padding-left: 20px; color: #94a3b8; line-height: 1.6;">
              <li>Click any PKM section (📚 Research, 👥 People, etc.) to view and filter content</li>
              <li>Click tasks, projects, or work items to edit them in detail</li>
              <li>Use the action buttons to create, edit, duplicate, or delete items</li>
              <li>All changes are automatically saved and synced</li>
            </ul>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <button onclick="highlightPKMSource(document.querySelector('.knowledge-category'))" style="background: #8b5cf6; border: none; border-radius: 6px; color: white; padding: 12px; cursor: pointer;">
              Try PKM Section
            </button>
            <button onclick="stageTask(document.querySelector('.task-item'))" style="background: #22c55e; border: none; border-radius: 6px; color: white; padding: 12px; cursor: pointer;">
              Try Task Edit
            </button>
          </div>
        </div>
      `;

      showNotification('Demo loaded - try the buttons!', 'success');
    }

    // Helper functions for staging area interactions
    function createNewItem(sectionName) {
      showNotification(`Creating new item in ${sectionName}`, 'info');
      // Implementation would create new note/item
    }

    function bulkEdit(sectionName) {
      showNotification(`Bulk edit mode for ${sectionName}`, 'info');
      // Implementation would enable bulk operations
    }

    function exportSection(sectionName) {
      showNotification(`Exporting ${sectionName} section`, 'info');
      // Implementation would export section data
    }

    function updateNoteTitle(noteId, newTitle) {
      showNotification(`Updated title for note ${noteId}`, 'success');
      // Implementation would update the note title
    }

    function editNoteInStaging(noteId) {
      showNotification(`Opening editor for note ${noteId}`, 'info');
      // Implementation would open full note editor
    }

    function deleteNote(noteId) {
      if (confirm('Are you sure you want to delete this note?')) {
        showNotification(`Deleted note ${noteId}`, 'success');
        // Implementation would delete the note
      }
    }

    // Task staging helper functions
    function saveTaskChanges() {
      showNotification('Task changes saved successfully', 'success');
    }

    function duplicateTask() {
      showNotification('Task duplicated', 'success');
    }

    function deleteTask() {
      if (confirm('Are you sure you want to delete this task?')) {
        showNotification('Task deleted', 'success');
      }
    }

    // Work item helper functions
    function viewWorkDetails() {
      showNotification('Loading detailed work view', 'info');
    }

    function addWorkTask() {
      showNotification('Adding new task to work item', 'info');
    }

    // Project helper functions
    function saveProjectChanges() {
      showNotification('Project changes saved', 'success');
    }

    function addProjectTask() {
      showNotification('Adding new task to project', 'info');
    }

    function archiveProject() {
      if (confirm('Are you sure you want to archive this project?')) {
        showNotification('Project archived', 'info');
      }
    }

    function generatePKMContent(sectionName) {
      const currentUser = getCurrentUser();

      // Transform notes to the format expected by PKM sections
      const transformedNotes = notes.map(note => ({
        id: note.sem || note.name,
        title: note.frontmatter?.title || note.name.replace(/\.md$/, '').replace(/^\d+_/, ''),
        content: note.content || note.text || '',
        type: note.frontmatter?.type || 'note',
        created: note.frontmatter?.created || note.frontmatter?.start_date || new Date().toISOString(),
        modified: note.frontmatter?.modified || new Date().toISOString(),
        links: note.frontmatter?.links || note.frontmatter?.tags || [],
        status: note.frontmatter?.status || 'active',
        priority: note.frontmatter?.priority || 'medium',
        tasks: note.tasks || []
      }));

      // Filter notes based on section with enhanced categorization
      const sectionNotes = transformedNotes.filter(note => {
        const content = note.content.toLowerCase();
        const title = note.title.toLowerCase();
        const type = note.type;
        const frontmatter = notes.find(n => n.name === note.id || n.sem === note.id)?.frontmatter || {};

        switch (sectionName) {
          case '📚 Research':
            return type === 'project' && (
              content.includes('research') || content.includes('study') ||
              content.includes('experiment') || content.includes('analysis') ||
              title.includes('research') || title.includes('study') ||
              content.includes('participant') || content.includes('observation') ||
              content.includes('lab') || content.includes('field')
            ) || (
                type === 'note' && (
                  title.includes('research') || title.includes('notes') ||
                  content.includes('observation') || content.includes('participant') ||
                  content.includes('experiment') || content.includes('study')
                )
              );

          case '� People':
            return type === 'person' || type === 'note' && (
              content.includes('participant') || content.includes('person:') ||
              content.includes('family') || content.includes('children') ||
              content.includes('husband') || content.includes('wife') ||
              content.includes('colleague') || content.includes('friend') ||
              title.includes('person') || title.includes('bio') ||
              frontmatter.age || frontmatter.occupation
            );

          case '💡 Ideas':
            return content.includes('idea') || content.includes('concept') ||
              title.includes('ideas') || title.includes('concept') ||
              title.includes('innovation') || content.includes('innovation') ||
              content.includes('experiment') || content.includes('prototype') ||
              type === 'concept' || (
                content.includes('what if') || content.includes('could we') ||
                content.includes('possibility') || content.includes('opportunity')
              );

          case '🏗️ Projects':
            return type === 'project' || (
              (content.includes('[ ]') || content.includes('[x]')) && (
                content.includes('project') || content.includes('goal') ||
                frontmatter.start_date || frontmatter.target_date ||
                frontmatter.status === 'active' || frontmatter.priority
              )
            );

          case '📝 Notes':
            return type === 'note' && !(
              content.includes('project:') || type === 'project' ||
              type === 'person' || type === 'concept'
            ) || (
                content.includes('notes:') || title.includes('notes') ||
                content.includes('observation') || content.includes('meeting')
              );

          case '⚡ Quick Notes':
            return type === 'note' && (
              title.includes('quick') || title.includes('idea') ||
              content.length < 500 || (
                content.includes('remember') || content.includes('note:') ||
                content.includes('todo') || content.includes('check')
              )
            );

          case '📋 Tasks':
            return content.includes('[ ]') || content.includes('[x]') ||
              content.includes('todo') || content.includes('task') ||
              type === 'task' || note.tasks.length > 0;

          default:
            return true;
        }
      });

      // Calculate task statistics from actual content
      let completedTasks = 0;
      let pendingTasks = 0;

      sectionNotes.forEach(note => {
        const content = note.content || '';
        const completed = (content.match(/\[x\]/g) || []).length;
        const pending = (content.match(/\[ \]/g) || []).length;
        completedTasks += completed;
        pendingTasks += pending;
      });

      return {
        notes: sectionNotes,
        totalCount: sectionNotes.length,
        completedTasks,
        pendingTasks
      };
    }

    function showPKMSectionContent(sectionName, contentData) {
      const centerPanel = document.getElementById('centerPanel');
      if (!centerPanel) return;

      const { notes, totalCount, completedTasks, pendingTasks } = contentData;

      let html = `
        <div class="pkm-section-view" style="padding: 20px; height: 100%; overflow-y: auto;">
          <div class="section-header" style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <h2 style="margin: 0; color: #7dd3fc; display: flex; align-items: center; gap: 8px;">
              ${sectionName}
              <span style="font-size: 14px; background: rgba(125,211,252,0.2); padding: 4px 8px; border-radius: 12px;">${totalCount}</span>
            </h2>
            <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 14px;">
              <div style="color: #22c55e;">✅ ${completedTasks} completed</div>
              <div style="color: #f59e0b;">⏳ ${pendingTasks} pending</div>
              <div style="color: #8b5cf6;">📄 ${notes.length} items</div>
            </div>
          </div>

          <div class="section-content">
      `;

      if (notes.length === 0) {
        html += `
          <div style="text-align: center; padding: 40px; color: #64748b;">
            <div style="font-size: 48px; margin-bottom: 16px;">📭</div>
            <div style="font-size: 18px; margin-bottom: 8px;">No items in ${sectionName}</div>
            <div style="font-size: 14px;">Create some content to see it here!</div>
          </div>
        `;
      } else {
        // Show notes in the section
        notes.forEach(note => {
          const preview = note.content.substring(0, 200).replace(/\n/g, ' ') + '...';
          const taskCount = (note.content.match(/\[[ x]\]/g) || []).length;

          html += `
            <div class="note-item" style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;"
                 onclick="openNote('${note.id}')" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='rgba(255,255,255,0.02)'">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <h3 style="margin: 0; color: #e2e8f0; font-size: 16px;">${note.title}</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                  ${note.type ? `<span style="background: rgba(139,92,246,0.2); color: #a78bfa; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${note.type}</span>` : ''}
                  ${taskCount > 0 ? `<span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${taskCount} tasks</span>` : ''}
                </div>
              </div>
              <div style="color: #94a3b8; font-size: 14px; line-height: 1.4;">${preview}</div>
              ${note.links && note.links.length > 0 ? `
                <div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">
                  ${note.links.slice(0, 3).map(link => `<span style="background: rgba(59,130,246,0.2); color: #60a5fa; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${link}</span>`).join('')}
                  ${note.links.length > 3 ? `<span style="color: #64748b; font-size: 11px;">+${note.links.length - 3} more</span>` : ''}
                </div>
              ` : ''}
            </div>
          `;
        });
      }

      html += `
          </div>
        </div>
      `;

      centerPanel.innerHTML = html;
    }

    function getCurrentUser() {
      const userSelect = document.getElementById('userSelect');
      return userSelect ? userSelect.value : 'vault';
    }

    function openNote(noteId) {
      const note = currentNotes.find(n => n.id === noteId);
      if (note) {
        showNotification(`Opening: ${note.title}`, 'info');
        // Here you could implement actual note editing/viewing
        console.log('Opening note:', note);
      }
    }

    function highlightProject(projectId) {
      const projectElements = document.querySelectorAll('.project-hierarchy, .goal-hierarchy');
      projectElements.forEach(project => {
        if (project.textContent.toLowerCase().includes(projectId.replace('-', ' '))) {
          project.style.background = 'rgba(125,211,252,0.08)';
          project.style.borderColor = '#7dd3fc';
        }
      });
    }

    function showConnectionLines(taskElement, pkmSource, projectId) {
      // Create temporary visual indicators
      const indicator = document.createElement('div');
      indicator.className = 'connection-indicator';
      indicator.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(125,211,252,0.9);
        color: #012;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        z-index: 1000;
        animation: fadeInOut 3s ease-in-out;
      `;
      indicator.textContent = `📍 Connected: ${pkmSource || 'PKM'} → Task → ${projectId || 'Project'}`;
      document.body.appendChild(indicator);

      // Remove after animation
      setTimeout(() => {
        if (indicator.parentNode) {
          indicator.parentNode.removeChild(indicator);
        }
      }, 3000);
    }

    function clearAllHighlights() {
      // Clear task highlights
      document.querySelectorAll('.task-item').forEach(task => {
        task.style.background = 'rgba(255,255,255,0.02)';
        task.style.borderLeftColor = '';
      });

      // Clear PKM highlights
      document.querySelectorAll('[onclick*="highlightPKMSource"]').forEach(el => {
        el.style.background = '';
        el.style.borderLeft = '';
      });

      // Clear project highlights
      document.querySelectorAll('.project-hierarchy, .goal-hierarchy').forEach(project => {
        project.style.background = '';
        project.style.borderColor = '';
      });
    }

    // Project hierarchy management
    function toggleProjectDetails(projectId) {
      const details = document.getElementById(projectId + 'Details');
      if (details) {
        details.style.display = details.style.display === 'none' ? 'block' : 'none';
      }
    }

    function toggleGoalDetails(goalId) {
      const details = document.getElementById(goalId + 'Details');
      if (details) {
        details.style.display = details.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Realistic Project Data based on Current User
    function getRealisticProjects() {
      // Determine current user based on vault path
      const isAlex = currentVaultPath && currentVaultPath.includes('vault2');

      if (isAlex) {
        // Alex Projects: Business-focused professional
        return [
          {
            id: 'business-expansion',
            title: '🚀 Q2 Business Expansion',
            description: 'Regional market analysis and new office planning',
            progress: 65,
            tags: ['business', 'strategy', 'growth'],
            semanticConnections: ['business-operations', 'strategic-planning', 'market-research'],
            tasks: [
              { title: 'Complete market research', status: 'done', dueDate: '2024-01-15' },
              { title: 'Draft expansion proposal', status: 'active', dueDate: '2024-01-25' },
              { title: 'Schedule stakeholder meetings', status: 'pending', dueDate: '2024-02-01' }
            ]
          },
          {
            id: 'family-vacation',
            title: '🏖️ Summer Family Vacation',
            description: 'Planning comprehensive family trip to Europe',
            progress: 30,
            tags: ['family', 'travel', 'coordination'],
            semanticConnections: ['family-coordination', 'travel-planning', 'logistics'],
            tasks: [
              { title: 'Research destinations', status: 'done', dueDate: '2024-01-10' },
              { title: 'Book flights and hotels', status: 'active', dueDate: '2024-01-30' },
              { title: 'Plan daily itineraries', status: 'pending', dueDate: '2024-02-15' }
            ]
          },
          {
            id: 'volunteer-initiative',
            title: '🤝 Community Volunteer Program',
            description: 'Organizing quarterly community service events',
            progress: 45,
            tags: ['volunteer', 'community', 'leadership'],
            semanticConnections: ['volunteer-activities', 'community-service', 'event-planning'],
            tasks: [
              { title: 'Identify partner organizations', status: 'done', dueDate: '2024-01-05' },
              { title: 'Create volunteer schedule', status: 'active', dueDate: '2024-01-20' }
            ]
          }
        ];
      } else {
        // Margaret Projects: Research-focused academic
        return [
          {
            id: 'phd-research',
            title: '🎓 PhD Research Milestone',
            description: 'Complete dissertation chapter on systems thinking',
            progress: 75,
            tags: ['research', 'academic', 'systems-thinking'],
            semanticConnections: ['concept-systems-thinking', 'research-notes', 'academic-writing'],
            tasks: [
              { title: 'Literature review completion', status: 'done', dueDate: '2024-01-12' },
              { title: 'Draft methodology section', status: 'active', dueDate: '2024-01-28' },
              { title: 'Schedule advisor meeting', status: 'pending', dueDate: '2024-02-05' }
            ]
          },
          {
            id: 'family-health',
            title: '💪 Family Health & Wellness',
            description: 'Coordinate family health goals and activities',
            progress: 55,
            tags: ['family', 'health', 'wellness'],
            semanticConnections: ['health-tasks', 'family-tasks', 'wellness-planning'],
            tasks: [
              { title: 'Schedule annual check-ups', status: 'done', dueDate: '2024-01-08' },
              { title: 'Plan weekly meal prep', status: 'active', dueDate: '2024-01-22' },
              { title: 'Research fitness programs', status: 'active', dueDate: '2024-01-29' }
            ]
          },
          {
            id: 'travel-research',
            title: '✈️ Conference Travel Planning',
            description: 'Academic conference presentations and networking',
            progress: 40,
            tags: ['travel', 'academic', 'networking'],
            semanticConnections: ['travel-log', 'conference-planning', 'academic-networking'],
            tasks: [
              { title: 'Submit conference abstracts', status: 'done', dueDate: '2024-01-10' },
              { title: 'Book accommodations', status: 'active', dueDate: '2024-01-25' }
            ]
          }
        ];
      }
    }

    function populateRealisticProjects() {
      const projects = getRealisticProjects();
      const projectsContent = document.getElementById('projectsContent');
      const projectsCount = document.getElementById('projectsCount');

      if (!projectsContent || !projectsCount) return;

      projectsCount.textContent = projects.length;

      projectsContent.innerHTML = projects.map(project => `
        <div class="project-card" data-project-id="${project.id}"
             style="margin-bottom:12px;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:12px;cursor:pointer;background:rgba(255,255,255,0.02);"
             onclick="expandProject('${project.id}')">
          <div class="project-header">
            <div style="font-size:14px;font-weight:600;color:var(--accent);margin-bottom:4px;">${project.title}</div>
            <div style="font-size:11px;color:var(--muted);margin-bottom:8px;">${project.description}</div>

            <!-- Progress Bar -->
            <div style="background:#143046;height:4px;border-radius:2px;overflow:hidden;margin-bottom:8px;">
              <div style="background:var(--accent);height:100%;width:${project.progress}%;transition:width 0.3s ease;"></div>
            </div>

            <!-- Progress Text & Tags -->
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span style="font-size:10px;color:var(--muted);">${project.progress}% complete</span>
              <div class="project-tags" style="display:flex;gap:4px;">
                ${project.tags.slice(0, 2).map(tag => `
                  <span style="background:rgba(125,211,252,0.2);color:#7dd3fc;padding:2px 6px;border-radius:3px;font-size:9px;">${tag}</span>
                `).join('')}
              </div>
            </div>
          </div>

          <!-- Semantic Connections (hidden by default) -->
          <div class="semantic-connections" style="display:none;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1);">
            <div style="font-size:10px;color:#a3e635;margin-bottom:4px;">🔗 PKM Connections:</div>
            ${project.semanticConnections.map(conn => `
              <span class="semantic-tag" data-semantic="${conn}"
                    style="display:inline-block;background:rgba(163,230,53,0.2);color:#a3e635;padding:1px 4px;border-radius:2px;font-size:8px;margin-right:4px;cursor:pointer;"
                    onclick="event.stopPropagation(); highlightSemanticConnection('${conn}')">${conn}</span>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function populateRealisticTasks() {
      const projects = getRealisticProjects();
      const tasksContent = document.getElementById('tasksContent');
      const tasksCount = document.getElementById('tasksCount');

      if (!tasksContent || !tasksCount) return;

      // Flatten all tasks from projects
      const allTasks = projects.flatMap(project =>
        project.tasks.map(task => ({
          ...task,
          projectTitle: project.title,
          projectId: project.id,
          semanticConnections: project.semanticConnections
        }))
      );

      // Sort by status and due date
      const sortedTasks = allTasks.sort((a, b) => {
        const statusOrder = { 'active': 0, 'pending': 1, 'done': 2 };
        return statusOrder[a.status] - statusOrder[b.status];
      });

      tasksCount.textContent = sortedTasks.filter(t => t.status !== 'done').length;

      tasksContent.innerHTML = sortedTasks.slice(0, 6).map(task => {
        const statusColors = {
          'active': 'var(--accent)',
          'pending': '#fbbf24',
          'done': '#10b981'
        };

        const statusIcons = {
          'active': '🔄',
          'pending': '⏳',
          'done': '✅'
        };

        return `
          <div class="task-item clickable-task"
               data-project-id="${task.projectId}"
               data-task-status="${task.status}"
               style="padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;border-left:3px solid ${statusColors[task.status]};cursor:pointer;${task.status === 'done' ? 'opacity:0.6;' : ''}"
               onclick="stageTaskFromProject(this)">
            <div style="font-size:13px;font-weight:500;">${statusIcons[task.status]} ${task.title}</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px;">
              ${task.dueDate} • ${task.projectTitle.replace(/[^\w\s]/g, '').trim()}
            </div>
          </div>
        `;
      }).join('');
    }

    function populateActiveFocus() {
      const projects = getRealisticProjects();
      const activeItems = document.getElementById('activeWorkItems');

      if (!activeItems) return;

      // Show top 2 highest progress projects as current focus
      const focusProjects = projects
        .sort((a, b) => b.progress - a.progress)
        .slice(0, 2);

      activeItems.innerHTML = focusProjects.map(project => `
        <div class="focus-item" data-project-id="${project.id}"
             style="padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;border-left:3px solid var(--accent);cursor:pointer;"
             onclick="focusOnProject('${project.id}')">
          <div style="font-size:13px;font-weight:500;">${project.title}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">${project.progress}% complete • ${project.tasks.filter(t => t.status === 'active').length} active tasks</div>
        </div>
      `).join('');
    }

    // Interactive Functions
    function expandProject(projectId) {
      const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
      const connections = projectCard.querySelector('.semantic-connections');

      // Toggle semantic connections display
      if (connections.style.display === 'none') {
        connections.style.display = 'block';
        highlightProjectConnections(projectId);
      } else {
        connections.style.display = 'none';
        clearAllHighlights();
      }

      // Also stage the project in the staging area
      stageRealisticProject(projectId);
    }

    function stageRealisticProject(projectId) {
      const projects = getRealisticProjects();
      const project = projects.find(p => p.id === projectId);

      if (!project) return;

      const stagingTitle = document.getElementById('stagingTitle');
      const stagingContent = document.getElementById('stagingContent');

      if (!stagingTitle || !stagingContent) return;

      stagingTitle.textContent = '🚀 Project Management';

      stagingContent.innerHTML = `
        <div class="project-staging">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="color: #7dd3fc; margin: 0;">${project.title}</h3>
            <button onclick="editProject('${project.id}')"
                    style="background:var(--accent);color:#0a0e13;border:none;padding:6px 12px;border-radius:4px;font-size:11px;cursor:pointer;">
              ✏️ Edit
            </button>
          </div>

          <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 20px;">

            <!-- Project Description -->
            <div style="margin-bottom: 16px;">
              <label style="color: #94a3b8; font-size: 12px; display: block; margin-bottom: 4px;">Description</label>
              <div style="color: #e2e8f0; font-size: 14px; line-height: 1.4;">${project.description}</div>
            </div>

            <!-- Progress Bar -->
            <div style="margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="color: #94a3b8;">Overall Progress</span>
                <span style="color: #22c55e; font-weight: 600;">${project.progress}%</span>
              </div>
              <div style="background: #1e293b; height: 8px; border-radius: 4px; overflow: hidden;">
                <div style="background: #22c55e; height: 100%; width: ${project.progress}%; transition: width 0.3s ease;"></div>
              </div>
            </div>

            <!-- Tags -->
            <div style="margin-bottom: 16px;">
              <label style="color: #94a3b8; font-size: 12px; display: block; margin-bottom: 8px;">Tags</label>
              <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                ${project.tags.map(tag => `
                  <span style="background:rgba(125,211,252,0.2);color:#7dd3fc;padding:4px 8px;border-radius:4px;font-size:11px;">${tag}</span>
                `).join('')}
              </div>
            </div>

            <!-- Semantic Connections -->
            <div style="margin-bottom: 20px;">
              <label style="color: #94a3b8; font-size: 12px; display: block; margin-bottom: 8px;">🔗 PKM Connections</label>
              <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                ${project.semanticConnections.map(conn => `
                  <span class="semantic-connection-tag" data-semantic="${conn}"
                        style="background:rgba(163,230,53,0.2);color:#a3e635;padding:4px 8px;border-radius:4px;font-size:11px;cursor:pointer;"
                        onclick="highlightSemanticConnection('${conn}')">${conn}</span>
                `).join('')}
              </div>
            </div>
          </div>

          <!-- Tasks Section -->
          <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h4 style="color: #7dd3fc; margin: 0;">Project Tasks</h4>
              <button onclick="addTaskToProject('${project.id}')"
                      style="background:#143046;border:1px solid var(--accent);color:var(--accent);padding:4px 8px;border-radius:4px;font-size:10px;cursor:pointer;">
                + Add Task
              </button>
            </div>

            <div class="project-tasks">
              ${project.tasks.map((task, index) => {
        const statusColors = { 'active': 'var(--accent)', 'pending': '#fbbf24', 'done': '#10b981' };
        const statusIcons = { 'active': '🔄', 'pending': '⏳', 'done': '✅' };

        return `
                  <div class="task-item" data-task-index="${index}"
                       style="padding:10px;margin-bottom:8px;background:rgba(255,255,255,0.02);border-radius:6px;border-left:3px solid ${statusColors[task.status]};${task.status === 'done' ? 'opacity:0.7;' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                      <div>
                        <div style="font-size:13px;font-weight:500;color:white;">${statusIcons[task.status]} ${task.title}</div>
                        <div style="font-size:11px;color:var(--muted);margin-top:2px;">Due: ${task.dueDate}</div>
                      </div>
                      <div style="display:flex;gap:4px;">
                        <button onclick="toggleTaskStatus('${project.id}', ${index})"
                                style="background:none;border:1px solid ${statusColors[task.status]};color:${statusColors[task.status]};padding:2px 6px;border-radius:3px;font-size:9px;cursor:pointer;">
                          ${task.status}
                        </button>
                        <button onclick="editTask('${project.id}', ${index})"
                                style="background:none;border:1px solid #6b7280;color:#6b7280;padding:2px 6px;border-radius:3px;font-size:9px;cursor:pointer;">
                          ✏️
                        </button>
                      </div>
                    </div>
                  </div>
                `;
      }).join('')}
            </div>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button onclick="focusOnProject('${project.id}')"
                    style="flex:1;background:var(--accent);color:#0a0e13;border:none;padding:10px;border-radius:6px;font-weight:600;cursor:pointer;">
              🎯 Focus on This Project
            </button>
            <button onclick="exportProject('${project.id}')"
                    style="flex:1;background:#143046;border:1px solid var(--accent);color:var(--accent);padding:10px;border-radius:6px;font-weight:600;cursor:pointer;">
              📤 Export Project
            </button>
          </div>
        </div>
      `;

      // Highlight the semantic connections
      highlightProjectConnections(projectId);
    }

    function highlightSemanticConnection(connection) {
      // Highlight related elements in the PKM that match this semantic connection
      document.querySelectorAll(`[data-semantic*="${connection}"], [data-pkm-source*="${connection}"]`).forEach(el => {
        el.style.background = 'rgba(163,230,53,0.2)';
        el.style.borderLeft = '3px solid #a3e635';
      });

      // Show connection indicator
      showConnectionIndicator(`🔗 Highlighting PKM connections for: ${connection}`);
    }

    function highlightProjectConnections(projectId) {
      const projects = getRealisticProjects();
      const project = projects.find(p => p.id === projectId);

      if (project) {
        project.semanticConnections.forEach(conn => {
          setTimeout(() => highlightSemanticConnection(conn), 200);
        });
      }
    }

    function stageTaskFromProject(taskElement) {
      const projectId = taskElement.dataset.projectId;
      const status = taskElement.dataset.taskStatus;

      if (status === 'done') return; // Don't stage completed tasks

      // Stage the task with project context
      stageTask(taskElement);

      // Show the PKM connections for this project
      highlightProjectConnections(projectId);
    }

    function focusOnProject(projectId) {
      // Expand the project in the projects panel
      expandProject(projectId);

      // Filter tasks to show only this project's tasks
      const allTaskElements = document.querySelectorAll('.task-item');
      allTaskElements.forEach(task => {
        if (task.dataset.projectId === projectId) {
          task.style.display = 'block';
          task.style.background = 'rgba(125,211,252,0.1)';
        } else {
          task.style.opacity = '0.3';
        }
      });

      showConnectionIndicator(`🎯 Focused on project: ${projectId}`);
    }

    function createNewProject() {
      // ClickUp-style project creation
      const projectName = prompt('Enter project name:');
      if (!projectName) return;

      const projectDescription = prompt('Enter project description (optional):') || '';
      const projectTags = prompt('Enter tags (comma-separated):') || '';

      // Create new project object
      const newProject = {
        id: projectName.toLowerCase().replace(/\s+/g, '-'),
        title: `🚀 ${projectName}`,
        description: projectDescription,
        progress: 0,
        tags: projectTags.split(',').map(t => t.trim()).filter(t => t),
        semanticConnections: [],
        tasks: []
      };

      // Add to current projects and refresh
      // This would typically save to persistent storage
      showConnectionIndicator(`✅ Created new project: ${projectName}`);

      // Refresh the projects display
      setTimeout(() => {
        populateRealisticProjects();
      }, 1000);
    }

    function addTask() {
      const taskTitle = prompt('Enter task title:');
      if (!taskTitle) return;

      const dueDate = prompt('Enter due date (YYYY-MM-DD):') || new Date().toISOString().split('T')[0];

      showConnectionIndicator(`✅ Added new task: ${taskTitle}`);

      // Refresh tasks display
      setTimeout(() => {
        populateRealisticTasks();
      }, 1000);
    }

    function showConnectionIndicator(message) {
      const indicator = document.createElement('div');
      indicator.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(125,211,252,0.9);
        color: #012;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        z-index: 1000;
        animation: fadeInOut 3s ease-in-out;
      `;
      indicator.textContent = message;
      document.body.appendChild(indicator);

      setTimeout(() => {
        if (indicator.parentNode) {
          indicator.parentNode.removeChild(indicator);
        }
      }, 3000);
    }

    // Additional Project Management Functions
    function editProject(projectId) {
      const projects = getRealisticProjects();
      const project = projects.find(p => p.id === projectId);

      if (!project) return;

      const newTitle = prompt('Edit project title:', project.title.replace(/[^\w\s]/g, '').trim());
      if (!newTitle) return;

      const newDescription = prompt('Edit project description:', project.description);
      if (newDescription !== null) {
        showConnectionIndicator(`✅ Updated project: ${newTitle}`);
        // In a real app, this would save to storage and refresh
        setTimeout(() => stageRealisticProject(projectId), 500);
      }
    }

    function addTaskToProject(projectId) {
      const taskTitle = prompt('Enter new task title:');
      if (!taskTitle) return;

      const dueDate = prompt('Enter due date (YYYY-MM-DD):') || new Date().toISOString().split('T')[0];

      showConnectionIndicator(`✅ Added task to project: ${taskTitle}`);

      // In a real app, this would save the task and refresh
      setTimeout(() => {
        stageRealisticProject(projectId);
        populateRealisticTasks(); // Refresh tasks panel
      }, 500);
    }

    function toggleTaskStatus(projectId, taskIndex) {
      const statusCycle = { 'pending': 'active', 'active': 'done', 'done': 'pending' };

      showConnectionIndicator(`🔄 Task status updated`);

      // In a real app, this would update the task status and save
      setTimeout(() => {
        stageRealisticProject(projectId);
        populateRealisticTasks(); // Refresh tasks panel
      }, 500);
    }

    function editTask(projectId, taskIndex) {
      const projects = getRealisticProjects();
      const project = projects.find(p => p.id === projectId);

      if (!project || !project.tasks[taskIndex]) return;

      const task = project.tasks[taskIndex];
      const newTitle = prompt('Edit task title:', task.title);

      if (newTitle) {
        showConnectionIndicator(`✅ Updated task: ${newTitle}`);
        setTimeout(() => stageRealisticProject(projectId), 500);
      }
    }

    function exportProject(projectId) {
      const projects = getRealisticProjects();
      const project = projects.find(p => p.id === projectId);

      if (!project) return;

      const exportData = {
        ...project,
        exportedAt: new Date().toISOString(),
        exportedBy: currentVaultPath ? (currentVaultPath.includes('vault2') ? 'Alex' : 'Margaret') : 'User'
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${project.id}-export.json`;
      a.click();
      URL.revokeObjectURL(url);

      showConnectionIndicator(`📤 Exported project: ${project.title}`);
    }

    // Initialize PKM layout on page load
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        initializePKMLayout();
        // Populate realistic demo data
        populateRealisticProjects();
        populateRealisticTasks();
        populateActiveFocus();
      }, 100); // Small delay to ensure DOM is ready
    });

    // Initial render shows pkm-layout as primary interface

    // ===========================================
    // COMPACT PATHFINDING PANEL FUNCTIONS
    // ===========================================

    let miniAPIKeys = {
      openai: null,
      gemini: null
    };

    function togglePathfindingPanel() {
      const collapsed = document.getElementById('pathfinding-collapsed');
      const expanded = document.getElementById('pathfinding-expanded');
      const toggleBtn = document.getElementById('pathfinding-toggle');

      if (expanded.style.display === 'none') {
        collapsed.style.display = 'none';
        expanded.style.display = 'block';
        toggleBtn.textContent = 'Collapse';
      } else {
        collapsed.style.display = 'block';
        expanded.style.display = 'none';
        toggleBtn.textContent = 'Expand';
      }
    }

    function setupMiniAPI() {
      const openaiKey = document.getElementById('openai-key-mini').value.trim();
      const geminiKey = document.getElementById('gemini-key-mini').value.trim();

      if (openaiKey) {
        miniAPIKeys.openai = openaiKey;
        localStorage.setItem('openai_api_key', openaiKey);
        addMiniChatMessage('✅ OpenAI connected!');
        updateAIStatus(true);
      }

      if (geminiKey) {
        miniAPIKeys.gemini = geminiKey;
        localStorage.setItem('gemini_api_key', geminiKey);
        addMiniChatMessage('✅ Gemini connected!');
        updateAIStatus(true);
      }

      if (!openaiKey && !geminiKey) {
        addMiniChatMessage('⚠️ Please enter at least one API key.');
        return;
      }

      // Clear inputs for security
      document.getElementById('openai-key-mini').value = '';
      document.getElementById('gemini-key-mini').value = '';
    }

    function updateAIStatus(connected) {
      const statusIndicator = document.getElementById('ai-status-mini');
      if (connected) {
        statusIndicator.style.background = '#22c55e';
        statusIndicator.title = 'AI Connected';
      } else {
        statusIndicator.style.background = '#ef4444';
        statusIndicator.title = 'AI Disconnected';
      }
    }

    function addMiniChatMessage(message) {
      const messagesContainer = document.getElementById('chat-messages-mini');
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = 'font-size: 10px; margin-bottom: 4px; padding: 3px 5px; background: rgba(255,255,255,0.05); border-radius: 3px;';
      messageDiv.textContent = message;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Keep only last 5 messages to save space
      while (messagesContainer.children.length > 5) {
        messagesContainer.removeChild(messagesContainer.firstChild);
      }
    }

    async function sendMiniMessage() {
      const chatInput = document.getElementById('chat-input-mini');
      const message = chatInput.value.trim();

      if (!message) return;
      if (!miniAPIKeys.openai && !miniAPIKeys.gemini) {
        addMiniChatMessage('⚠️ Connect API keys first');
        return;
      }

      addMiniChatMessage('You: ' + message);
      chatInput.value = '';

      try {
        const goal = document.getElementById('quick-goal').value || 'No specific goal set';
        const context = `User goal: ${goal}. Question: ${message}`;

        const response = await callMiniAI(context);
        addMiniChatMessage('AI: ' + response);

      } catch (error) {
        console.error('AI API Error:', error);
        addMiniChatMessage('❌ AI error. Check keys.');
      }
    }

    async function callMiniAI(message) {
      if (miniAPIKeys.openai) {
        return await callMiniOpenAI(message);
      } else if (miniAPIKeys.gemini) {
        return await callMiniGemini(message);
      }
      throw new Error('No API keys available');
    }

    async function callMiniOpenAI(message) {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${miniAPIKeys.openai}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: 'gpt-3.5-turbo',
          messages: [
            { role: 'system', content: 'You are a concise pathfinding AI. Give brief, actionable advice for goal achievement in 1-2 sentences.' },
            { role: 'user', content: message }
          ],
          max_tokens: 100,
          temperature: 0.7
        })
      });

      if (!response.ok) throw new Error(`OpenAI API error: ${response.status}`);
      const data = await response.json();
      return data.choices[0]?.message?.content || 'No response';
    }

    async function callMiniGemini(message) {
      const prompt = `Pathfinding AI: Give brief advice for: ${message}`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${miniAPIKeys.gemini}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });

      if (!response.ok) throw new Error(`Gemini API error: ${response.status}`);
      const data = await response.json();
      return data.candidates[0]?.content?.parts[0]?.text || 'No response';
    }

    function generatePathfinding() {
      const goal = document.getElementById('quick-goal').value.trim();
      if (!goal) {
        addMiniChatMessage('⚠️ Enter a goal first');
        return;
      }

      addMiniChatMessage(`🧭 Generating paths for: ${goal}`);

      // Simulate pathfinding
      setTimeout(() => {
        addMiniChatMessage('✅ Found 4 routes: Speed (2 weeks), Safe (2 months), Learning (3 months), Creative (1 month)');
      }, 1500);
    }

    function openFullPathfinding() {
      const goal = document.getElementById('quick-goal').value.trim();
      const url = goal
        ? `pathfinding-compact.html?goal=${encodeURIComponent(goal)}`
        : 'pathfinding-compact.html';
      window.open(url, '_blank');
    }

    // Load stored API keys on page load
    function loadMiniAPIKeys() {
      const storedOpenAI = localStorage.getItem('openai_api_key');
      const storedGemini = localStorage.getItem('gemini_api_key');

      if (storedOpenAI) {
        miniAPIKeys.openai = storedOpenAI;
        updateAIStatus(true);
      }

      if (storedGemini) {
        miniAPIKeys.gemini = storedGemini;
        updateAIStatus(true);
      }
    }

    // Initialize mini pathfinding on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadMiniAPIKeys();

      // Set up enter key for chat
      const chatInput = document.getElementById('chat-input-mini');
      if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMiniMessage();
          }
        });
      }
    });

    // ===========================================
    // FULL-FEATURED PATHFINDING FUNCTIONS
    // ===========================================

    // Update slider values
    function updateSliderValues() {
      document.getElementById('skill-value').textContent = document.getElementById('skill-level').value + '%';
      document.getElementById('time-value').textContent = document.getElementById('time-available').value + '%';
      document.getElementById('risk-value').textContent = document.getElementById('risk-tolerance').value + '%';
    }

    // Load example goals
    function loadExampleGoal(type) {
      const examples = {
        business: {
          start: 'Small local business',
          goal: 'Scale to $1M annual revenue'
        },
        learning: {
          start: 'Beginner programmer',
          goal: 'Senior full-stack developer'
        },
        health: {
          start: 'Sedentary lifestyle',
          goal: 'Run a marathon'
        }
      };

      const example = examples[type];
      if (example) {
        document.getElementById('pathfind-start').value = example.start;
        document.getElementById('pathfind-goal').value = example.goal;
      }
    }

    // Generate full pathfinding analysis
    function generateFullPathfinding() {
      const start = document.getElementById('pathfind-start').value.trim();
      const goal = document.getElementById('pathfind-goal').value.trim();

      if (!start || !goal) {
        addAIChatMessage('⚠️ Please enter both starting point and target goal');
        return;
      }

      const skillLevel = document.getElementById('skill-level').value;
      const timeAvailable = document.getElementById('time-available').value;
      const riskTolerance = document.getElementById('risk-tolerance').value;

      addAIChatMessage(`🧭 Analyzing path from "${start}" to "${goal}"...`);

      // Update canvas visualization
      drawPathfindingVisualization(start, goal);

      // Generate route results
      setTimeout(() => {
        generateRouteResults(start, goal, skillLevel, timeAvailable, riskTolerance);
      }, 1500);
    }

    // Draw pathfinding visualization on canvas
    function drawPathfindingVisualization(start, goal) {
      const canvas = document.getElementById('pathfinding-canvas-main');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      // Clear canvas
      ctx.fillStyle = '#0a0e13';
      ctx.fillRect(0, 0, rect.width, rect.height);

      // Draw grid
      ctx.strokeStyle = 'rgba(255,255,255,0.1)';
      ctx.lineWidth = 1;
      for (let i = 0; i < rect.width; i += 40) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, rect.height);
        ctx.stroke();
      }
      for (let i = 0; i < rect.height; i += 30) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(rect.width, i);
        ctx.stroke();
      }

      // Draw start point
      ctx.fillStyle = '#22c55e';
      ctx.beginPath();
      ctx.arc(50, rect.height - 40, 8, 0, 2 * Math.PI);
      ctx.fill();

      // Draw end point
      ctx.fillStyle = '#ef4444';
      ctx.beginPath();
      ctx.arc(rect.width - 50, 40, 8, 0, 2 * Math.PI);
      ctx.fill();

      // Draw multiple paths
      const paths = [
        { color: '#FFD700', points: [[50, rect.height - 40], [150, rect.height - 80], [250, rect.height - 120], [rect.width - 50, 40]] },
        { color: '#3b82f6', points: [[50, rect.height - 40], [120, rect.height - 100], [200, rect.height - 60], [rect.width - 50, 40]] },
        { color: '#a855f7', points: [[50, rect.height - 40], [180, rect.height - 140], [280, rect.height - 80], [rect.width - 50, 40]] },
        { color: '#f97316', points: [[50, rect.height - 40], [160, rect.height - 60], [220, rect.height - 100], [rect.width - 50, 40]] }
      ];

      paths.forEach((path, index) => {
        ctx.strokeStyle = path.color;
        ctx.lineWidth = 3;
        ctx.setLineDash([]);
        if (index > 0) ctx.setLineDash([5, 5]);

        ctx.beginPath();
        ctx.moveTo(path.points[0][0], path.points[0][1]);
        for (let i = 1; i < path.points.length; i++) {
          ctx.lineTo(path.points[i][0], path.points[i][1]);
        }
        ctx.stroke();
      });

      // Add labels
      ctx.fillStyle = '#ffffff';
      ctx.font = '12px Inter';
      ctx.fillText('START', 25, rect.height - 15);
      ctx.fillText('GOAL', rect.width - 75, 25);
    }

    // Generate route results
    function generateRouteResults(start, goal, skill, time, risk) {
      const resultsContainer = document.getElementById('route-results-main');

      const routes = [
        {
          name: '⚡ Speed Route',
          color: '#FFD700',
          duration: '2-4 weeks',
          difficulty: 'High',
          steps: ['Intensive bootcamp', 'Daily practice (8h)', 'Mentor guidance', 'Portfolio sprint'],
          risks: 'Burnout, surface learning',
          success: '75%'
        },
        {
          name: '🛡️ Safe Route',
          color: '#3b82f6',
          duration: '3-6 months',
          difficulty: 'Medium',
          steps: ['Structured course', 'Weekly practice', 'Build projects', 'Network gradually'],
          risks: 'Slower progress, competition',
          success: '90%'
        },
        {
          name: '📚 Learning Route',
          color: '#a855f7',
          duration: '6-12 months',
          difficulty: 'Low',
          steps: ['Theory foundation', 'Multiple courses', 'Deep understanding', 'Research projects'],
          risks: 'Over-analysis, delay',
          success: '95%'
        },
        {
          name: '🎨 Creative Route',
          color: '#f97316',
          duration: '1-3 months',
          difficulty: 'Variable',
          steps: ['Unconventional methods', 'Side projects', 'Community building', 'Innovation focus'],
          risks: 'Unpredictable, isolation',
          success: '70%'
        }
      ];

      resultsContainer.innerHTML = routes.map(route => `
        <div style="margin-bottom: 12px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 4px solid ${route.color};">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <div style="font-size: 13px; font-weight: 600; color: ${route.color};">${route.name}</div>
            <div style="font-size: 10px; background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 6px; border-radius: 3px;">${route.success} success</div>
          </div>
          <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">
            <span style="color: var(--text);">Duration:</span> ${route.duration} |
            <span style="color: var(--text);">Difficulty:</span> ${route.difficulty}
          </div>
          <div style="font-size: 10px; margin-bottom: 6px;">
            <div style="color: #22c55e; margin-bottom: 3px;">✓ Steps:</div>
            <div style="color: var(--muted); margin-left: 10px;">${route.steps.join(' → ')}</div>
          </div>
          <div style="font-size: 10px;">
            <div style="color: #ef4444; margin-bottom: 3px;">⚠️ Risks:</div>
            <div style="color: var(--muted); margin-left: 10px;">${route.risks}</div>
          </div>
          <button onclick="selectRoute('${route.name}')"
            style="width: 100%; margin-top: 8px; background: rgba(${route.color === '#FFD700' ? '255,215,0' : route.color === '#3b82f6' ? '59,130,246' : route.color === '#a855f7' ? '168,85,247' : '249,115,22'},0.2); border: 1px solid ${route.color}; color: ${route.color}; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">
            Select This Route
          </button>
        </div>
      `).join('');

      addAIChatMessage('✅ Generated 4 optimal routes based on your context');
    }

    // Select a route
    function selectRoute(routeName) {
      addAIChatMessage(`🎯 Selected: ${routeName}. Ask me for detailed next steps!`);
    }

    // AI Chat functions for full system
    function addAIChatMessage(message, isUser = false) {
      const messagesContainer = document.getElementById('ai-chat-messages');
      if (!messagesContainer) return;

      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        padding: 8px;
        background: ${isUser ? 'rgba(255,215,0,0.1)' : 'rgba(59,130,246,0.1)'};
        border-radius: 6px;
        margin-bottom: 6px;
      `;

      messageDiv.innerHTML = `
        <div style="font-size: 10px; color: ${isUser ? '#FFD700' : '#3b82f6'}; font-weight: 600; margin-bottom: 2px;">
          ${isUser ? '👤 You' : '🤖 AI Assistant'}
        </div>
        <div style="font-size: 11px; line-height: 1.3;">
          ${message}
        </div>
      `;

      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function sendAIMessage() {
      const input = document.getElementById('ai-chat-input');
      const message = input.value.trim();
      if (!message) return;

      addAIChatMessage(message, true);
      input.value = '';

      // Simulate AI response
      setTimeout(() => {
        const responses = [
          "I can help you optimize that path! Consider focusing on the most critical skills first.",
          "Great question! The key is to balance speed with depth of understanding.",
          "Let me break that down into actionable steps you can start today.",
          "I see potential risks there. Here's how to mitigate them..."
        ];
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        addAIChatMessage(randomResponse);
      }, 1000);
    }

    function askAI(question) {
      addAIChatMessage(question, true);

      setTimeout(() => {
        let response = '';
        if (question.includes('optimize')) {
          response = "To optimize this path: 1) Focus on high-impact activities first, 2) Use the 80/20 rule, 3) Get feedback early and often, 4) Automate repetitive tasks.";
        } else if (question.includes('risks')) {
          response = "Main risks: 1) Scope creep - stay focused, 2) Knowledge gaps - identify early, 3) Motivation drops - build accountability, 4) Resource constraints - plan buffers.";
        } else if (question.includes('steps')) {
          response = "Breaking down your goal: 1) Define clear milestones, 2) Identify required skills, 3) Create weekly targets, 4) Build feedback loops, 5) Plan contingencies.";
        } else if (question.includes('creative')) {
          response = "Creative approaches: 1) Learn in public - blog your journey, 2) Find unusual mentors, 3) Create something unique, 4) Join niche communities, 5) Experiment fearlessly.";
        } else {
          response = "I can help you with route optimization, risk analysis, step-by-step planning, and creative approaches. What specific aspect interests you most?";
        }
        addAIChatMessage(response);
      }, 1500);
    }

    function showAPISetup() {
      addAIChatMessage("To connect AI: 1) Get API keys from OpenAI/Google, 2) Click 'Setup API' to save them securely, 3) Start chatting for personalized advice!");
    }

    function togglePathfindingSize() {
      const system = document.getElementById('pathfindingSystem');
      const content = document.getElementById('pathfinding-content');
      const button = document.getElementById('pathfinding-minimize');

      if (system.style.height === 'calc(55vh - 60px)') {
        system.style.height = '200px';
        content.style.display = 'none';
        button.textContent = 'Expand';
      } else {
        system.style.height = 'calc(55vh - 60px)';
        content.style.display = 'flex';
        button.textContent = 'Minimize';
      }
    }

    // Initialize sliders
    document.addEventListener('DOMContentLoaded', function () {
      ['skill-level', 'time-available', 'risk-tolerance'].forEach(id => {
        const slider = document.getElementById(id);
        if (slider) {
          slider.addEventListener('input', updateSliderValues);
        }
      });

      // Initialize canvas
      const canvas = document.getElementById('pathfinding-canvas-main');
      if (canvas) {
        // Draw initial empty state
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * window.devicePixelRatio;
        canvas.height = rect.height * window.devicePixelRatio;
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

        ctx.fillStyle = '#0a0e13';
        ctx.fillRect(0, 0, rect.width, rect.height);

        ctx.fillStyle = 'rgba(255,215,0,0.3)';
        ctx.font = '14px Inter';
        ctx.textAlign = 'center';
        ctx.fillText('🧭 Enter goals above to see route visualization', rect.width / 2, rect.height / 2);
      }

      // Set up chat input enter key
      const chatInput = document.getElementById('ai-chat-input');
      if (chatInput) {
        chatInput.addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            sendAIMessage();
          }
        });
      }
    });

    // ===========================================
    // END COMPACT PATHFINDING FUNCTIONS
    // ===========================================
  </script>
</body>

</html>
